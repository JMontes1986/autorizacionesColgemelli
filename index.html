<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta http-equiv="X-Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net https://mbosvnmhnbrslfwlfcxu.supabase.co; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<title>Sistema de Salidas - Colegio Gemelli</title>
<!-- Supabase CDN para GitHub -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 1200px;
            width: 95%;
            min-height: 80vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-status.connected {
            background: rgba(46, 204, 113, 0.2);
        }

        .connection-status.disconnected {
            background: rgba(231, 76, 60, 0.2);
        }

        .content {
            padding: 30px;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group label[for="gradeSelect"],
        .form-group label[for="studentSelect"],
        .form-group label[for="reasonSelect"],
        .form-group label[for="exitDate"],
        .form-group label[for="exitTime"] {
            color: #2c3e50;
            font-size: 16px;
        }

        .form-group select:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        #passwordNote {
            font-weight: normal;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #2ecc71;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .dashboard {
            display: none;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .section {
            display: none;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .table tbody tr:hover {
            background: #f5f5f5;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .verification-card {
            text-align: center;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .verification-card h3 {
            font-size: 1.4em;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .verification-card-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: left;
            margin: 20px 0;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .verification-card-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .verification-card-info p {
            margin: 0;
            font-size: 15px;
            line-height: 1.4;
        }

        .verification-card-info strong {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .verification-card-info .info-value {
            font-size: 16px;
            font-weight: 500;
        }

        .verification-card-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .verification-card-footer p {
            margin: 8px 0;
            font-size: 15px;
        }

        .verification-card-obs {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .verification-card-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .verification-card {
                padding: 20px;
            }
        }

        .verification-card.authorized {
            border-left-color: #2ecc71;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .verification-card.verified {
            border-left-color: #3498db;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .verification-card.not-authorized {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 18px;
            margin-bottom: 20px;
        }

        /* Estilos para la secci√≥n de seguridad */
        .security-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters-section .form-group {
            margin-bottom: 15px;
        }

        .log-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .log-type.login {
            background: #2ecc71;
            color: white;
        }

        .log-type.logout {
            background: #95a5a6;
            color: white;
        }

        .log-type.create {
            background: #3498db;
            color: white;
        }

        .log-type.update {
            background: #f39c12;
            color: white;
        }

        .log-type.delete {
            background: #e74c3c;
            color: white;
        }

        .log-type.error {
            background: #c0392b;
            color: white;
        }

        /* Estilos para rate limiting */
        .rate-limit-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            z-index: 9999;
        }

        /* Password strength indicator */
        .password-strength {
            margin-top: 5px;
            height: 5px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .password-strength.weak {
            background: #e74c3c;
            width: 33%;
        }

        .password-strength.medium {
            background: #f39c12;
            width: 66%;
        }

        .password-strength.strong {
            background: #2ecc71;
            width: 100%;
        }

        @media (max-width: 768px) {
            .container {
                width: 100%;
                margin: 10px;
                border-radius: 10px;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üè´ Colegio Gemelli</h1>
<div class="subtitle">Sistema de Control de Salidas Estudiantiles</div>
<div class="connection-status" id="connectionStatus">
<span id="connectionIcon">üî¥</span>
<span id="connectionText">Verificando conexi√≥n...</span>
</div>
<button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
</div>
<div class="content">
<!-- Rate Limit Warning -->
<div class="rate-limit-warning" id="rateLimitWarning">
‚ö†Ô∏è Demasiados intentos. Por favor espera antes de intentar de nuevo.
</div>
<!-- Login Form -->
<div class="login-form" id="loginSection">
<div class="form-group">
<label for="email">Email:</label>
<input id="email" placeholder="sistemas@colgemelli.edu.co" type="email" maxlength="100" autocomplete="username"/>
</div>
<div class="form-group">
<label for="password">Contrase√±a:</label>
<input id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password" maxlength="50" autocomplete="current-password"/>
<div class="password-strength" id="passwordStrength" style="display: none;"></div>
</div>
<button class="btn" onclick="login()" id="loginBtn" style="width: 100%;">Iniciar Sesi√≥n</button>
<button class="btn btn-secondary" onclick="testConnection()" style="width: 100%; margin-top: 10px;">üîÑ Probar Conexi√≥n</button>
<div class="alert alert-error" id="loginError" style="display: none; margin-top: 15px;"></div>
<div class="alert alert-success" id="loginInfo" style="display: none; margin-top: 15px;"></div>
</div>
<!-- Dashboard -->
<div class="dashboard" id="dashboard">
<div class="nav-buttons" id="navButtons">
<!-- Botones se cargar√°n din√°micamente seg√∫n el rol -->
</div>
<!-- Secci√≥n para Autorizar Salidas -->
<div class="section" id="authorizeSectionDiv">
<h2>‚úÖ Autorizar Salida de Estudiante</h2>
<form id="authorizeForm">
<div class="grid">
<div class="form-group">
<label for="gradeSelect">1. Seleccionar Grado: *</label>
<select id="gradeSelect" onchange="loadStudentsByGrade()" required="">
<option value="">Seleccionar grado primero...</option>
</select>
</div>
<div class="form-group">
<label for="studentSelect">2. Seleccionar Estudiante: *</label>
<select disabled="" id="studentSelect" required="">
<option value="">Primero selecciona un grado...</option>
</select>
</div>
<div class="form-group">
<label for="reasonSelect">3. Motivo: *</label>
<select id="reasonSelect" required="">
<option value="">Seleccionar motivo...</option>
</select>
</div>
<div class="form-group">
<label for="exitDate">4. Fecha de Salida: *</label>
<input id="exitDate" required="" type="date"/>
</div>
<div class="form-group">
<label for="exitTime">5. Hora de Salida: *</label>
<input id="exitTime" required="" type="time"/>
</div>
</div>
<div class="form-group">
<label for="observations">Observaciones adicionales:</label>
<textarea id="observations" placeholder="Observaciones opcionales sobre la salida..." rows="3" maxlength="500"></textarea>
</div>
<button class="btn btn-success" style="font-size: 18px; padding: 15px 30px;" type="submit">‚úÖ Autorizar Salida</button>
</form>
</div>
<!-- Secci√≥n para Verificar Salidas (Vigilante) - NUEVA Y MEJORADA -->
<div class="section" id="verifySectionDiv">
<h2>üîç Control de Salidas - Vigilancia</h2>
<div class="nav-buttons">
<button class="btn btn-success" onclick="loadPendingExits()">üîÑ Actualizar Lista</button>
<button class="btn btn-secondary" onclick="toggleSearch()">üîç Buscar Estudiante</button>
</div>
<!-- B√∫squeda manual (inicialmente oculta) -->
<div id="searchSection" style="display: none; margin-top: 20px;">
<h3 style="color: #2c3e50; margin-bottom: 15px;">üîç B√∫squeda Manual de Estudiante</h3>
<input class="search-box" id="studentSearch" placeholder="Buscar estudiante espec√≠fico por nombre..." type="text" maxlength="100"/>
<div id="searchResult"></div>
</div>
<!-- Lista de estudiantes con salidas pendientes -->
<div id="pendingExitsSection">
<h3 style="color: #2c3e50; margin: 20px 0 15px 0;">üìã Estudiantes con Salidas Pendientes para Hoy</h3>
<div id="pendingExitsList">
<div class="card" style="text-align: center; padding: 30px;">
<p style="color: #666;">Cargando estudiantes con salidas pendientes...</p>
</div>
</div>
</div>
</div>
<!-- Secci√≥n de Administraci√≥n -->
<div class="section" id="adminSectionDiv">
<h2>‚öôÔ∏è Panel de Administraci√≥n</h2>
<div class="nav-buttons">
<button class="btn" onclick="showAdminSection('students')">Gestionar Estudiantes</button>
<button class="btn" onclick="showAdminSection('users')">Gestionar Usuarios</button>
<button class="btn" onclick="showAdminSection('reasons')">Gestionar Motivos</button>
<button class="btn" onclick="showAdminSection('grades')">Gestionar Grados</button>
<button class="btn btn-warning" onclick="showAdminSection('security')">üîí Seguridad y Logs</button>
</div>
<div class="admin-subsection" id="adminStudents" style="display: none;">
<h3>üë®‚Äçüéì Gesti√≥n de Estudiantes</h3>
<button class="btn btn-success" onclick="openModal('studentModal')">Agregar Estudiante</button>
<table class="table" id="studentsTable">
<thead>
<tr>
<th>Nombre</th>
<th>Apellidos</th>
<th>Documento</th>
<th>Grado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="admin-subsection" id="adminUsers" style="display: none;">
<h3>üë• Gesti√≥n de Usuarios</h3>
<button class="btn btn-success" onclick="openModal('userModal')">Agregar Usuario</button>
<table class="table" id="usersTable">
<thead>
<tr>
<th>Nombre</th>
<th>Email</th>
<th>Rol</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="admin-subsection" id="adminReasons" style="display: none;">
<h3>üìù Gesti√≥n de Motivos</h3>
<button class="btn btn-success" onclick="openModal('reasonModal')">Agregar Motivo</button>
<table class="table" id="reasonsTable">
<thead>
<tr>
<th>Nombre</th>
<th>Descripci√≥n</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="admin-subsection" id="adminGrades" style="display: none;">
<h3>üéì Gesti√≥n de Grados</h3>
<button class="btn btn-success" onclick="openModal('gradeModal')">Agregar Grado</button>
<table class="table" id="gradesTable">
<thead>
<tr>
<th>Nombre</th>
<th>Nivel</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<!-- Nueva secci√≥n de Seguridad -->
<div class="admin-subsection" id="adminSecurity" style="display: none;">
<h3>üîí Seguridad y Logs de Auditor√≠a</h3>
<div class="security-stats">
<div class="stat-card">
<h4>Accesos Hoy</h4>
<div class="number" id="todayLogins">0</div>
</div>
<div class="stat-card">
<h4>Cambios Hoy</h4>
<div class="number" id="todayChanges">0</div>
</div>
<div class="stat-card">
<h4>Intentos Fallidos</h4>
<div class="number" id="failedAttempts">0</div>
</div>
<div class="stat-card">
<h4>Usuarios Activos</h4>
<div class="number" id="activeUsers">0</div>
</div>
</div>
<div class="filters-section">
<h4>Filtros de Logs</h4>
<div class="grid">
<div class="form-group">
<label for="logDateFrom">Fecha Desde:</label>
<input type="date" id="logDateFrom" />
</div>
<div class="form-group">
<label for="logDateTo">Fecha Hasta:</label>
<input type="date" id="logDateTo" />
</div>
<div class="form-group">
<label for="logType">Tipo de Acci√≥n:</label>
<select id="logType">
<option value="">Todos</option>
<option value="login">Inicio de Sesi√≥n</option>
<option value="logout">Cierre de Sesi√≥n</option>
<option value="create">Creaci√≥n</option>
<option value="update">Actualizaci√≥n</option>
<option value="delete">Eliminaci√≥n</option>
<option value="error">Error</option>
</select>
</div>
<div class="form-group">
<label for="logUser">Usuario:</label>
<select id="logUser">
<option value="">Todos</option>
</select>
</div>
</div>
<button class="btn" onclick="loadSecurityLogs()">üîç Buscar Logs</button>
<button class="btn btn-secondary" onclick="exportLogs()">üì• Exportar Logs</button>
</div>
<table class="table" id="securityLogsTable">
<thead>
<tr>
<th>Fecha/Hora</th>
<th>Usuario</th>
<th>Tipo</th>
<th>Acci√≥n</th>
<th>Detalles</th>
<th>IP</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<!-- Secci√≥n de Historial -->
<div class="section" id="historySectionDiv">
<h2>üìã Historial de Autorizaciones</h2>
<div class="form-group">
<input id="historyDate" onchange="loadHistory()" type="date"/>
<button class="btn" onclick="loadHistory()">Filtrar por Fecha</button>
<button class="btn btn-secondary" onclick="loadHistory(true)">Ver Todo el Historial</button>
<button class="btn" onclick="debugHistory()" style="background: #e67e22;">üîç Debug Historial</button>
</div>
<div id="historyDebug" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
<h4>üîß Informaci√≥n de Debug:</h4>
<div id="historyDebugContent"></div>
</div>
<table class="table" id="historyTable">
<thead>
<tr>
<th>Estudiante</th>
<th>Grado</th>
<th>Motivo</th>
<th>Fecha Salida</th>
<th>Hora Salida</th>
<th>Autorizado por</th>
<th>Estado</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</div>
<!-- Modals -->
<div class="modal" id="studentModal">
<div class="modal-content">
<span class="close" onclick="closeModal('studentModal')">√ó</span>
<h2>Agregar/Editar Estudiante</h2>
<form id="studentForm">
<div class="form-group">
<label>Nombre: *</label>
<input id="studentName" required="" type="text" maxlength="50" pattern="[A-Za-z√Ä-√ø\s]{2,50}"/>
</div>
<div class="form-group">
<label>Apellidos: *</label>
<input id="studentLastName" required="" type="text" maxlength="50" pattern="[A-Za-z√Ä-√ø\s]{2,50}"/>
</div>
<div class="form-group">
<label>Documento:</label>
<input id="studentDocument" type="text" maxlength="20" pattern="[0-9]{6,20}"/>
</div>
<div class="form-group">
<label>Grado: *</label>
<select id="studentGrade" required="">
<option value="">Seleccionar grado...</option>
</select>
</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('studentModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<div class="modal" id="userModal">
<div class="modal-content">
<span class="close" onclick="closeModal('userModal')">√ó</span>
<h2>Agregar/Editar Usuario</h2>
<form id="userForm">
<div class="form-group">
<label>Nombre: *</label>
<input id="userName" required="" type="text" maxlength="50" pattern="[A-Za-z√Ä-√ø\s]{2,50}"/>
</div>
<div class="form-group">
<label>Email: *</label>
<input id="userEmail" required="" type="email" maxlength="100"/>
</div>
<div class="form-group">
<label>Contrase√±a: <span id="passwordNote">(dejar vac√≠o para mantener actual)</span></label>
<input id="userPassword" type="password" maxlength="50" onkeyup="checkPasswordStrength()"/>
<div class="password-strength" id="userPasswordStrength" style="display: none;"></div>
</div>
<div class="form-group">
<label>Rol: *</label>
<select id="userRole" required="">
<option value="">Seleccionar rol...</option>
</select>
</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('userModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<div class="modal" id="reasonModal">
<div class="modal-content">
<span class="close" onclick="closeModal('reasonModal')">√ó</span>
<h2>Agregar/Editar Motivo</h2>
<form id="reasonForm">
<div class="form-group">
<label>Nombre: *</label>
<input id="reasonName" required="" type="text" maxlength="50"/>
</div>
<div class="form-group">
<label>Descripci√≥n:</label>
<textarea id="reasonDescription" rows="3" maxlength="200"></textarea>
</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('reasonModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<div class="modal" id="gradeModal">
<div class="modal-content">
<span class="close" onclick="closeModal('gradeModal')">√ó</span>
<h2>Agregar/Editar Grado</h2>
<form id="gradeForm">
<div class="form-group">
<label>Nombre: *</label>
<input id="gradeName" required="" type="text" maxlength="20"/>
</div>
<div class="form-group">
<label>Nivel: *</label>
<select id="gradeLevel" required="">
<option value="">Seleccionar nivel...</option>
<option value="Primaria">Primaria</option>
<option value="Bachillerato">Bachillerato</option>
</select>
</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('gradeModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://mbosvnmhnbrslfwlfcxu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ib3N2bm1obmJyc2xmd2xmY3h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1ODU2MzUsImV4cCI6MjA2NTE2MTYzNX0.evgs5gWsCRyfeo273tLiAAoIdB-IjMaPq8U23xK4lqc';
        
        let supabase;
        let currentUser = null;
        let currentEditingId = null;
        let sessionToken = null;
        let loginAttempts = 0;
        let lastLoginAttempt = null;

        // Rate limiting configuration
        const MAX_LOGIN_ATTEMPTS = 5;
        const LOGIN_COOLDOWN = 300000; // 5 minutos en milisegundos

        // Funciones de seguridad
        function sanitizeHtml(str) {
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email) && email.length <= 100;
        }

        function validatePassword(password) {
            return password.length >= 8 && password.length <= 50;
        }

        function checkPasswordStrength() {
            const password = document.getElementById('userPassword').value;
            const strengthDiv = document.getElementById('userPasswordStrength');
            
            if (!password) {
                strengthDiv.style.display = 'none';
                return;
            }
            
            strengthDiv.style.display = 'block';
            
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]+/)) strength++;
            if (password.match(/[A-Z]+/)) strength++;
            if (password.match(/[0-9]+/)) strength++;
            if (password.match(/[^a-zA-Z0-9]+/)) strength++;
            
            strengthDiv.className = 'password-strength';
            if (strength < 3) {
                strengthDiv.classList.add('weak');
            } else if (strength < 4) {
                strengthDiv.classList.add('medium');
            } else {
                strengthDiv.classList.add('strong');
            }
        }

        function generateSessionToken() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function checkRateLimit() {
            const now = Date.now();
            if (lastLoginAttempt && loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                if (now - lastLoginAttempt < LOGIN_COOLDOWN) {
                    const remainingTime = Math.ceil((LOGIN_COOLDOWN - (now - lastLoginAttempt)) / 1000);
                    showRateLimitWarning(remainingTime);
                    return false;
                } else {
                    loginAttempts = 0;
                }
            }
            return true;
        }

        function showRateLimitWarning(seconds) {
            const warning = document.getElementById('rateLimitWarning');
            warning.textContent = `‚ö†Ô∏è Demasiados intentos. Espera ${seconds} segundos antes de intentar de nuevo.`;
            warning.style.display = 'block';
            setTimeout(() => {
                warning.style.display = 'none';
            }, 5000);
        }

        async function logSecurityEvent(type, action, details = {}, success = true) {
            try {
                // Obtener informaci√≥n del navegador
                const userAgent = navigator.userAgent;
                const ip = 'Cliente'; // En producci√≥n, obtener desde el servidor
                
                await supabase
                    .from('audit_logs')
                    .insert([{
                        usuario_id: currentUser?.id || null,
                        tipo: type,
                        accion: action,
                        detalles: JSON.stringify(details),
                        ip_address: ip,
                        user_agent: userAgent,
                        exitoso: success,
                        timestamp: new Date().toISOString()
                    }]);
            } catch (error) {
                console.error('Error al registrar evento de seguridad:', error);
            }
        }

        // Inicializar Supabase
        async function initSupabase() {
            try {
                console.log('üîÑ Inicializando Supabase...');
                
                if (!window.supabase) {
                    console.error('‚ùå window.supabase no est√° disponible');
                    throw new Error('Supabase no est√° cargado');
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Cliente Supabase creado');
                
                // Verificar conexi√≥n
                const { data, error } = await supabase.from('roles').select('*').limit(1);
                
                if (error) throw error;
                
                updateConnectionStatus(true, 'Conectado');
                console.log('‚úÖ Conexi√≥n exitosa');
                
                // Crear tabla de logs si no existe
                await createAuditLogsTable();
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                updateConnectionStatus(false, 'Error de conexi√≥n');
                return false;
            }
        }

        async function createAuditLogsTable() {
            // Esta funci√≥n normalmente se ejecutar√≠a en el backend
            // Por ahora, asumimos que la tabla ya existe
            console.log('üìä Verificando tabla de audit_logs...');
        }

        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(connected, message) {
            const statusElement = document.getElementById('connectionStatus');
            const iconElement = document.getElementById('connectionIcon');
            const textElement = document.getElementById('connectionText');
            
            if (connected) {
                statusElement.className = 'connection-status connected';
                iconElement.textContent = 'üü¢';
                textElement.textContent = message || 'Conectado';
            } else {
                statusElement.className = 'connection-status disconnected';
                iconElement.textContent = 'üî¥';
                textElement.textContent = message || 'Desconectado';
            }
        }

        // Funciones de utilidad
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const infoDiv = document.getElementById('loginInfo');
            if (infoDiv) {
                infoDiv.textContent = message;
                infoDiv.style.display = 'block';
                setTimeout(() => {
                    infoDiv.style.display = 'none';
                }, 5000);
            } else {
                alert('‚úÖ ' + message);
            }
        }

        // Funci√≥n para probar conexi√≥n
        async function testConnection() {
            updateConnectionStatus(false, 'Probando...');
            
            try {
                console.log('üîÑ Test de conexi√≥n');
                console.log('window.supabase:', !!window.supabase);
                
                if (!window.supabase) {
                    throw new Error('Supabase no est√° cargado. Recarga la p√°gina.');
                }
                
                const connected = await initSupabase();
                
                if (connected) {
                    showSuccess('‚úÖ Conexi√≥n exitosa!');
                } else {
                    showError('‚ùå Error en la conexi√≥n');
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                showError('Error: ' + error.message);
            }
        }

        // Funciones de utilidad para zona horaria de Colombia
        function getColombiaDate() {
            return new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Bogota' });
        }

        function getColombiaDateTime() {
            return new Date().toLocaleString('sv-SE', { timeZone: 'America/Bogota' }).replace(' ', 'T');
        }

        function getColombiaTime() {
            return new Date().toLocaleTimeString('sv-SE', { timeZone: 'America/Bogota', hour12: false }).substring(0, 5);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00-05:00'); // Forzar zona horaria Colombia
            return date.toLocaleDateString('es-CO', { 
                timeZone: 'America/Bogota',
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
        }

        function formatTime(timeString) {
            if (!timeString) return 'N/A';
            return timeString.substring(0, 5);
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = new Date(dateTimeString);
            return date.toLocaleString('es-CO', { 
                timeZone: 'America/Bogota',
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Funciones de autenticaci√≥n con mejoras de seguridad
        async function login() {
            // Check rate limiting
            if (!checkRateLimit()) {
                return;
            }

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            // Validaciones b√°sicas
            if (!email || !password) {
                showError('Por favor, ingresa email y contrase√±a');
                return;
            }

            // Validar formato de email
            if (!validateEmail(email)) {
                showError('Formato de email inv√°lido');
                loginAttempts++;
                lastLoginAttempt = Date.now();
                await logSecurityEvent('login', 'Intento de login con email inv√°lido', { email }, false);
                return;
            }

            // Deshabilitar bot√≥n de login
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Verificando...';

            // Verificar conexi√≥n primero
            const connected = await initSupabase();
            if (!connected) {
                showError('No se puede conectar a la base de datos. Verifica tu conexi√≥n a internet.');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
                return;
            }

            try {
                console.log('Intentando login con:', email);
                
                // Buscar usuario en la base de datos
                const { data: user, error } = await supabase
                    .from('usuarios')
                    .select(`
                        *,
                        rol:roles(nombre, descripcion)
                    `)
                    .eq('email', email)
                    .eq('activo', true)
                    .single();

                console.log('Resultado de b√∫squeda:', { user, error });

                if (error) {
                    console.error('Error en consulta:', error);
                    loginAttempts++;
                    lastLoginAttempt = Date.now();
                    
                    if (error.code === 'PGRST116') {
                        await logSecurityEvent('login', 'Intento de login con usuario no encontrado', { email }, false);
                        showError('Usuario no encontrado. Verifica tu email.');
                    } else {
                        showError('Error al buscar usuario: ' + error.message);
                    }
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesi√≥n';
                    return;
                }

                if (!user) {
                    loginAttempts++;
                    lastLoginAttempt = Date.now();
                    await logSecurityEvent('login', 'Intento de login con usuario inactivo', { email }, false);
                    showError('Usuario no encontrado o inactivo');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesi√≥n';
                    return;
                }

                console.log('Usuario encontrado:', user.nombre);

                // Verificar contrase√±a (en producci√≥n deber√≠a ser con hash)
                // TODO: Implementar bcrypt o similar
                if (user.password_hash !== password) {
                    loginAttempts++;
                    lastLoginAttempt = Date.now();
                    await logSecurityEvent('login', 'Intento de login con contrase√±a incorrecta', { email, userId: user.id }, false);
                    showError('Contrase√±a incorrecta');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesi√≥n';
                    return;
                }

                console.log('Login exitoso para:', user.nombre);
                
                // Generar token de sesi√≥n
                sessionToken = generateSessionToken();
                
                // Resetear intentos de login
                loginAttempts = 0;
                lastLoginAttempt = null;
                
                currentUser = user;
                
                // Registrar login exitoso
                await logSecurityEvent('login', 'Login exitoso', { 
                    userId: user.id, 
                    email: user.email,
                    role: user.rol.nombre 
                }, true);
                
                showDashboard();
                
            } catch (error) {
                console.error('Error general en login:', error);
                await logSecurityEvent('error', 'Error general en login', { error: error.message }, false);
                showError('Error al iniciar sesi√≥n: ' + error.message);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
            }
        }

        async function logout() {
            if (currentUser) {
                await logSecurityEvent('logout', 'Cierre de sesi√≥n', { userId: currentUser.id }, true);
            }
            
            currentUser = null;
            sessionToken = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.querySelector('.logout-btn').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.querySelector('.logout-btn').style.display = 'block';
            
            setupNavigation();
            loadInitialData();
        }

        function setupNavigation() {
            const navButtons = document.getElementById('navButtons');
            const role = currentUser.rol.nombre;
            
            navButtons.innerHTML = '';

            // Botones seg√∫n el rol
            if (role === 'administrador') {
                navButtons.innerHTML = `
                    <button class="btn" onclick="showSection('authorizeSectionDiv')">Autorizar Salidas</button>
                    <button class="btn" onclick="showSection('adminSectionDiv')">Administraci√≥n</button>
                    <button class="btn" onclick="showSection('historySectionDiv')">Historial</button>
                    <button class="btn" onclick="showSection('verifySectionDiv')">Verificar Salidas</button>
                `;
            } else if (role === 'vigilante') {
                navButtons.innerHTML = `
                    <button class="btn" onclick="showSection('verifySectionDiv')">Control de Salidas</button>
                    <button class="btn" onclick="showSection('historySectionDiv')">Historial</button>
                `;
            } else {
                navButtons.innerHTML = `
                    <button class="btn" onclick="showSection('authorizeSectionDiv')">Autorizar Salidas</button>
                    <button class="btn" onclick="showSection('historySectionDiv')">Historial</button>
                `;
            }

            // Mostrar la primera secci√≥n disponible
            if (role === 'vigilante') {
                showSection('verifySectionDiv');
            } else {
                showSection('authorizeSectionDiv');
            }
        }

        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(sectionId).classList.add('active');
            
            // Cargar datos espec√≠ficos seg√∫n la secci√≥n
            if (sectionId === 'historySectionDiv') {
                loadHistory(true); // Cargar todo el historial por defecto
            } else if (sectionId === 'verifySectionDiv' && currentUser && currentUser.rol.nombre === 'vigilante') {
                // Cargar autom√°ticamente las salidas pendientes para vigilantes
                loadPendingExits();
            }
        }

        async function loadInitialData() {
            await loadStudents();
            await loadReasons();
            await loadGrades();
            await loadRoles();
            
            if (currentUser.rol.nombre === 'administrador') {
                await loadUsers();
                await loadSecurityStats();
            }
            
            setupEventListeners();
        }

        function setupEventListeners() {
            // Autorizaci√≥n de salidas
            document.getElementById('authorizeForm').addEventListener('submit', authorizeExit);
            
            // B√∫squeda de estudiantes para verificaci√≥n (solo si existe el elemento)
            const studentSearchInput = document.getElementById('studentSearch');
            if (studentSearchInput) {
                studentSearchInput.addEventListener('input', searchStudent);
            }
            
            // Formularios de administraci√≥n
            document.getElementById('studentForm').addEventListener('submit', saveStudent);
            document.getElementById('userForm').addEventListener('submit', saveUser);
            document.getElementById('reasonForm').addEventListener('submit', saveReason);
            document.getElementById('gradeForm').addEventListener('submit', saveGrade);

            // Establecer fecha actual de Colombia por defecto
            const todayColombia = getColombiaDate();
            document.getElementById('exitDate').value = todayColombia;
            document.getElementById('historyDate').value = todayColombia;
            document.getElementById('logDateFrom').value = todayColombia;
            document.getElementById('logDateTo').value = todayColombia;
            
            console.log('üìÖ Fecha actual Colombia establecida:', todayColombia);
        }

        // NUEVAS FUNCIONES DE SEGURIDAD
        async function loadSecurityStats() {
            try {
                const todayColombia = getColombiaDate();
                
                // Cargar estad√≠sticas del d√≠a
                const { data: todayLogs, error: logsError } = await supabase
                    .from('audit_logs')
                    .select('*')
                    .gte('timestamp', todayColombia + 'T00:00:00')
                    .lte('timestamp', todayColombia + 'T23:59:59');

                if (!logsError && todayLogs) {
                    const loginCount = todayLogs.filter(log => log.tipo === 'login' && log.exitoso).length;
                    const changeCount = todayLogs.filter(log => ['create', 'update', 'delete'].includes(log.tipo)).length;
                    const failedCount = todayLogs.filter(log => !log.exitoso).length;
                    
                    document.getElementById('todayLogins').textContent = loginCount;
                    document.getElementById('todayChanges').textContent = changeCount;
                    document.getElementById('failedAttempts').textContent = failedCount;
                }

                // Cargar usuarios activos
                const { data: activeUsers, error: usersError } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('activo', true);

                if (!usersError && activeUsers) {
                    document.getElementById('activeUsers').textContent = activeUsers.length;
                }

                // Cargar lista de usuarios para el filtro
                const logUserSelect = document.getElementById('logUser');
                if (activeUsers && logUserSelect) {
                    logUserSelect.innerHTML = '<option value="">Todos</option>';
                    activeUsers.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.nombre;
                        logUserSelect.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Error al cargar estad√≠sticas de seguridad:', error);
            }
        }

        async function loadSecurityLogs() {
            try {
                const dateFrom = document.getElementById('logDateFrom').value;
                const dateTo = document.getElementById('logDateTo').value;
                const logType = document.getElementById('logType').value;
                const logUser = document.getElementById('logUser').value;

                let query = supabase
                    .from('audit_logs')
                    .select(`
                        *,
                        usuario:usuarios(nombre, email)
                    `)
                    .order('timestamp', { ascending: false })
                    .limit(100);

                if (dateFrom) {
                    query = query.gte('timestamp', dateFrom + 'T00:00:00');
                }
                if (dateTo) {
                    query = query.lte('timestamp', dateTo + 'T23:59:59');
                }
                if (logType) {
                    query = query.eq('tipo', logType);
                }
                if (logUser) {
                    query = query.eq('usuario_id', logUser);
                }

                const { data: logs, error } = await query;

                if (error) {
                    console.error('Error al cargar logs:', error);
                    showError('Error al cargar los logs de seguridad');
                    return;
                }

                const tbody = document.querySelector('#securityLogsTable tbody');
                tbody.innerHTML = '';

                if (!logs || logs.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #666; padding: 20px;">
                                No se encontraron logs para los filtros seleccionados
                            </td>
                        </tr>
                    `;
                    return;
                }

                logs.forEach(log => {
                    const row = tbody.insertRow();
                    const typeClass = getLogTypeClass(log.tipo);
                    const details = log.detalles ? JSON.parse(log.detalles) : {};
                    
                    row.innerHTML = `
                        <td>${formatDateTime(log.timestamp)}</td>
                        <td>${log.usuario ? sanitizeHtml(log.usuario.nombre) : 'Sistema'}</td>
                        <td><span class="log-type ${typeClass}">${sanitizeHtml(log.tipo)}</span></td>
                        <td>${sanitizeHtml(log.accion)}</td>
                        <td>${sanitizeHtml(JSON.stringify(details))}</td>
                        <td>${sanitizeHtml(log.ip_address || 'N/A')}</td>
                    `;
                });

                showSuccess(`Se cargaron ${logs.length} registros de logs`);
                
            } catch (error) {
                console.error('Error general al cargar logs:', error);
                showError('Error al cargar los logs de seguridad');
            }
        }

        function getLogTypeClass(type) {
            const classes = {
                'login': 'login',
                'logout': 'logout',
                'create': 'create',
                'update': 'update',
                'delete': 'delete',
                'error': 'error'
            };
            return classes[type] || '';
        }

        async function exportLogs() {
            // Implementar exportaci√≥n de logs a CSV
            showSuccess('Funci√≥n de exportaci√≥n en desarrollo');
        }

        // Funci√≥n para mostrar/ocultar b√∫squeda manual
        function toggleSearch() {
            const searchSection = document.getElementById('searchSection');
            const pendingSection = document.getElementById('pendingExitsSection');
            
            if (searchSection.style.display === 'none') {
                searchSection.style.display = 'block';
                pendingSection.style.display = 'none';
            } else {
                searchSection.style.display = 'none';
                pendingSection.style.display = 'block';
                // Limpiar b√∫squeda
                document.getElementById('studentSearch').value = '';
                document.getElementById('searchResult').innerHTML = '';
            }
        }

        // Funci√≥n para cargar todos los estudiantes con salidas pendientes
        async function loadPendingExits() {
            const pendingList = document.getElementById('pendingExitsList');
            
            try {
                pendingList.innerHTML = '<div class="card" style="text-align: center; padding: 20px;"><p style="color: #666;">üîÑ Cargando salidas pendientes...</p></div>';
                
                const todayColombia = getColombiaDate();
                console.log('üìÖ Cargando salidas pendientes para Colombia:', todayColombia);
                
                // Obtener autorizaciones pendientes para hoy
                const { data: authorizations, error } = await supabase
                    .from('autorizaciones_salida')
                    .select('*')
                    .eq('fecha_salida', todayColombia)
                    .eq('autorizada', true)
                    .is('salida_efectiva', null)
                    .order('hora_salida', { ascending: true });

                if (error) {
                    console.error('‚ùå Error al cargar salidas pendientes:', error);
                    throw error;
                }

                if (!authorizations || authorizations.length === 0) {
                    const currentTime = getColombiaTime();
                    pendingList.innerHTML = `
                        <div class="verification-card" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d);">
                            <h3>‚úÖ ¬°Todo en orden!</h3>
                            <p><strong>No hay salidas pendientes para hoy</strong></p>
                            <p>Fecha: ${formatDate(todayColombia)} - Hora: ${currentTime}</p>
                            <p>Todos los estudiantes autorizados ya han sido confirmados</p>
                        </div>
                    `;
                    return;
                }

                console.log('üìä Salidas pendientes encontradas:', authorizations.length);

                // Obtener informaci√≥n de estudiantes, motivos y usuarios
                const studentIds = [...new Set(authorizations.map(auth => auth.estudiante_id))];
                const reasonIds = [...new Set(authorizations.map(auth => auth.motivo_id))];
                const userIds = [...new Set(authorizations.map(auth => auth.usuario_autorizador_id))];

                const [studentsResult, reasonsResult, usersResult] = await Promise.all([
                    supabase
                        .from('estudiantes')
                        .select('id, nombre, apellidos, grado:grados(nombre)')
                        .in('id', studentIds),
                    supabase
                        .from('motivos')
                        .select('id, nombre')
                        .in('id', reasonIds),
                    supabase
                        .from('usuarios')
                        .select('id, nombre')
                        .in('id', userIds)
                ]);

                // Crear mapas para b√∫squeda r√°pida
                const studentMap = {};
                const reasonMap = {};
                const userMap = {};

                studentsResult.data?.forEach(student => {
                    studentMap[student.id] = student;
                });

                reasonsResult.data?.forEach(reason => {
                    reasonMap[reason.id] = reason;
                });

                usersResult.data?.forEach(user => {
                    userMap[user.id] = user;
                });

                // Generar HTML para cada autorizaci√≥n pendiente
                const currentTime = getColombiaTime();
                let html = `<div style="text-align: center; margin-bottom: 25px; background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px;">
                    <p style="color: #2c3e50; font-weight: bold; font-size: 16px;">üìÖ ${formatDate(todayColombia)} - üïê ${currentTime} (Hora Colombia)</p>
                    <p style="color: #7f8c8d; margin-top: 8px;">Salidas pendientes de confirmaci√≥n: <strong>${authorizations.length}</strong></p>
                </div>`;
                
                authorizations.forEach(auth => {
                    const student = studentMap[auth.estudiante_id];
                    const reason = reasonMap[auth.motivo_id];
                    const user = userMap[auth.usuario_autorizador_id];

                    html += `
                        <div class="verification-card authorized">
                            <h3>‚è≥ PENDIENTE CONFIRMAR SALIDA</h3>
                            
                            <div class="verification-card-content">
                                <div class="verification-card-info">
                                    <p>
                                        <strong>üë®‚Äçüéì Estudiante:</strong>
                                        <span class="info-value">${student ? sanitizeHtml(`${student.nombre} ${student.apellidos}`) : 'No encontrado'}</span>
                                    </p>
                                    <p>
                                        <strong>üéì Grado:</strong>
                                        <span class="info-value">${student?.grado?.nombre ? sanitizeHtml(student.grado.nombre) : 'No encontrado'}</span>
                                    </p>
                                </div>
                                <div class="verification-card-info">
                                    <p>
                                        <strong>üìù Motivo de Salida:</strong>
                                        <span class="info-value">${reason?.nombre ? sanitizeHtml(reason.nombre) : 'No encontrado'}</span>
                                    </p>
                                    <p>
                                        <strong>üïê Hora Autorizada:</strong>
                                        <span class="info-value">${formatTime(auth.hora_salida)}</span>
                                    </p>
                                </div>
                            </div>
                            
                            <div class="verification-card-footer">
                                <p><strong>‚úÖ Autorizado por:</strong> ${user?.nombre ? sanitizeHtml(user.nombre) : 'No encontrado'}</p>
                                ${auth.observaciones ? `
                                    <div class="verification-card-obs">
                                        <strong>üìù Observaciones:</strong><br>
                                        ${sanitizeHtml(auth.observaciones)}
                                    </div>
                                ` : ''}
                                <button class="btn btn-success" onclick="confirmExit(${auth.id})" style="font-size: 18px; padding: 15px 40px; margin-top: 15px;">
                                    ‚úÖ CONFIRMAR SALIDA
                                </button>
                            </div>
                        </div>
                    `;
                });

                pendingList.innerHTML = html;
                console.log('‚úÖ Lista de salidas pendientes cargada');

            } catch (error) {
                console.error('‚ùå Error general:', error);
                pendingList.innerHTML = `
                    <div class="verification-card not-authorized">
                        <h3>‚ùå Error al cargar</h3>
                        <p>No se pudieron cargar las salidas pendientes</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <button class="btn btn-secondary" onclick="loadPendingExits()" style="margin-top: 10px;">
                            üîÑ Intentar de nuevo
                        </button>
                    </div>
                `;
            }
        }

        // NUEVA FUNCI√ìN: Cargar estudiantes por grado seleccionado
        async function loadStudentsByGrade() {
            const gradeId = document.getElementById('gradeSelect').value;
            const studentSelect = document.getElementById('studentSelect');
            
            // Si no hay grado seleccionado, deshabilitar el select de estudiantes
            if (!gradeId) {
                studentSelect.innerHTML = '<option value="">Primero selecciona un grado...</option>';
                studentSelect.disabled = true;
                return;
            }
            
            try {
                // Mostrar mensaje de carga
                studentSelect.innerHTML = '<option value="">Cargando estudiantes...</option>';
                studentSelect.disabled = true;
                
                console.log('üîÑ Cargando estudiantes del grado ID:', gradeId);
                
                // Cargar estudiantes del grado seleccionado
                const { data: students, error } = await supabase
                    .from('estudiantes')
                    .select(`
                        id,
                        nombre,
                        apellidos,
                        documento
                    `)
                    .eq('grado_id', gradeId)
                    .eq('activo', true)
                    .order('apellidos')
                    .order('nombre');

                if (error) throw error;

                console.log('üìä Estudiantes encontrados:', students.length);

                // Llenar el select con los estudiantes
                studentSelect.innerHTML = '<option value="">Seleccionar estudiante...</option>';
                
                if (students && students.length > 0) {
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.apellidos}, ${student.nombre}${student.documento ? ' - Doc: ' + student.documento : ''}`;
                        studentSelect.appendChild(option);
                    });
                    
                    // Habilitar el select
                    studentSelect.disabled = false;
                    console.log('‚úÖ Select de estudiantes habilitado con', students.length, 'estudiantes');
                } else {
                    studentSelect.innerHTML = '<option value="">No hay estudiantes en este grado</option>';
                    console.log('‚ö†Ô∏è No se encontraron estudiantes para el grado seleccionado');
                }
                
            } catch (error) {
                console.error('‚ùå Error al cargar estudiantes por grado:', error);
                showError('Error al cargar los estudiantes: ' + error.message);
                studentSelect.innerHTML = '<option value="">Error al cargar estudiantes</option>';
                studentSelect.disabled = true;
            }
        }

        // Funci√≥n auxiliar para resetear el formulario de autorizaci√≥n
        function resetAuthorizationForm() {
            document.getElementById('authorizeForm').reset();
            
            // Resetear el select de estudiantes
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">Primero selecciona un grado...</option>';
            studentSelect.disabled = true;
            
            // Establecer fecha actual de Colombia
            const todayColombia = getColombiaDate();
            document.getElementById('exitDate').value = todayColombia;
        }

        // Funciones de carga de datos
        async function loadStudents() {
            try {
                const { data: students, error } = await supabase
                    .from('estudiantes')
                    .select(`
                        *,
                        grado:grados(nombre)
                    `)
                    .eq('activo', true)
                    .order('nombre');

                if (error) throw error;

                const select = document.getElementById('studentSelect');
                const gradeSelect = document.getElementById('studentGrade');
                
                select.innerHTML = '<option value="">Seleccionar estudiante...</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.nombre} ${student.apellidos} - ${student.grado.nombre}`;
                    select.appendChild(option);
                });

                // Actualizar tabla de administraci√≥n si est√° visible
                updateStudentsTable(students);
                
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        async function loadReasons() {
            try {
                const { data: reasons, error } = await supabase
                    .from('motivos')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre');

                if (error) throw error;

                const select = document.getElementById('reasonSelect');
                select.innerHTML = '<option value="">Seleccionar motivo...</option>';
                
                reasons.forEach(reason => {
                    const option = document.createElement('option');
                    option.value = reason.id;
                    option.textContent = reason.nombre;
                    select.appendChild(option);
                });

                updateReasonsTable(reasons);
                
            } catch (error) {
                console.error('Error loading reasons:', error);
            }
        }

        async function loadGrades() {
            try {
                const { data: grades, error } = await supabase
                    .from('grados')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre');

                if (error) throw error;

                // Llenar el select de grados en el formulario de autorizaci√≥n
                const gradeSelect = document.getElementById('gradeSelect');
                gradeSelect.innerHTML = '<option value="">Seleccionar grado...</option>';
                
                grades.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade.id;
                    option.textContent = `${grade.nombre} - ${grade.nivel}`;
                    gradeSelect.appendChild(option);
                });

                // Tambi√©n llenar el select de grados en el modal de estudiantes (admin)
                const studentGradeSelect = document.getElementById('studentGrade');
                if (studentGradeSelect) {
                    studentGradeSelect.innerHTML = '<option value="">Seleccionar grado...</option>';
                    
                    grades.forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade.id;
                        option.textContent = `${grade.nombre} - ${grade.nivel}`;
                        studentGradeSelect.appendChild(option);
                    });
                }

                // Actualizar tabla de administraci√≥n si est√° visible
                updateGradesTable(grades);
                
                console.log('‚úÖ Grados cargados:', grades.length);
                
            } catch (error) {
                console.error('Error loading grades:', error);
                showError('Error al cargar los grados: ' + error.message);
            }
        }

        async function loadRoles() {
            try {
                const { data: roles, error } = await supabase
                    .from('roles')
                    .select('*')
                    .order('nombre');

                if (error) throw error;

                const select = document.getElementById('userRole');
                select.innerHTML = '<option value="">Seleccionar rol...</option>';
                
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.descripcion;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }

        async function loadUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('usuarios')
                    .select(`
                        *,
                        rol:roles(nombre, descripcion)
                    `)
                    .order('nombre');

                if (error) throw error;

                updateUsersTable(users);
                
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Funci√≥n para autorizar salida con mejoras de seguridad
        async function authorizeExit(e) {
            e.preventDefault();
            
            const gradeId = document.getElementById('gradeSelect').value;
            const studentId = document.getElementById('studentSelect').value;
            const reasonId = document.getElementById('reasonSelect').value;
            const exitDate = document.getElementById('exitDate').value;
            const exitTime = document.getElementById('exitTime').value;
            const observations = sanitizeHtml(document.getElementById('observations').value);

            if (!gradeId) {
                showError('Por favor, selecciona primero un grado');
                return;
            }

            if (!studentId) {
                showError('Por favor, selecciona un estudiante del grado elegido');
                return;
            }

            if (!reasonId || !exitDate || !exitTime) {
                showError('Por favor, completa todos los campos obligatorios');
                return;
            }

            // Validar fecha no sea pasada
            const todayColombia = getColombiaDate();
            if (exitDate < todayColombia) {
                showError('No se puede autorizar una salida para una fecha pasada');
                return;
            }

            try {
                // Crear timestamp en zona horaria de Colombia
                const colombiaDateTime = new Date().toLocaleString('sv-SE', { 
                    timeZone: 'America/Bogota' 
                });

                const { data, error } = await supabase
                    .from('autorizaciones_salida')
                    .insert([{
                        estudiante_id: studentId,
                        motivo_id: reasonId,
                        usuario_autorizador_id: currentUser.id,
                        fecha_salida: exitDate,
                        hora_salida: exitTime,
                        observaciones: observations || null,
                        fecha_creacion: colombiaDateTime,
                        autorizada: true
                    }]);

                if (error) throw error;

                // Obtener informaci√≥n del estudiante y grado para mostrar en el mensaje
                const gradeSelect = document.getElementById('gradeSelect');
                const studentSelect = document.getElementById('studentSelect');
                const gradeName = gradeSelect.options[gradeSelect.selectedIndex].text;
                const studentName = studentSelect.options[studentSelect.selectedIndex].text;

                // Registrar evento
                await logSecurityEvent('create', 'Autorizaci√≥n de salida creada', {
                    studentId,
                    gradeId,
                    reasonId,
                    exitDate,
                    exitTime
                }, true);

                showSuccess(`‚úÖ Autorizaci√≥n creada exitosamente para ${studentName} (${gradeName})`);
                
                // Resetear el formulario
                resetAuthorizationForm();
                
                console.log(`‚úÖ Autorizaci√≥n creada: ${studentName} - ${gradeName} - ${exitDate} ${exitTime}`);
                
            } catch (error) {
                await logSecurityEvent('error', 'Error al crear autorizaci√≥n', { error: error.message }, false);
                showError('Error al crear la autorizaci√≥n: ' + error.message);
            }
        }

        // Funci√≥n para buscar y verificar estudiante (b√∫squeda manual) con mejoras de seguridad
        async function searchStudent() {
            const searchTerm = sanitizeHtml(document.getElementById('studentSearch').value.trim());
            const resultDiv = document.getElementById('searchResult');
            
            if (searchTerm.length < 3) {
                resultDiv.innerHTML = '<div class="card"><p style="text-align: center; color: #666;">Escribe al menos 3 caracteres para buscar...</p></div>';
                return;
            }

            try {
                const todayColombia = getColombiaDate();
                
                console.log('üîç Buscando autorizaciones para:', searchTerm, 'en fecha Colombia:', todayColombia);
                
                // Buscar autorizaciones que coincidan con el nombre
                const { data: authorizations, error } = await supabase
                    .from('autorizaciones_salida')
                    .select('*')
                    .eq('fecha_salida', todayColombia)
                    .eq('autorizada', true);

                if (error) {
                    console.error('Error en b√∫squeda:', error);
                    showError('Error al buscar autorizaciones: ' + error.message);
                    return;
                }

                if (!authorizations || authorizations.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="verification-card not-authorized">
                            <h3>‚ùå NO HAY AUTORIZACIONES</h3>
                            <p>No se encontraron autorizaciones para la fecha de hoy (${formatDate(todayColombia)}).</p>
                        </div>
                    `;
                    return;
                }

                // Obtener estudiantes que coincidan con el t√©rmino de b√∫squeda
                const { data: students, error: studentsError } = await supabase
                    .from('estudiantes')
                    .select('id, nombre, apellidos, grado:grados(nombre)')
                    .or(`nombre.ilike.%${searchTerm}%,apellidos.ilike.%${searchTerm}%`)
                    .eq('activo', true);

                if (studentsError) {
                    console.error('Error buscando estudiantes:', studentsError);
                    resultDiv.innerHTML = `
                        <div class="verification-card not-authorized">
                            <h3>‚ùå ERROR EN B√öSQUEDA</h3>
                            <p>Error al buscar estudiantes: ${studentsError.message}</p>
                        </div>
                    `;
                    return;
                }

                // Filtrar autorizaciones por estudiantes encontrados
                const studentIds = students?.map(s => s.id) || [];
                const matchingAuth = authorizations.filter(auth => 
                    studentIds.includes(auth.estudiante_id)
                );

                if (matchingAuth.length === 0) {
                    let studentsList = students?.map(s => `${sanitizeHtml(s.nombre)} ${sanitizeHtml(s.apellidos)} (${sanitizeHtml(s.grado.nombre)})`).join(', ') || '';
                    resultDiv.innerHTML = `
                        <div class="verification-card not-authorized">
                            <h3>‚ùå NO AUTORIZADO</h3>
                            <p>No se encontraron autorizaciones para "${sanitizeHtml(searchTerm)}" en la fecha de hoy (${formatDate(todayColombia)}).</p>
                            ${studentsList ? `<p><strong>Estudiantes encontrados:</strong> ${studentsList}</p>` : ''}
                            <p><em>Verifica que tengan autorizaci√≥n para hoy o contacta al personal autorizado.</em></p>
                        </div>
                    `;
                    return;
                }

                // Obtener informaci√≥n adicional para mostrar los resultados
                const reasonIds = [...new Set(matchingAuth.map(auth => auth.motivo_id))];
                const userIds = [...new Set(matchingAuth.map(auth => auth.usuario_autorizador_id))];

                const [reasonsResult, usersResult] = await Promise.all([
                    supabase.from('motivos').select('id, nombre').in('id', reasonIds),
                    supabase.from('usuarios').select('id, nombre').in('id', userIds)
                ]);

                // Crear mapas
                const studentMap = {};
                const reasonMap = {};
                const userMap = {};

                students?.forEach(student => {
                    studentMap[student.id] = student;
                });

                reasonsResult.data?.forEach(reason => {
                    reasonMap[reason.id] = reason;
                });

                usersResult.data?.forEach(user => {
                    userMap[user.id] = user;
                });

                // Mostrar resultados con el nuevo dise√±o
                const currentTime = getColombiaTime();
                let html = `<div style="text-align: center; margin-bottom: 20px; background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 5px;">
                    <p style="color: #2c3e50; font-size: 15px; font-weight: bold;">üìÖ ${formatDate(todayColombia)} - üïê ${currentTime} (Hora Colombia)</p>
                </div>`;
                
                matchingAuth.forEach(auth => {
                    const student = studentMap[auth.estudiante_id];
                    const reason = reasonMap[auth.motivo_id];
                    const user = userMap[auth.usuario_autorizador_id];

                    // Determinar el estado y color de la tarjeta
                    let cardClass, titleText, footerHtml;
                    
                    if (auth.salida_efectiva) {
                        cardClass = 'verified';  // Azul para ya confirmados
                        titleText = '‚úÖ SALIDA YA CONFIRMADA';
                        footerHtml = `
                            <div class="verification-card-footer">
                                <p><strong>‚úÖ Autorizado por:</strong> ${user?.nombre ? sanitizeHtml(user.nombre) : 'No encontrado'}</p>
                                ${auth.observaciones ? `
                                    <div class="verification-card-obs">
                                        <strong>üìù Observaciones:</strong><br>
                                        ${sanitizeHtml(auth.observaciones)}
                                    </div>
                                ` : ''}
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                                    <p style="color: white; font-weight: bold; margin: 0;">
                                        ‚úÖ CONFIRMADA: ${formatDateTime(auth.salida_efectiva)}<br>
                                        <small>Vigilante: ${sanitizeHtml(currentUser.nombre)}</small>
                                    </p>
                                </div>
                            </div>
                        `;
                    } else {
                        cardClass = 'authorized';  // Verde para pendientes
                        titleText = '‚úÖ AUTORIZADO PARA SALIR';
                        footerHtml = `
                            <div class="verification-card-footer">
                                <p><strong>‚úÖ Autorizado por:</strong> ${user?.nombre ? sanitizeHtml(user.nombre) : 'No encontrado'}</p>
                                ${auth.observaciones ? `
                                    <div class="verification-card-obs">
                                        <strong>üìù Observaciones:</strong><br>
                                        ${sanitizeHtml(auth.observaciones)}
                                    </div>
                                ` : ''}
                                <button class="btn btn-success" onclick="confirmExit(${auth.id})" style="font-size: 18px; padding: 15px 40px; margin-top: 15px;">
                                    ‚úÖ CONFIRMAR SALIDA
                                </button>
                            </div>
                        `;
                    }

                    html += `
                        <div class="verification-card ${cardClass}">
                            <h3>${titleText}</h3>
                            
                            <div class="verification-card-content">
                                <div class="verification-card-info">
                                    <p>
                                        <strong>üë®‚Äçüéì Estudiante:</strong>
                                        <span class="info-value">${student ? `${sanitizeHtml(student.nombre)} ${sanitizeHtml(student.apellidos)}` : 'No encontrado'}</span>
                                    </p>
                                    <p>
                                        <strong>üéì Grado:</strong>
                                        <span class="info-value">${student?.grado?.nombre ? sanitizeHtml(student.grado.nombre) : 'No encontrado'}</span>
                                    </p>
                                </div>
                                <div class="verification-card-info">
                                    <p>
                                        <strong>üìù Motivo de Salida:</strong>
                                        <span class="info-value">${reason?.nombre ? sanitizeHtml(reason.nombre) : 'No encontrado'}</span>
                                    </p>
                                    <p>
                                        <strong>üïê Hora Autorizada:</strong>
                                        <span class="info-value">${formatTime(auth.hora_salida)}</span>
                                    </p>
                                </div>
                            </div>
                            
                            ${footerHtml}
                        </div>
                    `;
                });

                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error general en b√∫squeda:', error);
                showError('Error al buscar autorizaciones: ' + error.message);
                resultDiv.innerHTML = `
                    <div class="verification-card not-authorized">
                        <h3>‚ùå ERROR</h3>
                        <p>Error en la b√∫squeda: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function confirmExit(authId) {
            try {
                // Crear timestamp de salida efectiva en zona horaria de Colombia
                const colombiaDateTime = new Date().toLocaleString('sv-SE', { 
                    timeZone: 'America/Bogota' 
                });

                const { data, error } = await supabase
                    .from('autorizaciones_salida')
                    .update({
                        salida_efectiva: colombiaDateTime,
                        vigilante_id: currentUser.id
                    })
                    .eq('id', authId);

                if (error) throw error;

                await logSecurityEvent('update', 'Salida confirmada', { authId, vigilanteId: currentUser.id }, true);

                const colombiaTime = getColombiaTime();
                showSuccess(`Salida confirmada exitosamente a las ${colombiaTime}`);
                
                // Actualizar visualmente la tarjeta que se acaba de confirmar
                const confirmButton = document.querySelector(`button[onclick="confirmExit(${authId})"]`);
                if (confirmButton) {
                    const card = confirmButton.closest('.verification-card');
                    if (card) {
                        // Cambiar la clase de 'authorized' a 'verified' (azul)
                        card.classList.remove('authorized');
                        card.classList.add('verified');
                        
                        // Actualizar el t√≠tulo
                        const titleElement = card.querySelector('h3');
                        if (titleElement) {
                            titleElement.textContent = '‚úÖ SALIDA CONFIRMADA';
                        }
                        
                        // Reemplazar el bot√≥n con mensaje de confirmaci√≥n usando el nuevo dise√±o
                        const footerElement = confirmButton.closest('.verification-card-footer');
                        if (footerElement) {
                            const observationsHtml = footerElement.querySelector('.verification-card-obs')?.outerHTML || '';
                            
                            footerElement.innerHTML = `
                                <p><strong>‚úÖ Autorizado por:</strong> Usuario</p>
                                ${observationsHtml}
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                                    <p style="color: white; font-weight: bold; margin: 0;">
                                        ‚úÖ SALIDA CONFIRMADA<br>
                                        <small>Hora: ${colombiaTime} - Vigilante: ${sanitizeHtml(currentUser.nombre)}</small>
                                    </p>
                                </div>
                            `;
                        }
                        
                        // Animar el cambio de color
                        card.style.transform = 'scale(1.02)';
                        setTimeout(() => {
                            card.style.transform = 'scale(1)';
                        }, 300);
                    }
                }
                
                // Limpiar b√∫squeda si estaba activa
                const searchInput = document.getElementById('studentSearch');
                if (searchInput) {
                    searchInput.value = '';
                }
                const searchResult = document.getElementById('searchResult');
                if (searchResult) {
                    searchResult.innerHTML = '';
                }
                
                // Si estamos en la vista de pendientes, actualizar despu√©s de 2 segundos para mostrar el efecto visual
                if (currentUser.rol.nombre === 'vigilante') {
                    setTimeout(async () => {
                        await loadPendingExits();
                    }, 2000);
                }
                
            } catch (error) {
                await logSecurityEvent('error', 'Error al confirmar salida', { error: error.message }, false);
                showError('Error al confirmar la salida: ' + error.message);
            }
        }

        // Funciones de administraci√≥n
        function showAdminSection(section) {
            document.querySelectorAll('.admin-subsection').forEach(sub => {
                sub.style.display = 'none';
            });
            document.getElementById(`admin${section.charAt(0).toUpperCase() + section.slice(1)}`).style.display = 'block';
            
            // Si es la secci√≥n de seguridad, cargar los datos
            if (section === 'security' && currentUser.rol.nombre === 'administrador') {
                loadSecurityStats();
                loadSecurityLogs();
            }
        }

        // Funciones de modales - MEJORADAS
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            currentEditingId = null;
            
            // Limpiar formularios
            if (modalId === 'studentModal') {
                document.getElementById('studentForm').reset();
            } else if (modalId === 'userModal') {
                document.getElementById('userForm').reset();
                // Mostrar nota para nuevos usuarios
                document.getElementById('passwordNote').textContent = '(obligatorio para nuevos usuarios)';
                document.getElementById('userPassword').required = true;
                document.getElementById('userPasswordStrength').style.display = 'none';
            } else if (modalId === 'reasonModal') {
                document.getElementById('reasonForm').reset();
            } else if (modalId === 'gradeModal') {
                document.getElementById('gradeForm').reset();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            currentEditingId = null;
        }

        // Funciones CRUD con mejoras de seguridad
        async function saveStudent(e) {
            e.preventDefault();
            
            const name = sanitizeHtml(document.getElementById('studentName').value.trim());
            const lastName = sanitizeHtml(document.getElementById('studentLastName').value.trim());
            const documentValue = sanitizeHtml(document.getElementById('studentDocument').value.trim());
            const gradeId = document.getElementById('studentGrade').value;

            if (!name || !lastName || !gradeId) {
                showError('Por favor, completa todos los campos obligatorios');
                return;
            }

            // Validar formato de nombres
            const namePattern = /^[A-Za-z√Ä-√ø\s]{2,50}$/;
            if (!namePattern.test(name) || !namePattern.test(lastName)) {
                showError('Los nombres solo deben contener letras y espacios');
                return;
            }

            // Validar documento si se proporciona
            if (documentValue && !/^[0-9]{6,20}$/.test(documentValue)) {
                showError('El documento debe contener solo n√∫meros (6-20 d√≠gitos)');
                return;
            }

            try {
                let result;
                if (currentEditingId) {
                    result = await supabase
                        .from('estudiantes')
                        .update({
                            nombre: name,
                            apellidos: lastName,
                            documento: documentValue || null,
                            grado_id: gradeId
                        })
                        .eq('id', currentEditingId);
                        
                    await logSecurityEvent('update', 'Estudiante actualizado', { studentId: currentEditingId }, true);
                } else {
                    result = await supabase
                        .from('estudiantes')
                        .insert([{
                            nombre: name,
                            apellidos: lastName,
                            documento: documentValue || null,
                            grado_id: gradeId,
                            activo: true
                        }]);
                        
                    await logSecurityEvent('create', 'Estudiante creado', { name, lastName, gradeId }, true);
                }

                if (result.error) {
                    console.error('Error al guardar estudiante:', result.error);
                    throw result.error;
                }

                showSuccess('Estudiante guardado exitosamente');
                closeModal('studentModal');
                await loadStudents();
                
            } catch (error) {
                console.error('Error completo al guardar estudiante:', error);
                await logSecurityEvent('error', 'Error al guardar estudiante', { error: error.message }, false);
                showError('Error al guardar el estudiante: ' + error.message);
            }
        }

        async function saveUser(e) {
            e.preventDefault();
            
            const name = sanitizeHtml(document.getElementById('userName').value.trim());
            const email = document.getElementById('userEmail').value.trim().toLowerCase();
            const password = document.getElementById('userPassword').value;
            const roleId = document.getElementById('userRole').value;

            if (!name || !email || !roleId) {
                showError('Por favor, completa todos los campos obligatorios');
                return;
            }

            // Validar email
            if (!validateEmail(email)) {
                showError('Formato de email inv√°lido');
                return;
            }

            // Validar nombre
            const namePattern = /^[A-Za-z√Ä-√ø\s]{2,50}$/;
            if (!namePattern.test(name)) {
                showError('El nombre solo debe contener letras y espacios');
                return;
            }

            if (!currentEditingId && !password) {
                showError('La contrase√±a es obligatoria para nuevos usuarios');
                return;
            }

            // Validar contrase√±a para nuevos usuarios o si se est√° cambiando
            if (password && !validatePassword(password)) {
                showError('La contrase√±a debe tener entre 8 y 50 caracteres');
                return;
            }

            try {
                let result;
                if (currentEditingId) {
                    // Al editar, solo actualizar contrase√±a si se proporcion√≥ una nueva
                    const updateData = {
                        nombre: name,
                        email: email,
                        rol_id: roleId
                    };
                    
                    if (password && password.trim() !== '') {
                        // TODO: Implementar hash de contrase√±a
                        updateData.password_hash = password;
                    }

                    result = await supabase
                        .from('usuarios')
                        .update(updateData)
                        .eq('id', currentEditingId);
                        
                    await logSecurityEvent('update', 'Usuario actualizado', { userId: currentEditingId, email }, true);
                } else {
                    // TODO: Implementar hash de contrase√±a
                    result = await supabase
                        .from('usuarios')
                        .insert([{
                            nombre: name,
                            email: email,
                            password_hash: password,
                            rol_id: roleId,
                            activo: true
                        }]);
                        
                    await logSecurityEvent('create', 'Usuario creado', { email, roleId }, true);
                }

                if (result.error) {
                    console.error('Error al guardar usuario:', result.error);
                    if (result.error.code === '23505') {
                        showError('Ya existe un usuario con ese email');
                    } else {
                        throw result.error;
                    }
                    return;
                }

                showSuccess('Usuario guardado exitosamente');
                closeModal('userModal');
                await loadUsers();
                
            } catch (error) {
                console.error('Error completo al guardar usuario:', error);
                await logSecurityEvent('error', 'Error al guardar usuario', { error: error.message }, false);
                showError('Error al guardar el usuario: ' + error.message);
            }
        }

        async function saveReason(e) {
            e.preventDefault();
            
            const name = sanitizeHtml(document.getElementById('reasonName').value.trim());
            const description = sanitizeHtml(document.getElementById('reasonDescription').value.trim());

            if (!name) {
                showError('El nombre del motivo es obligatorio');
                return;
            }

            if (name.length > 50) {
                showError('El nombre del motivo no puede exceder 50 caracteres');
                return;
            }

            try {
                let result;
                if (currentEditingId) {
                    result = await supabase
                        .from('motivos')
                        .update({
                            nombre: name,
                            descripcion: description || null
                        })
                        .eq('id', currentEditingId);
                        
                    await logSecurityEvent('update', 'Motivo actualizado', { reasonId: currentEditingId }, true);
                } else {
                    result = await supabase
                        .from('motivos')
                        .insert([{
                            nombre: name,
                            descripcion: description || null,
                            activo: true
                        }]);
                        
                    await logSecurityEvent('create', 'Motivo creado', { name }, true);
                }

                if (result.error) {
                    console.error('Error al guardar motivo:', result.error);
                    throw result.error;
                }

                showSuccess('Motivo guardado exitosamente');
                closeModal('reasonModal');
                await loadReasons();
                
            } catch (error) {
                console.error('Error completo al guardar motivo:', error);
                await logSecurityEvent('error', 'Error al guardar motivo', { error: error.message }, false);
                showError('Error al guardar el motivo: ' + error.message);
            }
        }

        async function saveGrade(e) {
            e.preventDefault();
            
            const name = sanitizeHtml(document.getElementById('gradeName').value.trim());
            const level = document.getElementById('gradeLevel').value;

            if (!name || !level) {
                showError('Por favor, completa todos los campos obligatorios');
                return;
            }

            if (name.length > 20) {
                showError('El nombre del grado no puede exceder 20 caracteres');
                return;
            }

            try {
                let result;
                if (currentEditingId) {
                    result = await supabase
                        .from('grados')
                        .update({
                            nombre: name,
                            nivel: level
                        })
                        .eq('id', currentEditingId);
                        
                    await logSecurityEvent('update', 'Grado actualizado', { gradeId: currentEditingId }, true);
                } else {
                    result = await supabase
                        .from('grados')
                        .insert([{
                            nombre: name,
                            nivel: level,
                            activo: true
                        }]);
                        
                    await logSecurityEvent('create', 'Grado creado', { name, level }, true);
                }

                if (result.error) {
                    console.error('Error al guardar grado:', result.error);
                    throw result.error;
                }

                showSuccess('Grado guardado exitosamente');
                closeModal('gradeModal');
                await loadGrades();
                
            } catch (error) {
                console.error('Error completo al guardar grado:', error);
                await logSecurityEvent('error', 'Error al guardar grado', { error: error.message }, false);
                showError('Error al guardar el grado: ' + error.message);
            }
        }

        // Funciones de actualizaci√≥n de tablas
        function updateStudentsTable(students) {
            const tbody = document.querySelector('#studentsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            students.forEach(student => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${sanitizeHtml(student.nombre)}</td>
                    <td>${sanitizeHtml(student.apellidos)}</td>
                    <td>${student.documento ? sanitizeHtml(student.documento) : 'N/A'}</td>
                    <td>${student.grado?.nombre ? sanitizeHtml(student.grado.nombre) : 'Sin grado'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editStudent(${student.id})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteStudent(${student.id})">Eliminar</button>
                    </td>
                `;
            });
        }

        function updateUsersTable(users) {
            const tbody = document.querySelector('#usersTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            users.forEach(user => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${sanitizeHtml(user.nombre)}</td>
                    <td>${sanitizeHtml(user.email)}</td>
                    <td>${user.rol?.descripcion ? sanitizeHtml(user.rol.descripcion) : 'Sin rol'}</td>
                    <td>${user.activo ? 'Activo' : 'Inactivo'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editUser(${user.id})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteUser(${user.id})">Eliminar</button>
                    </td>
                `;
            });
        }

        function updateReasonsTable(reasons) {
            const tbody = document.querySelector('#reasonsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            reasons.forEach(reason => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${sanitizeHtml(reason.nombre)}</td>
                    <td>${reason.descripcion ? sanitizeHtml(reason.descripcion) : 'N/A'}</td>
                    <td>${reason.activo ? 'Activo' : 'Inactivo'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editReason(${reason.id})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteReason(${reason.id})">Eliminar</button>
                    </td>
                `;
            });
        }

        function updateGradesTable(grades) {
            const tbody = document.querySelector('#gradesTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            grades.forEach(grade => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${sanitizeHtml(grade.nombre)}</td>
                    <td>${sanitizeHtml(grade.nivel)}</td>
                    <td>${grade.activo ? 'Activo' : 'Inactivo'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editGrade(${grade.id})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteGrade(${grade.id})">Eliminar</button>
                    </td>
                `;
            });
        }

        // Funciones de historial - MEJORADAS para zona horaria Colombia
        async function loadHistory(all = false) {
            try {
                console.log('üîç Cargando historial...');
                
                // Primero, intentar consulta simple sin JOINs para debug
                let query = supabase
                    .from('autorizaciones_salida')
                    .select('*')
                    .order('fecha_creacion', { ascending: false });

                if (!all) {
                    const date = document.getElementById('historyDate').value;
                    if (date) {
                        console.log('üóìÔ∏è Filtrando por fecha:', date);
                        query = query.eq('fecha_salida', date);
                    } else {
                        // Si no hay fecha, mostrar solo los √∫ltimos 30 d√≠as desde hoy (Colombia)
                        const todayColombia = getColombiaDate();
                        const thirtyDaysAgo = new Date(todayColombia);
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        const dateLimit = thirtyDaysAgo.toISOString().split('T')[0];
                        console.log('üóìÔ∏è Filtrando √∫ltimos 30 d√≠as desde:', dateLimit, 'hasta:', todayColombia);
                        query = query.gte('fecha_salida', dateLimit);
                    }
                }

                const { data: authorizations, error } = await query;

                if (error) {
                    console.error('‚ùå Error en consulta de historial:', error);
                    showError('Error al cargar el historial: ' + error.message);
                    return;
                }

                if (!authorizations || authorizations.length === 0) {
                    console.log('üìä No se encontraron autorizaciones');
                    const tbody = document.querySelector('#historyTable tbody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #666; padding: 20px;">
                                No se encontraron registros para el per√≠odo seleccionado<br>
                                <small>Zona horaria: Colombia (UTC-5)</small>
                            </td>
                        </tr>
                    `;
                    showSuccess('Historial cargado: 0 registros');
                    return;
                }

                console.log('üìä Autorizaciones encontradas:', authorizations.length);

                // Ahora obtener los datos relacionados (estudiantes, motivos, usuarios)
                const studentIds = [...new Set(authorizations.map(auth => auth.estudiante_id))];
                const reasonIds = [...new Set(authorizations.map(auth => auth.motivo_id))];
                const userIds = [...new Set(authorizations.map(auth => auth.usuario_autorizador_id))];

                console.log('üë• IDs √∫nicos - Estudiantes:', studentIds.length, 'Motivos:', reasonIds.length, 'Usuarios:', userIds.length);

                // Obtener estudiantes con sus grados
                const { data: students, error: studentsError } = await supabase
                    .from('estudiantes')
                    .select(`
                        id, nombre, apellidos,
                        grado:grados(nombre)
                    `)
                    .in('id', studentIds);

                // Obtener motivos
                const { data: reasons, error: reasonsError } = await supabase
                    .from('motivos')
                    .select('id, nombre')
                    .in('id', reasonIds);

                // Obtener usuarios
                const { data: users, error: usersError } = await supabase
                    .from('usuarios')
                    .select('id, nombre')
                    .in('id', userIds);

                if (studentsError) console.error('Error estudiantes:', studentsError);
                if (reasonsError) console.error('Error motivos:', reasonsError);
                if (usersError) console.error('Error usuarios:', usersError);

                // Crear mapas para b√∫squeda r√°pida
                const studentMap = {};
                const reasonMap = {};
                const userMap = {};

                students?.forEach(student => {
                    studentMap[student.id] = student;
                });

                reasons?.forEach(reason => {
                    reasonMap[reason.id] = reason;
                });

                users?.forEach(user => {
                    userMap[user.id] = user;
                });

                console.log('üìã Mapas creados - Estudiantes:', Object.keys(studentMap).length, 'Motivos:', Object.keys(reasonMap).length, 'Usuarios:', Object.keys(userMap).length);

                // Llenar la tabla
                const tbody = document.querySelector('#historyTable tbody');
                tbody.innerHTML = '';
                
                authorizations.forEach(record => {
                    const student = studentMap[record.estudiante_id];
                    const reason = reasonMap[record.motivo_id];
                    const user = userMap[record.usuario_autorizador_id];

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${student ? `${sanitizeHtml(student.nombre)} ${sanitizeHtml(student.apellidos)}` : 'Estudiante no encontrado'}</td>
                        <td>${student?.grado?.nombre ? sanitizeHtml(student.grado.nombre) : 'Grado no encontrado'}</td>
                        <td>${reason?.nombre ? sanitizeHtml(reason.nombre) : 'Motivo no encontrado'}</td>
                        <td>${formatDate(record.fecha_salida)}</td>
                        <td>${formatTime(record.hora_salida)}</td>
                        <td>${user?.nombre ? sanitizeHtml(user.nombre) : 'Usuario no encontrado'}</td>
                        <td>
                            <span style="color: ${record.salida_efectiva ? '#2ecc71' : '#f39c12'}">
                                ${record.salida_efectiva ? '‚úÖ Confirmada' : '‚è≥ Pendiente'}
                            </span>
                            ${record.salida_efectiva ? `<br><small style="color: #666;">Hora: ${formatDateTime(record.salida_efectiva)}</small>` : ''}
                            ${record.observaciones ? `<br><small style="color: #666;">Obs: ${sanitizeHtml(record.observaciones)}</small>` : ''}
                        </td>
                    `;
                });

                const currentTime = getColombiaTime();
                showSuccess(`Historial cargado: ${authorizations.length} registros (${currentTime} - Colombia)`);
                console.log('‚úÖ Historial cargado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error general en loadHistory:', error);
                showError('Error al cargar el historial: ' + error.message);
            }
        }

        // Funci√≥n de debug para historial - MEJORADA para Colombia
        async function debugHistory() {
            const debugDiv = document.getElementById('historyDebug');
            const debugContent = document.getElementById('historyDebugContent');
            
            debugDiv.style.display = 'block';
            debugContent.innerHTML = 'üîÑ Analizando datos del historial...';
            
            try {
                console.log('üîß Iniciando debug del historial...');
                
                const todayColombia = getColombiaDate();
                const currentTime = getColombiaTime();
                
                // 1. Contar registros en autorizaciones_salida
                const { data: totalAuth, error: errorAuth } = await supabase
                    .from('autorizaciones_salida')
                    .select('*');
                
                // 2. Contar estudiantes
                const { data: totalStudents, error: errorStudents } = await supabase
                    .from('estudiantes')
                    .select('*');
                
                // 3. Contar usuarios
                const { data: totalUsers, error: errorUsers } = await supabase
                    .from('usuarios')
                    .select('*');

                // 4. Contar motivos
                const { data: totalReasons, error: errorReasons } = await supabase
                    .from('motivos')
                    .select('*');

                // 5. Contar grados
                const { data: totalGrades, error: errorGrades } = await supabase
                    .from('grados')
                    .select('*');
                
                // 6. Verificar autorizaciones recientes
                const { data: todayAuth, error: errorToday } = await supabase
                    .from('autorizaciones_salida')
                    .select('*')
                    .eq('fecha_salida', todayColombia);

                // 7. Verificar √∫ltimas 5 autorizaciones
                const { data: lastAuth, error: errorLast } = await supabase
                    .from('autorizaciones_salida')
                    .select('*')
                    .order('fecha_creacion', { ascending: false })
                    .limit(5);
                
                let html = '<ul style="text-align: left;">';
                html += `<li><strong>üïê Hora actual Colombia:</strong> ${formatDate(todayColombia)} ${currentTime} (UTC-5)</li>`;
                html += `<li><strong>üìä Total autorizaciones:</strong> ${totalAuth?.length || 0} ${errorAuth ? '‚ùå Error: ' + errorAuth.message : '‚úÖ'}</li>`;
                html += `<li><strong>üë®‚Äçüéì Total estudiantes:</strong> ${totalStudents?.length || 0} ${errorStudents ? '‚ùå Error: ' + errorStudents.message : '‚úÖ'}</li>`;
                html += `<li><strong>üë• Total usuarios:</strong> ${totalUsers?.length || 0} ${errorUsers ? '‚ùå Error: ' + errorUsers.message : '‚úÖ'}</li>`;
                html += `<li><strong>üìù Total motivos:</strong> ${totalReasons?.length || 0} ${errorReasons ? '‚ùå Error: ' + errorReasons.message : '‚úÖ'}</li>`;
                html += `<li><strong>üéì Total grados:</strong> ${totalGrades?.length || 0} ${errorGrades ? '‚ùå Error: ' + errorGrades.message : '‚úÖ'}</li>`;
                html += `<li><strong>üìÖ Autorizaciones hoy (${formatDate(todayColombia)}):</strong> ${todayAuth?.length || 0} ${errorToday ? '‚ùå Error: ' + errorToday.message : '‚úÖ'}</li>`;
                html += `<li><strong>üïê √öltimas 5 autorizaciones:</strong> ${lastAuth?.length || 0} ${errorLast ? '‚ùå Error: ' + errorLast.message : '‚úÖ'}</li>`;
                
                if (lastAuth && lastAuth.length > 0) {
                    html += '<li><strong>üìã Detalles de √∫ltimas autorizaciones:</strong><br>';
                    lastAuth.forEach((auth, index) => {
                        const fechaCreacion = auth.fecha_creacion ? formatDateTime(auth.fecha_creacion) : 'N/A';
                        html += `&nbsp;&nbsp;${index + 1}. ID: ${auth.id}, Estudiante ID: ${auth.estudiante_id}, Fecha salida: ${auth.fecha_salida}, Autorizada: ${auth.autorizada ? 'S√≠' : 'No'}, Creada: ${fechaCreacion}<br>`;
                    });
                    html += '</li>';
                }

                // Verificar estructura de datos
                if (totalAuth && totalAuth.length > 0) {
                    const sampleAuth = totalAuth[0];
                    html += '<li><strong>üîç Estructura de autorizaci√≥n (muestra):</strong><br>';
                    html += `&nbsp;&nbsp;Columnas disponibles: ${Object.keys(sampleAuth).join(', ')}<br>`;
                    html += '</li>';
                }
                
                html += '</ul>';
                
                debugContent.innerHTML = html;
                console.log('üîß Debug completado');
                
            } catch (error) {
                console.error('‚ùå Error en debug:', error);
                debugContent.innerHTML = `‚ùå Error en debug: ${error.message}`;
            }
        }

        async function editStudent(id) {
            try {
                const { data: student, error } = await supabase
                    .from('estudiantes')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditingId = id;
                document.getElementById('studentName').value = student.nombre;
                document.getElementById('studentLastName').value = student.apellidos;
                document.getElementById('studentDocument').value = student.documento || '';
                document.getElementById('studentGrade').value = student.grado_id;
                
                openModal('studentModal');
                
            } catch (error) {
                showError('Error al cargar los datos del estudiante: ' + error.message);
            }
        }

        async function deleteStudent(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este estudiante?')) {
                try {
                    const { data, error } = await supabase
                        .from('estudiantes')
                        .update({ activo: false })
                        .eq('id', id);

                    if (error) throw error;

                    await logSecurityEvent('delete', 'Estudiante eliminado', { studentId: id }, true);
                    showSuccess('Estudiante eliminado exitosamente');
                    await loadStudents();
                    
                } catch (error) {
                    await logSecurityEvent('error', 'Error al eliminar estudiante', { error: error.message }, false);
                    showError('Error al eliminar el estudiante: ' + error.message);
                }
            }
        }

        // Funciones similares para otros elementos...
        async function editUser(id) {
            try {
                const { data: user, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditingId = id;
                document.getElementById('userName').value = user.nombre;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userPassword').value = '';
                document.getElementById('userRole').value = user.rol_id;
                
                // Actualizar nota y requerimiento de contrase√±a para edici√≥n
                document.getElementById('passwordNote').textContent = '(dejar vac√≠o para mantener actual)';
                document.getElementById('userPassword').required = false;
                document.getElementById('userPasswordStrength').style.display = 'none';
                
                openModal('userModal');
                
            } catch (error) {
                showError('Error al cargar los datos del usuario: ' + error.message);
            }
        }

        async function deleteUser(id) {
            if (id === currentUser.id) {
                showError('No puedes eliminar tu propio usuario');
                return;
            }
            
            if (confirm('¬øEst√°s seguro de que quieres eliminar este usuario?')) {
                try {
                    const { data, error } = await supabase
                        .from('usuarios')
                        .update({ activo: false })
                        .eq('id', id);

                    if (error) throw error;

                    await logSecurityEvent('delete', 'Usuario eliminado', { userId: id }, true);
                    showSuccess('Usuario eliminado exitosamente');
                    await loadUsers();
                    
                } catch (error) {
                    await logSecurityEvent('error', 'Error al eliminar usuario', { error: error.message }, false);
                    showError('Error al eliminar el usuario: ' + error.message);
                }
            }
        }

        async function editReason(id) {
            try {
                const { data: reason, error } = await supabase
                    .from('motivos')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditingId = id;
                document.getElementById('reasonName').value = reason.nombre;
                document.getElementById('reasonDescription').value = reason.descripcion || '';
                
                openModal('reasonModal');
                
            } catch (error) {
                showError('Error al cargar los datos del motivo: ' + error.message);
            }
        }

        async function deleteReason(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este motivo?')) {
                try {
                    const { data, error } = await supabase
                        .from('motivos')
                        .update({ activo: false })
                        .eq('id', id);

                    if (error) throw error;

                    await logSecurityEvent('delete', 'Motivo eliminado', { reasonId: id }, true);
                    showSuccess('Motivo eliminado exitosamente');
                    await loadReasons();
                    
                } catch (error) {
                    await logSecurityEvent('error', 'Error al eliminar motivo', { error: error.message }, false);
                    showError('Error al eliminar el motivo: ' + error.message);
                }
            }
        }

        async function editGrade(id) {
            try {
                const { data: grade, error } = await supabase
                    .from('grados')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditingId = id;
                document.getElementById('gradeName').value = grade.nombre;
                document.getElementById('gradeLevel').value = grade.nivel;
                
                openModal('gradeModal');
                
            } catch (error) {
                showError('Error al cargar los datos del grado: ' + error.message);
            }
        }

        async function deleteGrade(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este grado?')) {
                try {
                    const { data, error } = await supabase
                        .from('grados')
                        .update({ activo: false })
                        .eq('id', id);

                    if (error) throw error;

                    await logSecurityEvent('delete', 'Grado eliminado', { gradeId: id }, true);
                    showSuccess('Grado eliminado exitosamente');
                    await loadGrades();
                    
                } catch (error) {
                    await logSecurityEvent('error', 'Error al eliminar grado', { error: error.message }, false);
                    showError('Error al eliminar el grado: ' + error.message);
                }
            }
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Timeout de sesi√≥n
        let sessionTimeout;
        const SESSION_TIMEOUT = 1800000; // 30 minutos

        function resetSessionTimeout() {
            clearTimeout(sessionTimeout);
            sessionTimeout = setTimeout(() => {
                alert('Tu sesi√≥n ha expirado por inactividad');
                logout();
            }, SESSION_TIMEOUT);
        }

        // Resetear timeout en actividad del usuario
        document.addEventListener('click', resetSessionTimeout);
        document.addEventListener('keypress', resetSessionTimeout);

        // Prevenir inyecci√≥n de scripts en inputs
        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                // Remover caracteres potencialmente peligrosos
                const dangerousChars = /<|>|&|"|'/g;
                if (dangerousChars.test(e.target.value)) {
                    e.target.value = e.target.value.replace(dangerousChars, '');
                }
            }
        });

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sistema iniciado');
            updateConnectionStatus(false, 'Conectando...');
            
            // Esperar un momento para que Supabase termine de cargar
            setTimeout(() => {
                initSupabase();
            }, 1000);
        });
    </script>
</body>
</html>
                            `;
                        } else {
                            // Fallback si no encuentra el footer
                            confirmButton.outerHTML = `
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                                    <p style="color: white; font-weight: bold; margin: 0;">
                                        ‚úÖ SALIDA CONFIRMADA<br>
                                        <small>Hora: ${colombiaTime} - Vigilante: ${sanitizeHtml(currentUser.nombre)}</small>
                                    </p>
                                </div>
