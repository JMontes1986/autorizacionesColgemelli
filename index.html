<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<!-- HEADERS DE SEGURIDAD MEJORADOS -->
<meta content="default-src 'self' https://cdn.jsdelivr.net https://mbosvnmhnbrslfwlfcxu.supabase.co https://hcaptcha.com https://*.hcaptcha.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://hcaptcha.com https://*.hcaptcha.com; style-src 'self' 'unsafe-inline' https://hcaptcha.com https://*.hcaptcha.com; frame-src https://hcaptcha.com https://*.hcaptcha.com; connect-src 'self' https://mbosvnmhnbrslfwlfcxu.supabase.co https://hcaptcha.com https://*.hcaptcha.com;" http-equiv="X-Content-Security-Policy"/>
<meta content="DENY" http-equiv="X-Frame-Options"/>
<meta content="nosniff" http-equiv="X-Content-Type-Options"/>
<meta content="1; mode=block" http-equiv="X-XSS-Protection"/>
<meta content="strict-origin-when-cross-origin" http-equiv="Referrer-Policy"/>
<meta content="geolocation=(), microphone=(), camera=()" http-equiv="Permissions-Policy"/>
<meta content="noindex, nofollow" name="robots"/>
<title>Sistema de Salidas - Colegio Gemelli</title>
<!-- Supabase CDN para Actualizada desde jsDelivr -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- hCaptcha -->
<script async="" defer="" src="https://hcaptcha.com/1/api.js"></script>
<!-- CryptoJS para cifrado -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
<!-- Chart.js versi√≥n estable -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 1200px;
            width: 95%;
            min-height: 80vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-status.connected {
            background: rgba(46, 204, 113, 0.2);
        }

        .connection-status.disconnected {
            background: rgba(231, 76, 60, 0.2);
        }

        .content {
            padding: 30px;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group label[for="gradeSelect"],
        .form-group label[for="studentSelect"],
        .form-group label[for="reasonSelect"],
        .form-group label[for="exitDate"],
        .form-group label[for="exitTime"] {
            color: #2c3e50;
            font-size: 16px;
        }

        .form-group select:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        #passwordNote {
            font-weight: normal;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* ========================================
           RESPONSIVE DESIGN MEJORADO
           ======================================== */

        /* Mobile First - Pantallas peque√±as (hasta 480px) */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                width: 100%;
                min-height: 100vh;
                border-radius: 0;
                margin: 0;
            }

            .header {
                padding: 15px 10px;
                position: relative;
            }

            .header h1 {
                font-size: 1.4em;
                margin-bottom: 5px;
            }

            .header .subtitle {
                font-size: 0.9em;
                line-height: 1.2;
            }

            .connection-status {
                position: static;
                display: block;
                text-align: center;
                margin: 10px 0 0 0;
                padding: 5px 10px;
                font-size: 12px;
            }

            .logout-btn {
                position: static;
                display: block;
                width: 100%;
                margin-top: 10px;
                padding: 8px 15px;
                font-size: 14px;
            }

            .content {
                padding: 15px;
            }

            .login-form {
                max-width: 100%;
                margin: 0;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group input, 
            .form-group select, 
            .form-group textarea {
                font-size: 16px; /* Evita zoom en iOS */
                padding: 14px;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
                padding: 14px 20px;
                font-size: 16px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-top: 15px;
            }

            .nav-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .nav-buttons .btn {
                width: 100%;
                margin: 0;
                padding: 12px;
                font-size: 14px;
            }

            .section {
                padding: 15px;
                margin-top: 15px;
            }

            .section h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }

            /* Tablas responsive */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }

            .table {
                min-width: 600px;
                font-size: 14px;
            }

            .table th, .table td {
                padding: 8px 6px;
                white-space: nowrap;
            }

            .table .btn {
                width: auto;
                padding: 6px 10px;
                font-size: 12px;
                margin: 2px;
            }

            /* Verificaci√≥n cards responsive */
            .verification-card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .verification-card h3 {
                font-size: 1.1em;
                margin-bottom: 15px;
            }

            .verification-card-content {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
            }

            .verification-card-info p {
                font-size: 14px;
            }

            .verification-card .btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }

            /* Modales responsive */
            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 20px;
                max-height: 95vh;
            }

            .modal-content h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }

            /* Search box responsive */
            .search-box {
                font-size: 16px;
                padding: 12px;
            }

            /* Security stats responsive */
            .security-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card .number {
                font-size: 24px;
            }

            /* Filters section responsive */
            .filters-section {
                padding: 15px;
            }

            .filters-section .grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Captcha responsive */
            .captcha-container {
                margin: 10px 0;
                overflow: hidden;
            }

            /* Security indicator responsive */
            .security-indicator {
                position: fixed;
                bottom: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
                border-radius: 10px;
                font-size: 11px;
                padding: 8px 12px;
            }

            /* Rate limit warning responsive */
            .rate-limit-warning {
                position: fixed;
                top: 10px;
                left: 10px;
                right: 10px;
                text-align: center;
                font-size: 14px;
                padding: 12px;
            }
        }

        /* Tablets - Pantallas medianas (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                width: 95%;
                margin: 20px auto;
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.7em;
            }

            .connection-status {
                top: 15px;
                left: 15px;
                font-size: 13px;
            }

            .logout-btn {
                top: 15px;
                right: 15px;
                padding: 8px 16px;
            }

            .content {
                padding: 20px;
            }

            .login-form {
                max-width: 400px;
            }

            .grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 18px;
            }

            .nav-buttons {
                justify-content: center;
                gap: 12px;
            }

            .nav-buttons .btn {
                flex: 1;
                min-width: 120px;
                max-width: 200px;
            }

            .section {
                padding: 20px;
            }

            /* Tablas en tablet */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table {
                font-size: 14px;
            }

            .table th, .table td {
                padding: 10px 8px;
            }

            /* Verificaci√≥n cards en tablet */
            .verification-card {
                padding: 20px;
            }

            .verification-card-content {
                grid-template-columns: 1fr 1fr;
                gap: 18px;
            }

            /* Security stats en tablet */
            .security-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            /* Modales en tablet */
            .modal-content {
                width: 90%;
                margin: 5% auto;
                padding: 25px;
            }
        }

        /* Desktop peque√±o - Pantallas medianas-grandes (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                width: 90%;
                max-width: 1000px;
            }

            .nav-buttons {
                justify-content: center;
                gap: 15px;
            }

            .grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }

            .security-stats {
                grid-template-columns: repeat(4, 1fr);
            }

            .verification-card-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Desktop grande - Pantallas grandes (1025px+) */
        @media (min-width: 1025px) {
            .container {
                max-width: 1200px;
            }

            .grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }

            .security-stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Orientaci√≥n landscape en m√≥viles */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.2em;
                margin-bottom: 0;
            }

            .header .subtitle {
                font-size: 0.8em;
            }

            .content {
                padding: 10px;
            }

            .modal-content {
                max-height: 90vh;
                margin: 2% auto;
            }

            .verification-card {
                padding: 10px;
            }

            .verification-card-content {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                padding: 10px;
            }
        }

        /* Estilos espec√≠ficos para touch devices */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px; /* Tama√±o m√≠nimo recomendado para touch */
                padding: 12px 20px;
            }

            .table .btn {
                min-height: 36px;
                padding: 8px 12px;
            }

            .form-group input, 
            .form-group select, 
            .form-group textarea {
                min-height: 44px;
            }

            /* Hover states no aplicables en touch */
            .btn:hover {
                transform: none;
            }

            .table tbody tr:hover {
                background: transparent;
            }
        }

        /* Mejoras adicionales para dispositivos m√≥viles */
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Scroll suave en contenedores */
        .table-container {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Mejor UX para forms en m√≥vil */
        @media (max-width: 480px) {
            /* Evitar zoom autom√°tico en iOS */
            input[type="email"],
            input[type="password"],
            input[type="text"],
            input[type="tel"],
            input[type="url"],
            input[type="search"],
            textarea,
            select {
                font-size: 16px !important;
                transform: scale(1);
            }

            /* Mejorar spacing en formularios */
            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            /* Hacer los selects m√°s f√°ciles de usar en m√≥vil */
            select {
                background-size: 20px;
                padding-right: 35px;
            }

            /* Mejorar la visualizaci√≥n de mensajes de error/√©xito */
            .alert {
                font-size: 14px;
                padding: 12px;
                margin-bottom: 15px;
                border-radius: 6px;
            }

            /* Optimizar espaciado de botones */
            .btn {
                letter-spacing: 0.5px;
                font-weight: 600;
            }

            /* Mejorar el modal en pantallas muy peque√±as */
            .modal-content {
                border-radius: 12px;
                max-width: 100%;
            }

            /* Stack navigation buttons verticalmente */
            .nav-buttons {
                display: flex;
                flex-direction: column;
                align-items: stretch;
            }

            /* Mejorar cards de verificaci√≥n para pantallas peque√±as */
            .verification-card {
                border-radius: 12px;
                font-size: 14px;
            }

            .verification-card h3 {
                font-size: 1.0em;
                line-height: 1.2;
            }

            /* Optimizar indicadores de seguridad */
            .password-strength {
                height: 4px;
                margin-top: 4px;
            }

            /* Mejorar captcha container */
            .captcha-container iframe {
                max-width: 100%;
                height: auto;
            }
        }

        /* Pantallas extra peque√±as (320px y menor) */
        @media (max-width: 320px) {
            .header h1 {
                font-size: 1.2em;
            }

            .header .subtitle {
                font-size: 0.8em;
            }

            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }

            .verification-card {
                padding: 12px;
            }

            .verification-card-content {
                padding: 12px;
                gap: 12px;
            }

            .modal-content {
                padding: 15px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-card .number {
                font-size: 20px;
            }
        }

        /* Mejoras para tablets en orientaci√≥n portrait */
        @media (min-width: 481px) and (max-width: 768px) and (orientation: portrait) {
            .nav-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .verification-card-content {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        /* Mejoras para tablets en orientaci√≥n landscape */
        @media (min-width: 481px) and (max-width: 1024px) and (orientation: landscape) {
            .nav-buttons {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 12px;
            }

            .nav-buttons .btn {
                flex: 0 1 auto;
                min-width: 140px;
            }
        }

        /* Optimizaciones espec√≠ficas para iPhone SE y dispositivos similares */
        @media (max-width: 375px) and (max-height: 667px) {
            .container {
                min-height: 100vh;
            }

            .header {
                padding: 12px 10px;
            }

            .content {
                padding: 12px;
            }

            .section {
                padding: 12px;
            }
        }

        /* Mejoras para accesibilidad t√°ctil */
        @media (pointer: coarse) {
            /* √Åreas de toque m√°s grandes */
            .btn {
                min-height: 48px;
                min-width: 48px;
            }

            .close {
                font-size: 32px;
                padding: 8px;
                min-width: 48px;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Enlaces y botones m√°s espaciados */
            .table .btn {
                margin: 4px 2px;
                min-height: 40px;
            }

            /* Inputs m√°s grandes para mejor usabilidad */
            .form-group input,
            .form-group select,
            .form-group textarea {
                min-height: 48px;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .table-container {
                background: #2c3e50;
            }

            .modal-content {
                background: #34495e;
                color: white;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                background: #34495e;
                color: white;
                border-color: #555;
            }
        }

        /* Mejoras de rendimiento para animaciones en m√≥vil */
        @media (max-width: 768px) {
            .verification-card,
            .btn,
            .modal-content {
                will-change: auto;
            }

            /* Reducir animaciones complejas en m√≥vil */
            .btn:hover {
                transform: translateY(-1px);
            }
        }

        /* Mejoras espec√≠ficas para scroll horizontal en tablas */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: white;
            position: relative;
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .table {
            width: 100%;
            min-width: 800px; /* Ancho m√≠nimo para evitar que se comprima demasiado */
            border-collapse: collapse;
            margin: 0;
            background: white;
        }

        /* Indicadores de scroll mejorados */
        .table-wrapper::before,
        .table-wrapper::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 20px;
            pointer-events: none;
            z-index: 2;
            transition: opacity 0.3s ease;
        }

        .table-wrapper::before {
            left: 0;
            background: linear-gradient(to right, rgba(255,255,255,0.9), transparent);
            opacity: 0;
        }

        .table-wrapper::after {
            right: 0;
            background: linear-gradient(to left, rgba(255,255,255,0.9), transparent);
        }

        .table-wrapper.has-scroll-left::before {
            opacity: 1;
        }

        .table-wrapper.has-scroll-right::after {
            opacity: 1;
        }

        /* Estilos para el dashboard */
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .dashboard-card h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pending-exits {
            border-left-color: #2ecc71;
        }

        .confirmed-exits {
            border-left-color: #3498db;
        }

        .total-today {
            border-left-color: #f39c12;
        }

        .recent-activity {
            border-left-color: #e74c3c;
        }

        /* Lista de estudiantes recientes */
        .recent-students {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid transparent;
        }

        .student-item.pending {
            border-left-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .student-item.confirmed {
            border-left-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .student-details {
            font-size: 0.85em;
            color: #666;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background: #2ecc71;
            color: white;
        }

        .status-confirmed {
            background: #3498db;
            color: white;
        }

        /* Responsive para dashboard */
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .dashboard-card {
                padding: 20px;
            }

            .chart-container {
                height: 250px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .table {
                min-width: 600px;
            }
        }

        @media (max-width: 480px) {
            .dashboard-card {
                padding: 15px;
            }

            .chart-container {
                height: 200px;
            }

            .table {
                min-width: 500px;
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 6px 4px;
            }
        }

        /* Scroll hint para tablas */
        .scroll-hint {
            display: none;
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 8px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        @media (max-width: 768px) {
            .scroll-hint {
                display: block;
            }
        }

        /* Mejoras para focus states en elementos interactivos */
        .btn:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* Estilos para el bot√≥n de scroll to top m√≥vil */
        #mobileQuickActions {
            display: none;
        }

        @media (max-width: 480px) {
            #mobileQuickActions {
                display: flex;
            }
        }

        /* Mejoras de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .btn:hover {
                transform: none;
            }

            .verification-card {
                transition: none;
            }

            /* Desactivar scroll suave en reduced motion */
            html {
                scroll-behavior: auto;
            }
        }

        /* Alto contraste */
        @media (prefers-contrast: high) {
            .btn {
                border: 2px solid;
            }

            .form-group input, 
            .form-group select, 
            .form-group textarea {
                border: 2px solid #333;
            }

            .verification-card {
                border: 2px solid;
            }

            .table-container {
                border: 2px solid #333;
            }
        }

        /* Mejoras para pantallas de alta densidad */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .btn {
                border-width: 0.5px;
            }
            
            .table {
                border-collapse: separate;
                border-spacing: 0;
            }
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #2ecc71;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* Estilos espec√≠ficos para vigilancia */
        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        /* Mejoras para los botones de navegaci√≥n en vigilancia */
        @media (max-width: 768px) {
            .nav-buttons .btn {
                font-size: 14px;
                padding: 10px 15px;
                margin: 3px;
            }
        }

        @media (max-width: 480px) {
            .nav-buttons {
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .nav-buttons .btn {
                width: 100%;
                margin: 0;
                font-size: 13px;
                padding: 12px;
            }
        }

        .dashboard {
            display: none;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .section {
            display: none;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .table tbody tr:hover {
            background: #f5f5f5;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .verification-card {
            text-align: center;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .verification-card h3 {
            font-size: 1.4em;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .verification-card-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: left;
            margin: 20px 0;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .verification-card-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .verification-card-info p {
            margin: 0;
            font-size: 15px;
            line-height: 1.4;
        }

        .verification-card-info strong {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .verification-card-info .info-value {
            font-size: 16px;
            font-weight: 500;
        }

        .verification-card-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .verification-card-footer p {
            margin: 8px 0;
            font-size: 15px;
        }

        .verification-card-obs {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .verification-card-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .verification-card {
                padding: 20px;
            }
        }

        .verification-card.authorized {
            border-left-color: #2ecc71;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .verification-card.verified {
            border-left-color: #3498db;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .verification-card.not-authorized {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 18px;
            margin-bottom: 20px;
        }

        /* Estilos para la secci√≥n de seguridad */
        .security-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters-section .form-group {
            margin-bottom: 15px;
        }

        .log-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .log-type.login {
            background: #2ecc71;
            color: white;
        }

        .log-type.logout {
            background: #95a5a6;
            color: white;
        }

        .log-type.create {
            background: #3498db;
            color: white;
        }

        .log-type.update {
            background: #f39c12;
            color: white;
        }

        .log-type.delete {
            background: #e74c3c;
            color: white;
        }

        .log-type.error {
            background: #c0392b;
            color: white;
        }

        /* Estilos para rate limiting */
        .rate-limit-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            z-index: 9999;
        }

        /* Password strength indicator */
        .password-strength {
            margin-top: 5px;
            height: 5px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .password-strength.weak {
            background: #e74c3c;
            width: 33%;
        }

        .password-strength.medium {
            background: #f39c12;
            width: 66%;
        }

        .password-strength.strong {
            background: #2ecc71;
            width: 100%;
        }

        /* Estilos para CAPTCHA */
        .captcha-container {
            margin: 15px 0;
            display: flex;
            justify-content: center;
        }

        .security-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .security-indicator.secure {
            background: rgba(46, 204, 113, 0.9);
        }

        .security-indicator.warning {
            background: rgba(243, 156, 18, 0.9);
        }

        /* Estilos para input validation */
        .input-secure {
            border-color: #2ecc71 !important;
            box-shadow: 0 0 5px rgba(46, 204, 113, 0.3);
        }

        .input-warning {
            border-color: #f39c12 !important;
            box-shadow: 0 0 5px rgba(243, 156, 18, 0.3);
        }

        .input-error {
            border-color: #e74c3c !important;
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                width: 100%;
                margin: 10px;
                border-radius: 10px;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üè´ Colegio Gemelli</h1>
<div class="subtitle">Sistema de Control de Salidas Estudiantiles - Versi√≥n Segura</div>
<div class="connection-status" id="connectionStatus">
<span id="connectionIcon">üî¥</span>
<span id="connectionText">Verificando conexi√≥n...</span>
</div>
<button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
</div>
<div class="content">
<!-- Rate Limit Warning -->
<div class="rate-limit-warning" id="rateLimitWarning">
‚ö†Ô∏è Demasiados intentos. Por favor espera antes de intentar de nuevo.
</div>
<!-- Security Indicator -->
<div class="security-indicator secure" id="securityIndicator">
üîí Conexi√≥n Segura
</div>
<!-- Login Form -->
<div class="login-form" id="loginSection">
<div class="form-group">
<label for="email">Email:</label>
<input autocomplete="username" id="email" maxlength="100" oninput="validateEmailInput(this)" placeholder="sistemas@colgemelli.edu.co" type="email"/>
</div>
<div class="form-group">
<label for="password">Contrase√±a:</label>
<input autocomplete="current-password" id="password" maxlength="50" oninput="validatePasswordInput(this)" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password"/>
<div class="password-strength" id="passwordStrength" style="display: none;"></div>
</div>
<!-- CAPTCHA -->
<div class="captcha-container">
<div class="h-captcha" data-sitekey="10000000-ffff-ffff-ffff-000000000001"></div>
</div>
<button class="btn" id="loginBtn" onclick="login()" style="width: 100%;">Iniciar Sesi√≥n</button>
<button class="btn btn-secondary" onclick="testConnection()" style="width: 100%; margin-top: 10px;">üîÑ Probar Conexi√≥n</button>
<div class="alert alert-error" id="loginError" style="display: none; margin-top: 15px;"></div>
<div class="alert alert-success" id="loginInfo" style="display: none; margin-top: 15px;"></div>
</div>
<!-- Dashboard -->
<div class="dashboard" id="dashboard">
<div class="nav-buttons" id="navButtons">
<!-- Botones se cargar√°n din√°micamente seg√∫n el rol -->
</div>
<!-- Secci√≥n para Autorizar Salidas -->
<div class="section" id="authorizeSectionDiv">
<h2>‚úÖ Autorizar Salida de Estudiante</h2>
<form id="authorizeForm">
<div class="grid">
<div class="form-group">
<label for="gradeSelect">1. Seleccionar Grado: *</label>
<select id="gradeSelect" onchange="loadStudentsByGrade()" required="">
<option value="">Seleccionar grado primero...</option>
</select>
</div>
<div class="form-group">
<label for="studentSelect">2. Seleccionar Estudiante: *</label>
<select disabled="" id="studentSelect" required="">
<div id="authStudentImage" style="text-align:center; margin:10px 0;">
</div>
<option value="">Primero selecciona un grado...</option>
</select>
</div>
<div class="form-group">
<label for="reasonSelect">3. Motivo: *</label>
<select id="reasonSelect" required="">
<option value="">Seleccionar motivo...</option>
</select>
</div>
<div class="form-group">
<label for="exitDate">4. Fecha de Salida: *</label>
<input id="exitDate" required="" type="date"/>
</div>
<div class="form-group">
<label for="exitTime">5. Hora de Salida: *</label>
<input id="exitTime" required="" type="time"/>
</div>
</div>
<div class="form-group">
<label for="observations">Observaciones adicionales:</label>
<textarea id="observations" maxlength="500" oninput="validateTextInput(this)" placeholder="Observaciones opcionales sobre la salida..." rows="3"></textarea>
</div>
<button class="btn btn-success" style="font-size: 18px; padding: 15px 30px;" type="submit">‚úÖ Autorizar Salida</button>
</form>
</div>
<!-- Secci√≥n para Verificar Salidas (Vigilante) -->
<div class="section" id="verifySectionDiv">
<h2>üîç Control de Salidas - Vigilancia</h2>
<div class="nav-buttons">
<button class="btn btn-success" onclick="loadPendingExits()">üîÑ Actualizar Lista</button>
<button class="btn btn-secondary" onclick="toggleSearch()">üîç Buscar Estudiante</button>
<button class="btn btn-warning" onclick="showMyConfirmedExits()">üëÅÔ∏è Ver Mis Confirmaciones</button>
</div>
<!-- B√∫squeda manual (inicialmente oculta) -->
<div id="searchSection" style="display: none; margin-top: 20px;">
<h3 style="color: #2c3e50; margin-bottom: 15px;">üîç B√∫squeda Manual de Estudiante</h3>
<input class="search-box" id="studentSearch" maxlength="100" oninput="validateSearchInput(this)" placeholder="Buscar estudiante espec√≠fico por nombre..." type="text"/>
<div id="searchResult"></div>
</div>
<!-- Secci√≥n de salidas confirmadas por el vigilante (inicialmente oculta) -->
<div id="myConfirmedSection" style="display: none; margin-top: 20px;">
<h3 style="color: #2c3e50; margin: 20px 0 15px 0;">‚úÖ Salidas Confirmadas por M√≠ Hoy</h3>
<div id="myConfirmedList">
<div class="card" style="text-align: center; padding: 30px;">
<p style="color: #666;">Cargando salidas confirmadas...</p>
</div>
</div>
</div>
<!-- Lista de estudiantes con salidas pendientes -->
<div id="pendingExitsSection">
<h3 style="color: #2c3e50; margin: 20px 0 15px 0;">üìã Estudiantes con Salidas Pendientes para Hoy</h3>
<div id="pendingExitsList">
<!-- Ejemplo de tarjeta con foto -->
<div class="verification-card">
<img alt="Foto estudiante" src="https://via.placeholder.com/120" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; margin-bottom: 10px;"/>
<h3>Nombre Estudiante</h3>
<div class="verification-card-content">
<div class="verification-card-info">
<p><strong>Grado:</strong> 10</p>
<p><strong>Motivo:</strong> Cita m√©dica</p>
<p><strong>Hora:</strong> 10:30 am</p>
</div>
</div>
<button class="btn btn-success">‚úÖ Confirmar Salida</button>
</div>
<div class="card" style="text-align: center; padding: 30px;">
<p style="color: #666;">Cargando estudiantes con salidas pendientes...</p>
</div>
</div>
</div>
</div>
<!-- Secci√≥n de Administraci√≥n -->
<div class="section" id="adminSectionDiv">
<h2>‚öôÔ∏è Panel de Administraci√≥n</h2>
<div class="nav-buttons">
<button class="btn" onclick="showAdminSection('students')">Gestionar Estudiantes</button>
<button class="btn" onclick="showAdminSection('users')">Gestionar Usuarios</button>
<button class="btn" onclick="showAdminSection('reasons')">Gestionar Motivos</button>
<button class="btn" onclick="showAdminSection('grades')">Gestionar Grados</button>
<button class="btn btn-warning" onclick="showAdminSection('security')">üîí Seguridad y Logs</button>
</div>
<div class="admin-subsection" id="adminStudents" style="display: none;">
<h3>üë®‚Äçüéì Gesti√≥n de Estudiantes</h3>
<button class="btn btn-success" onclick="openModal('studentModal')">Agregar Estudiante</button>
<div class="table-wrapper">
<table class="table" id="studentsTable">
<thead>
<tr>
<th style="min-width: 120px;">Nombre</th>
<th style="min-width: 120px;">Apellidos</th>
<th style="min-width: 100px;">Documento</th>
<th style="min-width: 120px;">Grado</th>
<th style="min-width: 160px;">Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="admin-subsection" id="adminUsers" style="display: none;">
<h3>üë• Gesti√≥n de Usuarios</h3>
<button class="btn btn-success" onclick="openModal('userModal')">Agregar Usuario</button>
<div class="table-wrapper">
<table class="table" id="usersTable">
<thead>
<tr>
<th style="min-width: 120px;">Nombre</th>
<th style="min-width: 200px;">Email</th>
<th style="min-width: 120px;">Rol</th>
<th style="min-width: 80px;">Estado</th>
<th style="min-width: 160px;">Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="admin-subsection" id="adminReasons" style="display: none;">
<h3>üìù Gesti√≥n de Motivos</h3>
<button class="btn btn-success" onclick="openModal('reasonModal')">Agregar Motivo</button>
<div class="table-wrapper">
<table class="table" id="reasonsTable">
<thead>
<tr>
<th style="min-width: 120px;">Nombre</th>
<th style="min-width: 200px;">Descripci√≥n</th>
<th style="min-width: 80px;">Estado</th>
<th style="min-width: 160px;">Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="admin-subsection" id="adminGrades" style="display: none;">
<h3>üéì Gesti√≥n de Grados</h3>
<button class="btn btn-success" onclick="openModal('gradeModal')">Agregar Grado</button>
<div class="table-wrapper">
<table class="table" id="gradesTable">
<thead>
<tr>
<th style="min-width: 120px;">Nombre</th>
<th style="min-width: 100px;">Nivel</th>
<th style="min-width: 80px;">Estado</th>
<th style="min-width: 160px;">Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<!-- Secci√≥n de Seguridad -->
<div class="admin-subsection" id="adminSecurity" style="display: none;">
<h3>üîí Seguridad y Logs de Auditor√≠a</h3>
<div class="security-stats">
<div class="stat-card">
<h4>Accesos Hoy</h4>
<div class="number" id="todayLogins">0</div>
</div>
<div class="stat-card">
<h4>Cambios Hoy</h4>
<div class="number" id="todayChanges">0</div>
</div>
<div class="stat-card">
<h4>Intentos Fallidos</h4>
<div class="number" id="failedAttempts">0</div>
</div>
<div class="stat-card">
<h4>Usuarios Activos</h4>
<div class="number" id="activeUsers">0</div>
</div>
</div>
<div class="filters-section">
<h4>Filtros de Logs</h4>
<div class="grid">
<div class="form-group">
<label for="logDateFrom">Fecha Desde:</label>
<input id="logDateFrom" type="date"/>
</div>
<div class="form-group">
<label for="logDateTo">Fecha Hasta:</label>
<input id="logDateTo" type="date"/>
</div>
<div class="form-group">
<label for="logType">Tipo de Acci√≥n:</label>
<select id="logType">
<option value="">Todos</option>
<option value="login">Inicio de Sesi√≥n</option>
<option value="logout">Cierre de Sesi√≥n</option>
<option value="create">Creaci√≥n</option>
<option value="update">Actualizaci√≥n</option>
<option value="delete">Eliminaci√≥n</option>
<option value="error">Error</option>
</select>
</div>
<div class="form-group">
<label for="logUser">Usuario:</label>
<select id="logUser">
<option value="">Todos</option>
</select>
</div>
</div>
<button class="btn" onclick="loadSecurityLogs()">üîç Buscar Logs</button>
<button class="btn btn-secondary" onclick="exportLogs()">üì• Exportar Logs</button>
</div>
<div class="table-wrapper">
<table class="table" id="securityLogsTable">
<thead>
<tr>
<th style="min-width: 140px;">Fecha/Hora</th>
<th style="min-width: 120px;">Usuario</th>
<th style="min-width: 80px;">Tipo</th>
<th style="min-width: 140px;">Acci√≥n</th>
<th style="min-width: 200px;">Detalles</th>
<th style="min-width: 100px;">IP</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
<!-- Secci√≥n de Dashboard (NUEVA) -->
<div class="section" id="dashboardSectionDiv">
<h2>üìä Dashboard de Salidas</h2>
<div class="dashboard-container">
<!-- Estad√≠sticas Generales -->
<div class="dashboard-card">
<h3>üìà Estad√≠sticas de Hoy</h3>
<div class="stats-grid">
<div class="stat-item pending-exits">
<div class="stat-number" id="dashPendingCount">0</div>
<div class="stat-label">Pendientes</div>
</div>
<div class="stat-item confirmed-exits">
<div class="stat-number" id="dashConfirmedCount">0</div>
<div class="stat-label">Confirmadas</div>
</div>
<div class="stat-item total-today">
<div class="stat-number" id="dashTotalCount">0</div>
<div class="stat-label">Total Hoy</div>
</div>
<div class="stat-item recent-activity">
<div class="stat-number" id="dashRecentCount">0</div>
<div class="stat-label">√öltima Hora</div>
</div>
</div>
</div>
<!-- Gr√°fico de Estado de Salidas -->
<div class="dashboard-card">
<h3>üü¢üîµ Estado de Salidas</h3>
<div class="chart-container">
<canvas id="statusChart"></canvas>
<div id="statusChartFallback" style="display: none; text-align: center; padding: 20px; color: #666;">
<p>üìä Cargando gr√°fico...</p>
<p><small>Si no aparece, revisa que Chart.js est√© cargado</small></p>
</div>
</div>
</div>
<!-- Gr√°fico por Grados -->
<div class="dashboard-card">
<h3>üéì Salidas por Grado</h3>
<div class="chart-container">
<canvas id="gradeChart"></canvas>
<div id="gradeChartFallback" style="display: none; text-align: center; padding: 20px; color: #666;">
<p>üìä Cargando gr√°fico...</p>
</div>
</div>
</div>
<!-- Actividad Reciente -->
<div class="dashboard-card">
<h3>‚è∞ Actividad Reciente</h3>
<div class="recent-students" id="recentActivity">
<p style="text-align: center; color: #666; padding: 20px;">Cargando actividad reciente...</p>
</div>
</div>
<!-- Gr√°fico de Motivos -->
<div class="dashboard-card">
<h3>üìù Motivos de Salida</h3>
<div class="chart-container">
<canvas id="reasonChart"></canvas>
<div id="reasonChartFallback" style="display: none; text-align: center; padding: 20px; color: #666;">
<p>üìä Cargando gr√°fico...</p>
</div>
</div>
</div>
<!-- Timeline de Salidas -->
<div class="dashboard-card">
<h3>‚è±Ô∏è Timeline de Salidas Hoy</h3>
<div class="chart-container">
<canvas id="timelineChart"></canvas>
<div id="timelineChartFallback" style="display: none; text-align: center; padding: 20px; color: #666;">
<p>üìä Cargando gr√°fico...</p>
</div>
</div>
</div>
</div>
<!-- Controles del Dashboard -->
<div class="nav-buttons" style="margin-top: 20px;">
<button class="btn btn-success" onclick="refreshDashboard()">üîÑ Actualizar Dashboard</button>
<button class="btn btn-secondary" onclick="exportDashboardData()">üì• Exportar Datos</button>
<button class="btn" onclick="showDetailedView()">üìã Vista Detallada</button>
<button class="btn btn-warning" onclick="debugDashboard()" style="font-size: 12px;">üîß Debug</button>
<button class="btn" onclick="forceReloadCharts()" style="font-size: 12px; background: #e67e22;">üîÑ Recargar Gr√°ficos</button>
</div>
<div id="chartjsStatus" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; text-align: center; display: none;">
<p style="margin: 0; color: #666;"><strong>Estado Chart.js:</strong> <span id="chartjsStatusText">Verificando...</span></p>
</div>
</div>
<!-- Secci√≥n de Historial -->
<div class="section" id="historySectionDiv">
<h2>üìã Historial de Autorizaciones</h2>
<div class="form-group">
<input id="historyDate" onchange="loadHistory()" type="date"/>
<button class="btn" onclick="loadHistory()">Filtrar por Fecha</button>
<button class="btn btn-secondary" onclick="loadHistory(true)">Ver Todo el Historial</button>
<button class="btn" onclick="debugHistory()" style="background: #e67e22;">üîç Debug Historial</button>
</div>
<div id="historyDebug" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
<h4>üîß Informaci√≥n de Debug:</h4>
<div id="historyDebugContent"></div>
</div>
<div class="table-wrapper">
<table class="table" id="historyTable">
<thead>
<tr>
<th style="min-width: 150px;">Estudiante</th>
<th style="min-width: 120px;">Grado</th>
<th style="min-width: 140px;">Motivo</th>
<th style="min-width: 110px;">Fecha Salida</th>
<th style="min-width: 100px;">Hora Salida</th>
<th style="min-width: 140px;">Autorizado por</th>
<th style="min-width: 160px;">Estado</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="scroll-hint" style="text-align: center; font-size: 12px; color: #666; padding: 8px; background: #f8f9fa; border-top: 1px solid #ddd; border-radius: 0 0 8px 8px;">
üí° Desliza horizontalmente para ver toda la informaci√≥n
</div>
</div>
</div>
</div>
</div>
<!-- Modals -->
<div class="modal" id="studentModal">
<div class="modal-content">
<span class="close" onclick="closeModal('studentModal')">√ó</span>
<h2>Agregar/Editar Estudiante</h2>
<form id="studentForm">
<div class="form-group">
<label for="uploadStudentPhoto">Subir Foto:</label>
<input accept="image/jpeg,image/png,image/gif" id="uploadStudentPhoto" onchange="handleImageUpload(event)" type="file"/>
<img alt="Foto del estudiante" id="studentPhotoPreview" src="https://via.placeholder.com/120" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; display: block; margin: 10px auto; border: 2px solid #ccc;"/>
<input id="studentPhotoBase64" type="hidden"/>
<small>Formatos permitidos: JPG, PNG, GIF. M√°ximo 2MB.</small>
</div>
<div class="form-group">
<label>Nombre: *</label>
<input id="studentName" maxlength="50" oninput="validateNameInput(this)" pattern="[A-Za-z√Ä-√ø\s]{2,50}" required="" type="text"/>
</div>
<div class="form-group">
<label>Apellidos: *</label>
<input id="studentLastName" maxlength="50" oninput="validateNameInput(this)" pattern="[A-Za-z√Ä-√ø\s]{2,50}" required="" type="text"/>
</div>
<div class="form-group">
<label>Documento:</label>
<input id="studentDocument" maxlength="20" oninput="validateDocumentInput(this)" pattern="[0-9]{6,20}" type="text"/>
</div>
<div class="form-group">
<label>Grado: *</label>
<select id="studentGrade" required="">
<option value="">Seleccionar grado...</option>
</select>
</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('studentModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<div class="modal" id="userModal">
<div class="modal-content">
<span class="close" onclick="closeModal('userModal')">√ó</span>
<h2>Agregar/Editar Usuario</h2>
<form id="userForm">
<div class="form-group">
<label>Nombre: *</label>
<input id="userName" maxlength="50" oninput="validateNameInput(this)" pattern="[A-Za-z√Ä-√ø\s]{2,50}" required="" type="text"/>
</div>
<div class="form-group">
<label>Email: *</label>
<input id="userEmail" maxlength="100" oninput="validateEmailInput(this)" required="" type="email"/>
</div>
<div class="form-group">
<label>Contrase√±a: <span id="passwordNote">(dejar vac√≠o para mantener actual)</span></label>
<input id="userPassword" maxlength="50" oninput="validatePasswordInput(this)" onkeyup="checkPasswordStrength()" type="password"/>
<div class="password-strength" id="userPasswordStrength" style="display: none;"></div>
</div>
<div class="form-group">
<label>Rol: *</label>
<select id="userRole" required="">
<option value="">Seleccionar rol...</option>
</select>
</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('userModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<div class="modal" id="reasonModal">
<div class="modal-content">
<span class="close" onclick="closeModal('reasonModal')">√ó</span>
<h2>Agregar/Editar Motivo</h2>
<form id="reasonForm">
<div class="form-group">
<label>Nombre: *</label>
<input id="reasonName" maxlength="50" oninput="validateTextInput(this)" required="" type="text"/>
</div>
<div class="form-group">
<label>Descripci√≥n:</label>
<textarea id="reasonDescription" maxlength="200" oninput="validateTextInput(this)" rows="3"></textarea>
</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('reasonModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<div class="modal" id="gradeModal">
<div class="modal-content">
<span class="close" onclick="closeModal('gradeModal')">√ó</span>
<h2>Agregar/Editar Grado</h2>
<form id="gradeForm">
<div class="form-group">
<label>Nombre: *</label>
<input id="gradeName" maxlength="20" oninput="validateTextInput(this)" required="" type="text"/>
</div>
<div class="form-group">
<label>Nivel: *</label>
<select id="gradeLevel" required="">
<option value="">Seleccionar nivel...</option>
<option value="Primaria">Primaria</option>
<option value="Bachillerato">Bachillerato</option>
</select>
</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('gradeModal')" type="button">Cancelar</button>
</form>
</div>
</div>


<script>
  async function cargarVerificaciones() {
    const contenedor = document.getElementById("verificaciones");
    contenedor.innerHTML = "";

    const { data: salidas, error: errorSalidas } = await supabase
      .from("autorizaciones")
      .select("documento, motivo, hora");

    if (errorSalidas) {
      console.error("Error cargando salidas:", errorSalidas.message);
      return;
    }

    for (const salida of salidas) {
      const { data: estudiante, error: errorEst } = await supabase
        .from("estudiantes")
        .select("nombre, grado, foto_url")
        .eq("documento", salida.documento)
        .single();

      const div = document.createElement("div");
      div.className = "verificacion-card";
      div.style = "border:1px solid #ddd; padding:10px; border-radius:10px; margin:10px 0; text-align:center;";

      div.innerHTML = `
        <img src="${estudiante?.foto_url || 'https://via.placeholder.com/120'}"
          alt="Foto estudiante"
          style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #bbb;margin-bottom:10px;">
        <h3>${estudiante?.nombre || 'Estudiante'}</h3>
        <p><strong>Grado:</strong> ${estudiante?.grado || '--'}</p>
        <p><strong>Motivo:</strong> ${salida?.motivo || '--'}</p>
        <p><strong>Hora:</strong> ${salida?.hora || '--:--'}</p>
      `;
      contenedor.appendChild(div);
    }
  }

  document.addEventListener('DOMContentLoaded', cargarVerificaciones);
</script>

<script>
function testSanitizeHtml() {
    const dirty = "<script>alert('xss')</script><b>hola</b>";
    const clean = sanitizeHtml(dirty);
    if (clean.includes("<script>")) {
        console.error("‚ùå sanitizeHtml fall√≥");
    } else {
        console.log("‚úÖ sanitizeHtml pas√≥");
    }
}
document.addEventListener("DOMContentLoaded", testSanitizeHtml);
</script>

</body>
</html>
