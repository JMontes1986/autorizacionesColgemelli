<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<!-- HEADERS DE SEGURIDAD MEJORADOS -->
<meta http-equiv="X-Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net https://mbosvnmhnbrslfwlfcxu.supabase.co https://hcaptcha.com https://*.hcaptcha.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://hcaptcha.com https://*.hcaptcha.com; style-src 'self' 'unsafe-inline' https://hcaptcha.com https://*.hcaptcha.com; frame-src https://hcaptcha.com https://*.hcaptcha.com; connect-src 'self' https://mbosvnmhnbrslfwlfcxu.supabase.co https://hcaptcha.com https://*.hcaptcha.com;">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
<meta name="robots" content="noindex, nofollow">
<title>Sistema de Salidas - Colegio Gemelli</title>
<!-- Supabase CDN para GitHub -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- hCaptcha -->
<script src="https://hcaptcha.com/1/api.js" async defer></script>
<!-- CryptoJS para cifrado -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
<!-- Chart.js versión estable -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 1200px;
            width: 95%;
            min-height: 80vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-status.connected {
            background: rgba(46, 204, 113, 0.2);
        }

        .connection-status.disconnected {
            background: rgba(231, 76, 60, 0.2);
        }

        .content {
            padding: 30px;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group label[for="gradeSelect"],
        .form-group label[for="studentSelect"],
        .form-group label[for="reasonSelect"],
        .form-group label[for="exitDate"],
        .form-group label[for="exitTime"] {
            color: #2c3e50;
            font-size: 16px;
        }

        .form-group select:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        #passwordNote {
            font-weight: normal;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* ========================================
           RESPONSIVE DESIGN MEJORADO
           ======================================== */

        /* Mobile First - Pantallas pequeñas (hasta 480px) */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                width: 100%;
                min-height: 100vh;
                border-radius: 0;
                margin: 0;
            }

            .header {
                padding: 15px 10px;
                position: relative;
            }

            .header h1 {
                font-size: 1.4em;
                margin-bottom: 5px;
            }

            .header .subtitle {
                font-size: 0.9em;
                line-height: 1.2;
            }

            .connection-status {
                position: static;
                display: block;
                text-align: center;
                margin: 10px 0 0 0;
                padding: 5px 10px;
                font-size: 12px;
            }

            .logout-btn {
                position: static;
                display: block;
                width: 100%;
                margin-top: 10px;
                padding: 8px 15px;
                font-size: 14px;
            }

            .content {
                padding: 15px;
            }

            .login-form {
                max-width: 100%;
                margin: 0;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group input, 
            .form-group select, 
            .form-group textarea {
                font-size: 16px; /* Evita zoom en iOS */
                padding: 14px;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
                padding: 14px 20px;
                font-size: 16px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-top: 15px;
            }

            .nav-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .nav-buttons .btn {
                width: 100%;
                margin: 0;
                padding: 12px;
                font-size: 14px;
            }

            .section {
                padding: 15px;
                margin-top: 15px;
            }

            .section h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }

            /* Tablas responsive */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }

            .table {
                min-width: 600px;
                font-size: 14px;
            }

            .table th, .table td {
                padding: 8px 6px;
                white-space: nowrap;
            }

            .table .btn {
                width: auto;
                padding: 6px 10px;
                font-size: 12px;
                margin: 2px;
            }

            /* Verificación cards responsive */
            .verification-card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .verification-card h3 {
                font-size: 1.1em;
                margin-bottom: 15px;
            }

            .verification-card-content {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
            }

            .verification-card-info p {
                font-size: 14px;
            }

            .verification-card .btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }

            /* Modales responsive */
            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 20px;
                max-height: 95vh;
            }

            .modal-content h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }

            /* Search box responsive */
            .search-box {
                font-size: 16px;
                padding: 12px;
            }

            /* Security stats responsive */
            .security-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card .number {
                font-size: 24px;
            }

            /* Filters section responsive */
            .filters-section {
                padding: 15px;
            }

            .filters-section .grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Captcha responsive */
            .captcha-container {
                margin: 10px 0;
                overflow: hidden;
            }

            /* Security indicator responsive */
            .security-indicator {
                position: fixed;
                bottom: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
                border-radius: 10px;
                font-size: 11px;
                padding: 8px 12px;
            }

            /* Rate limit warning responsive */
            .rate-limit-warning {
                position: fixed;
                top: 10px;
                left: 10px;
                right: 10px;
                text-align: center;
                font-size: 14px;
                padding: 12px;
            }
        }

        /* Tablets - Pantallas medianas (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                width: 95%;
                margin: 20px auto;
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.7em;
            }

            .connection-status {
                top: 15px;
                left: 15px;
                font-size: 13px;
            }

            .logout-btn {
                top: 15px;
                right: 15px;
                padding: 8px 16px;
            }

            .content {
                padding: 20px;
            }

            .login-form {
                max-width: 400px;
            }

            .grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 18px;
            }

            .nav-buttons {
                justify-content: center;
                gap: 12px;
            }

            .nav-buttons .btn {
                flex: 1;
                min-width: 120px;
                max-width: 200px;
            }

            .section {
                padding: 20px;
            }

            /* Tablas en tablet */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table {
                font-size: 14px;
            }

            .table th, .table td {
                padding: 10px 8px;
            }

            /* Verificación cards en tablet */
            .verification-card {
                padding: 20px;
            }

            .verification-card-content {
                grid-template-columns: 1fr 1fr;
                gap: 18px;
            }

            /* Security stats en tablet */
            .security-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            /* Modales en tablet */
            .modal-content {
                width: 90%;
                margin: 5% auto;
                padding: 25px;
            }
        }

        /* Desktop pequeño - Pantallas medianas-grandes (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                width: 90%;
                max-width: 1000px;
            }

            .nav-buttons {
                justify-content: center;
                gap: 15px;
            }

            .grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }

            .security-stats {
                grid-template-columns: repeat(4, 1fr);
            }

            .verification-card-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Desktop grande - Pantallas grandes (1025px+) */
        @media (min-width: 1025px) {
            .container {
                max-width: 1200px;
            }

            .grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }

            .security-stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Orientación landscape en móviles */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.2em;
                margin-bottom: 0;
            }

            .header .subtitle {
                font-size: 0.8em;
            }

            .content {
                padding: 10px;
            }

            .modal-content {
                max-height: 90vh;
                margin: 2% auto;
            }

            .verification-card {
                padding: 10px;
            }

            .verification-card-content {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                padding: 10px;
            }
        }

        /* Estilos específicos para touch devices */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px; /* Tamaño mínimo recomendado para touch */
                padding: 12px 20px;
            }

            .table .btn {
                min-height: 36px;
                padding: 8px 12px;
            }

            .form-group input, 
            .form-group select, 
            .form-group textarea {
                min-height: 44px;
            }

            /* Hover states no aplicables en touch */
            .btn:hover {
                transform: none;
            }

            .table tbody tr:hover {
                background: transparent;
            }
        }

        /* Mejoras adicionales para dispositivos móviles */
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Scroll suave en contenedores */
        .table-container {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Mejor UX para forms en móvil */
        @media (max-width: 480px) {
            /* Evitar zoom automático en iOS */
            input[type="email"],
            input[type="password"],
            input[type="text"],
            input[type="tel"],
            input[type="url"],
            input[type="search"],
            textarea,
            select {
                font-size: 16px !important;
                transform: scale(1);
            }

            /* Mejorar spacing en formularios */
            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            /* Hacer los selects más fáciles de usar en móvil */
            select {
                background-size: 20px;
                padding-right: 35px;
            }

            /* Mejorar la visualización de mensajes de error/éxito */
            .alert {
                font-size: 14px;
                padding: 12px;
                margin-bottom: 15px;
                border-radius: 6px;
            }

            /* Optimizar espaciado de botones */
            .btn {
                letter-spacing: 0.5px;
                font-weight: 600;
            }

            /* Mejorar el modal en pantallas muy pequeñas */
            .modal-content {
                border-radius: 12px;
                max-width: 100%;
            }

            /* Stack navigation buttons verticalmente */
            .nav-buttons {
                display: flex;
                flex-direction: column;
                align-items: stretch;
            }

            /* Mejorar cards de verificación para pantallas pequeñas */
            .verification-card {
                border-radius: 12px;
                font-size: 14px;
            }

            .verification-card h3 {
                font-size: 1.0em;
                line-height: 1.2;
            }

            /* Optimizar indicadores de seguridad */
            .password-strength {
                height: 4px;
                margin-top: 4px;
            }

            /* Mejorar captcha container */
            .captcha-container iframe {
                max-width: 100%;
                height: auto;
            }
        }

        /* Pantallas extra pequeñas (320px y menor) */
        @media (max-width: 320px) {
            .header h1 {
                font-size: 1.2em;
            }

            .header .subtitle {
                font-size: 0.8em;
            }

            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }

            .verification-card {
                padding: 12px;
            }

            .verification-card-content {
                padding: 12px;
                gap: 12px;
            }

            .modal-content {
                padding: 15px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-card .number {
                font-size: 20px;
            }
        }

        /* Mejoras para tablets en orientación portrait */
        @media (min-width: 481px) and (max-width: 768px) and (orientation: portrait) {
            .nav-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .verification-card-content {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        /* Mejoras para tablets en orientación landscape */
        @media (min-width: 481px) and (max-width: 1024px) and (orientation: landscape) {
            .nav-buttons {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 12px;
            }

            .nav-buttons .btn {
                flex: 0 1 auto;
                min-width: 140px;
            }
        }

        /* Optimizaciones específicas para iPhone SE y dispositivos similares */
        @media (max-width: 375px) and (max-height: 667px) {
            .container {
                min-height: 100vh;
            }

            .header {
                padding: 12px 10px;
            }

            .content {
                padding: 12px;
            }

            .section {
                padding: 12px;
            }
        }

        /* Mejoras para accesibilidad táctil */
        @media (pointer: coarse) {
            /* Áreas de toque más grandes */
            .btn {
                min-height: 48px;
                min-width: 48px;
            }

            .close {
                font-size: 32px;
                padding: 8px;
                min-width: 48px;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Enlaces y botones más espaciados */
            .table .btn {
                margin: 4px 2px;
                min-height: 40px;
            }

            /* Inputs más grandes para mejor usabilidad */
            .form-group input,
            .form-group select,
            .form-group textarea {
                min-height: 48px;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .table-container {
                background: #2c3e50;
            }

            .modal-content {
                background: #34495e;
                color: white;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                background: #34495e;
                color: white;
                border-color: #555;
            }
        }

        /* Mejoras de rendimiento para animaciones en móvil */
        @media (max-width: 768px) {
            .verification-card,
            .btn,
            .modal-content {
                will-change: auto;
            }

            /* Reducir animaciones complejas en móvil */
            .btn:hover {
                transform: translateY(-1px);
            }
        }

        /* Mejoras específicas para scroll horizontal en tablas */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: white;
            position: relative;
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .table {
            width: 100%;
            min-width: 800px; /* Ancho mínimo para evitar que se comprima demasiado */
            border-collapse: collapse;
            margin: 0;
            background: white;
        }

        /* Indicadores de scroll mejorados */
        .table-wrapper::before,
        .table-wrapper::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 20px;
            pointer-events: none;
            z-index: 2;
            transition: opacity 0.3s ease;
        }

        .table-wrapper::before {
            left: 0;
            background: linear-gradient(to right, rgba(255,255,255,0.9), transparent);
            opacity: 0;
        }

        .table-wrapper::after {
            right: 0;
            background: linear-gradient(to left, rgba(255,255,255,0.9), transparent);
        }

        .table-wrapper.has-scroll-left::before {
            opacity: 1;
        }

        .table-wrapper.has-scroll-right::after {
            opacity: 1;
        }

        /* Estilos para el dashboard */
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .dashboard-card h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pending-exits {
            border-left-color: #2ecc71;
        }

        .confirmed-exits {
            border-left-color: #3498db;
        }

        .total-today {
            border-left-color: #f39c12;
        }

        .recent-activity {
            border-left-color: #e74c3c;
        }

        /* Lista de estudiantes recientes */
        .recent-students {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid transparent;
        }

        .student-item.pending {
            border-left-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .student-item.confirmed {
            border-left-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .student-details {
            font-size: 0.85em;
            color: #666;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background: #2ecc71;
            color: white;
        }

        .status-confirmed {
            background: #3498db;
            color: white;
        }

        /* Responsive para dashboard */
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .dashboard-card {
                padding: 20px;
            }

            .chart-container {
                height: 250px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .table {
                min-width: 600px;
            }
        }

        @media (max-width: 480px) {
            .dashboard-card {
                padding: 15px;
            }

            .chart-container {
                height: 200px;
            }

            .table {
                min-width: 500px;
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 6px 4px;
            }
        }

        /* Scroll hint para tablas */
        .scroll-hint {
            display: none;
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 8px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        @media (max-width: 768px) {
            .scroll-hint {
                display: block;
            }
        }

        /* Mejoras para focus states en elementos interactivos */
        .btn:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* Estilos para el botón de scroll to top móvil */
        #mobileQuickActions {
            display: none;
        }

        @media (max-width: 480px) {
            #mobileQuickActions {
                display: flex;
            }
        }

        /* Mejoras de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .btn:hover {
                transform: none;
            }

            .verification-card {
                transition: none;
            }

            /* Desactivar scroll suave en reduced motion */
            html {
                scroll-behavior: auto;
            }
        }

        /* Alto contraste */
        @media (prefers-contrast: high) {
            .btn {
                border: 2px solid;
            }

            .form-group input, 
            .form-group select, 
            .form-group textarea {
                border: 2px solid #333;
            }

            .verification-card {
                border: 2px solid;
            }

            .table-container {
                border: 2px solid #333;
            }
        }

        /* Mejoras para pantallas de alta densidad */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .btn {
                border-width: 0.5px;
            }
            
            .table {
                border-collapse: separate;
                border-spacing: 0;
            }
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #2ecc71;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* Estilos específicos para vigilancia */
        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        /* Mejoras para los botones de navegación en vigilancia */
        @media (max-width: 768px) {
            .nav-buttons .btn {
                font-size: 14px;
                padding: 10px 15px;
                margin: 3px;
            }
        }

        @media (max-width: 480px) {
            .nav-buttons {
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .nav-buttons .btn {
                width: 100%;
                margin: 0;
                font-size: 13px;
                padding: 12px;
            }
        }

        .dashboard {
            display: none;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .section {
            display: none;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .table tbody tr:hover {
            background: #f5f5f5;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .verification-card {
            text-align: center;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .verification-card h3 {
            font-size: 1.4em;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .verification-card-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: left;
            margin: 20px 0;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .verification-card-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .verification-card-info p {
            margin: 0;
            font-size: 15px;
            line-height: 1.4;
        }

        .verification-card-info strong {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .verification-card-info .info-value {
            font-size: 16px;
            font-weight: 500;
        }

        .verification-card-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .verification-card-footer p {
            margin: 8px 0;
            font-size: 15px;
        }

        .verification-card-obs {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .verification-card-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .verification-card {
                padding: 20px;
            }
        }

        .verification-card.authorized {
            border-left-color: #2ecc71;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .verification-card.verified {
            border-left-color: #3498db;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .verification-card.not-authorized {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 18px;
            margin-bottom: 20px;
        }

        /* Estilos para la sección de seguridad */
        .security-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters-section .form-group {
            margin-bottom: 15px;
        }

        .log-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .log-type.login {
            background: #2ecc71;
            color: white;
        }

        .log-type.logout {
            background: #95a5a6;
            color: white;
        }

        .log-type.create {
            background: #3498db;
            color: white;
        }

        .log-type.update {
            background: #f39c12;
            color: white;
        }

        .log-type.delete {
            background: #e74c3c;
            color: white;
        }

        .log-type.error {
            background: #c0392b;
            color: white;
        }

        /* Estilos para rate limiting */
        .rate-limit-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            z-index: 9999;
        }

        /* Password strength indicator */
        .password-strength {
            margin-top: 5px;
            height: 5px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .password-strength.weak {
            background: #e74c3c;
            width: 33%;
        }

        .password-strength.medium {
            background: #f39c12;
            width: 66%;
        }

        .password-strength.strong {
            background: #2ecc71;
            width: 100%;
        }

        /* Estilos para CAPTCHA */
        .captcha-container {
            margin: 15px 0;
            display: flex;
            justify-content: center;
        }

        .security-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .security-indicator.secure {
            background: rgba(46, 204, 113, 0.9);
        }

        .security-indicator.warning {
            background: rgba(243, 156, 18, 0.9);
        }

        /* Estilos para input validation */
        .input-secure {
            border-color: #2ecc71 !important;
            box-shadow: 0 0 5px rgba(46, 204, 113, 0.3);
        }

        .input-warning {
            border-color: #f39c12 !important;
            box-shadow: 0 0 5px rgba(243, 156, 18, 0.3);
        }

        .input-error {
            border-color: #e74c3c !important;
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                width: 100%;
                margin: 10px;
                border-radius: 10px;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
<div class="container">
<div class="header">
<h1>🏫 Colegio Gemelli</h1>
<div class="subtitle">Sistema de Control de Salidas Estudiantiles - Versión Segura</div>
<div class="connection-status" id="connectionStatus">
<span id="connectionIcon">🔴</span>
<span id="connectionText">Verificando conexión...</span>
</div>
<button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
</div>
<div class="content">
<!-- Rate Limit Warning -->
<div class="rate-limit-warning" id="rateLimitWarning">
⚠️ Demasiados intentos. Por favor espera antes de intentar de nuevo.
</div>

<!-- Security Indicator -->
<div class="security-indicator secure" id="securityIndicator">
🔒 Conexión Segura
</div>

<!-- Login Form -->
<div class="login-form" id="loginSection">
<div class="form-group">
<label for="email">Email:</label>
<input id="email" placeholder="sistemas@colgemelli.edu.co" type="email" maxlength="100" autocomplete="username" oninput="validateEmailInput(this)"/>
</div>
<div class="form-group">
<label for="password">Contraseña:</label>
<input id="password" placeholder="••••••••" type="password" maxlength="50" autocomplete="current-password" oninput="validatePasswordInput(this)"/>
<div class="password-strength" id="passwordStrength" style="display: none;"></div>
</div>
<!-- CAPTCHA -->
<div class="captcha-container">
<div class="h-captcha" data-sitekey="10000000-ffff-ffff-ffff-000000000001"></div>
</div>
<button class="btn" onclick="login()" id="loginBtn" style="width: 100%;">Iniciar Sesión</button>
<button class="btn btn-secondary" onclick="testConnection()" style="width: 100%; margin-top: 10px;">🔄 Probar Conexión</button>
<div class="alert alert-error" id="loginError" style="display: none; margin-top: 15px;"></div>
<div class="alert alert-success" id="loginInfo" style="display: none; margin-top: 15px;"></div>
</div>
<!-- Dashboard -->
<div class="dashboard" id="dashboard">
<div class="nav-buttons" id="navButtons">
<!-- Botones se cargarán dinámicamente según el rol -->
</div>
<!-- Sección para Autorizar Salidas -->
<div class="section" id="authorizeSectionDiv">
<h2>✅ Autorizar Salida de Estudiante</h2>
<form id="authorizeForm">
<div class="grid">
<div class="form-group">
<label for="gradeSelect">1. Seleccionar Grado: *</label>
<select id="gradeSelect" onchange="loadStudentsByGrade()" required="">
<option value="">Seleccionar grado primero...</option>
</select>

<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  <img id="authStudentPhoto" src="https://via.placeholder.com/120" alt="Foto del estudiante"
    style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #ccc;">
</div>


<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  
</div>

</div>
<div class="form-group">
<label for="studentSelect">2. Seleccionar Estudiante: *</label>
<select disabled="" id="studentSelect" required="">

<div id="authStudentImage" style="text-align:center; margin:10px 0;">
  
</div>

<option value="">Primero selecciona un grado...</option>
</select>

<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  <img id="authStudentPhoto" src="https://via.placeholder.com/120" alt="Foto del estudiante"
    style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #ccc;">
</div>


<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  
</div>

</div>
<div class="form-group">
<label for="reasonSelect">3. Motivo: *</label>
<select id="reasonSelect" required="">
<option value="">Seleccionar motivo...</option>
</select>

<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  <img id="authStudentPhoto" src="https://via.placeholder.com/120" alt="Foto del estudiante"
    style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #ccc;">
</div>


<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  
</div>

</div>
<div class="form-group">
<label for="exitDate">4. Fecha de Salida: *</label>
<input id="exitDate" required="" type="date"/>
</div>
<div class="form-group">
<label for="exitTime">5. Hora de Salida: *</label>
<input id="exitTime" required="" type="time"/>
</div>
</div>
<div class="form-group">
<label for="observations">Observaciones adicionales:</label>
<textarea id="observations" placeholder="Observaciones opcionales sobre la salida..." rows="3" maxlength="500" oninput="validateTextInput(this)"></textarea>
</div>
<button class="btn btn-success" style="font-size: 18px; padding: 15px 30px;" type="submit">✅ Autorizar Salida</button>
</form>
</div>
<!-- Sección para Verificar Salidas (Vigilante) -->
<div class="section" id="verifySectionDiv">
<h2>🔍 Control de Salidas - Vigilancia</h2>
<div class="nav-buttons">
<button class="btn btn-success" onclick="loadPendingExits()">🔄 Actualizar Lista</button>
<button class="btn btn-secondary" onclick="toggleSearch()">🔍 Buscar Estudiante</button>
<button class="btn btn-warning" onclick="showMyConfirmedExits()">👁️ Ver Mis Confirmaciones</button>
</div>

<!-- Búsqueda manual (inicialmente oculta) -->
<div id="searchSection" style="display: none; margin-top: 20px;">
<h3 style="color: #2c3e50; margin-bottom: 15px;">🔍 Búsqueda Manual de Estudiante</h3>
<input class="search-box" id="studentSearch" placeholder="Buscar estudiante específico por nombre..." type="text" maxlength="100" oninput="validateSearchInput(this)"/>
<div id="searchResult"></div>
</div>

<!-- Sección de salidas confirmadas por el vigilante (inicialmente oculta) -->
<div id="myConfirmedSection" style="display: none; margin-top: 20px;">
<h3 style="color: #2c3e50; margin: 20px 0 15px 0;">✅ Salidas Confirmadas por Mí Hoy</h3>
<div id="myConfirmedList">
<div class="card" style="text-align: center; padding: 30px;">
<p style="color: #666;">Cargando salidas confirmadas...</p>
</div>
</div>
</div>

<!-- Lista de estudiantes con salidas pendientes -->
<div id="pendingExitsSection">
<h3 style="color: #2c3e50; margin: 20px 0 15px 0;">📋 Estudiantes con Salidas Pendientes para Hoy</h3>
<div id="pendingExitsList">

<!-- Ejemplo de tarjeta con foto -->
<div class="verification-card">
  <img src="https://via.placeholder.com/120" alt="Foto estudiante" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; margin-bottom: 10px;">
  <h3>Nombre Estudiante</h3>
  <div class="verification-card-content">
    <div class="verification-card-info">
      <p><strong>Grado:</strong> 10</p>
      <p><strong>Motivo:</strong> Cita médica</p>
      <p><strong>Hora:</strong> 10:30 am</p>
    </div>
  </div>
  <button class="btn btn-success">✅ Confirmar Salida</button>
</div>

<div class="card" style="text-align: center; padding: 30px;">
<p style="color: #666;">Cargando estudiantes con salidas pendientes...</p>
</div>
</div>
</div>
</div>
<!-- Sección de Administración -->
<div class="section" id="adminSectionDiv">
<h2>⚙️ Panel de Administración</h2>
<div class="nav-buttons">
<button class="btn" onclick="showAdminSection('students')">Gestionar Estudiantes</button>
<button class="btn" onclick="showAdminSection('users')">Gestionar Usuarios</button>
<button class="btn" onclick="showAdminSection('reasons')">Gestionar Motivos</button>
<button class="btn" onclick="showAdminSection('grades')">Gestionar Grados</button>
<button class="btn btn-warning" onclick="showAdminSection('security')">🔒 Seguridad y Logs</button>
</div>
<div class="admin-subsection" id="adminStudents" style="display: none;">
<h3>👨‍🎓 Gestión de Estudiantes</h3>
<button class="btn btn-success" onclick="openModal('studentModal')">Agregar Estudiante</button>
<div class="table-wrapper">
<table class="table" id="studentsTable">
<thead>
<tr>
<th style="min-width: 120px;">Nombre</th>
<th style="min-width: 120px;">Apellidos</th>
<th style="min-width: 100px;">Documento</th>
<th style="min-width: 120px;">Grado</th>
<th style="min-width: 160px;">Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="admin-subsection" id="adminUsers" style="display: none;">
<h3>👥 Gestión de Usuarios</h3>
<button class="btn btn-success" onclick="openModal('userModal')">Agregar Usuario</button>
<div class="table-wrapper">
<table class="table" id="usersTable">
<thead>
<tr>
<th style="min-width: 120px;">Nombre</th>
<th style="min-width: 200px;">Email</th>
<th style="min-width: 120px;">Rol</th>
<th style="min-width: 80px;">Estado</th>
<th style="min-width: 160px;">Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="admin-subsection" id="adminReasons" style="display: none;">
<h3>📝 Gestión de Motivos</h3>
<button class="btn btn-success" onclick="openModal('reasonModal')">Agregar Motivo</button>
<div class="table-wrapper">
<table class="table" id="reasonsTable">
<thead>
<tr>
<th style="min-width: 120px;">Nombre</th>
<th style="min-width: 200px;">Descripción</th>
<th style="min-width: 80px;">Estado</th>
<th style="min-width: 160px;">Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="admin-subsection" id="adminGrades" style="display: none;">
<h3>🎓 Gestión de Grados</h3>
<button class="btn btn-success" onclick="openModal('gradeModal')">Agregar Grado</button>
<div class="table-wrapper">
<table class="table" id="gradesTable">
<thead>
<tr>
<th style="min-width: 120px;">Nombre</th>
<th style="min-width: 100px;">Nivel</th>
<th style="min-width: 80px;">Estado</th>
<th style="min-width: 160px;">Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<!-- Sección de Seguridad -->
<div class="admin-subsection" id="adminSecurity" style="display: none;">
<h3>🔒 Seguridad y Logs de Auditoría</h3>
<div class="security-stats">
<div class="stat-card">
<h4>Accesos Hoy</h4>
<div class="number" id="todayLogins">0</div>
</div>
<div class="stat-card">
<h4>Cambios Hoy</h4>
<div class="number" id="todayChanges">0</div>
</div>
<div class="stat-card">
<h4>Intentos Fallidos</h4>
<div class="number" id="failedAttempts">0</div>
</div>
<div class="stat-card">
<h4>Usuarios Activos</h4>
<div class="number" id="activeUsers">0</div>
</div>
</div>
<div class="filters-section">
<h4>Filtros de Logs</h4>
<div class="grid">
<div class="form-group">
<label for="logDateFrom">Fecha Desde:</label>
<input type="date" id="logDateFrom" />
</div>
<div class="form-group">
<label for="logDateTo">Fecha Hasta:</label>
<input type="date" id="logDateTo" />
</div>
<div class="form-group">
<label for="logType">Tipo de Acción:</label>
<select id="logType">
<option value="">Todos</option>
<option value="login">Inicio de Sesión</option>
<option value="logout">Cierre de Sesión</option>
<option value="create">Creación</option>
<option value="update">Actualización</option>
<option value="delete">Eliminación</option>
<option value="error">Error</option>
</select>

<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  <img id="authStudentPhoto" src="https://via.placeholder.com/120" alt="Foto del estudiante"
    style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #ccc;">
</div>


<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  
</div>

</div>
<div class="form-group">
<label for="logUser">Usuario:</label>
<select id="logUser">
<option value="">Todos</option>
</select>

<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  <img id="authStudentPhoto" src="https://via.placeholder.com/120" alt="Foto del estudiante"
    style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #ccc;">
</div>


<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  
</div>

</div>
</div>
<button class="btn" onclick="loadSecurityLogs()">🔍 Buscar Logs</button>
<button class="btn btn-secondary" onclick="exportLogs()">📥 Exportar Logs</button>
</div>
<div class="table-wrapper">
<table class="table" id="securityLogsTable">
<thead>
<tr>
<th style="min-width: 140px;">Fecha/Hora</th>
<th style="min-width: 120px;">Usuario</th>
<th style="min-width: 80px;">Tipo</th>
<th style="min-width: 140px;">Acción</th>
<th style="min-width: 200px;">Detalles</th>
<th style="min-width: 100px;">IP</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
<!-- Sección de Dashboard (NUEVA) -->
<div class="section" id="dashboardSectionDiv">
<h2>📊 Dashboard de Salidas</h2>
<div class="dashboard-container">
<!-- Estadísticas Generales -->
<div class="dashboard-card">
<h3>📈 Estadísticas de Hoy</h3>
<div class="stats-grid">
<div class="stat-item pending-exits">
<div class="stat-number" id="dashPendingCount">0</div>
<div class="stat-label">Pendientes</div>
</div>
<div class="stat-item confirmed-exits">
<div class="stat-number" id="dashConfirmedCount">0</div>
<div class="stat-label">Confirmadas</div>
</div>
<div class="stat-item total-today">
<div class="stat-number" id="dashTotalCount">0</div>
<div class="stat-label">Total Hoy</div>
</div>
<div class="stat-item recent-activity">
<div class="stat-number" id="dashRecentCount">0</div>
<div class="stat-label">Última Hora</div>
</div>
</div>
</div>

<!-- Gráfico de Estado de Salidas -->
<div class="dashboard-card">
<h3>🟢🔵 Estado de Salidas</h3>
<div class="chart-container">
<canvas id="statusChart"></canvas>
<div id="statusChartFallback" style="display: none; text-align: center; padding: 20px; color: #666;">
<p>📊 Cargando gráfico...</p>
<p><small>Si no aparece, revisa que Chart.js esté cargado</small></p>
</div>
</div>
</div>

<!-- Gráfico por Grados -->
<div class="dashboard-card">
<h3>🎓 Salidas por Grado</h3>
<div class="chart-container">
<canvas id="gradeChart"></canvas>
<div id="gradeChartFallback" style="display: none; text-align: center; padding: 20px; color: #666;">
<p>📊 Cargando gráfico...</p>
</div>
</div>
</div>

<!-- Actividad Reciente -->
<div class="dashboard-card">
<h3>⏰ Actividad Reciente</h3>
<div class="recent-students" id="recentActivity">
<p style="text-align: center; color: #666; padding: 20px;">Cargando actividad reciente...</p>
</div>
</div>

<!-- Gráfico de Motivos -->
<div class="dashboard-card">
<h3>📝 Motivos de Salida</h3>
<div class="chart-container">
<canvas id="reasonChart"></canvas>
<div id="reasonChartFallback" style="display: none; text-align: center; padding: 20px; color: #666;">
<p>📊 Cargando gráfico...</p>
</div>
</div>
</div>

<!-- Timeline de Salidas -->
<div class="dashboard-card">
<h3>⏱️ Timeline de Salidas Hoy</h3>
<div class="chart-container">
<canvas id="timelineChart"></canvas>
<div id="timelineChartFallback" style="display: none; text-align: center; padding: 20px; color: #666;">
<p>📊 Cargando gráfico...</p>
</div>
</div>
</div>
</div>

        <!-- Controles del Dashboard -->
<div class="nav-buttons" style="margin-top: 20px;">
<button class="btn btn-success" onclick="refreshDashboard()">🔄 Actualizar Dashboard</button>
<button class="btn btn-secondary" onclick="exportDashboardData()">📥 Exportar Datos</button>
<button class="btn" onclick="showDetailedView()">📋 Vista Detallada</button>
<button class="btn btn-warning" onclick="debugDashboard()" style="font-size: 12px;">🔧 Debug</button>
<button class="btn" onclick="forceReloadCharts()" style="font-size: 12px; background: #e67e22;">🔄 Recargar Gráficos</button>
</div>

<div id="chartjsStatus" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; text-align: center; display: none;">
<p style="margin: 0; color: #666;"><strong>Estado Chart.js:</strong> <span id="chartjsStatusText">Verificando...</span></p>
</div>
</div>

<!-- Sección de Historial -->
<div class="section" id="historySectionDiv">
<h2>📋 Historial de Autorizaciones</h2>
<div class="form-group">
<input id="historyDate" onchange="loadHistory()" type="date"/>
<button class="btn" onclick="loadHistory()">Filtrar por Fecha</button>
<button class="btn btn-secondary" onclick="loadHistory(true)">Ver Todo el Historial</button>
<button class="btn" onclick="debugHistory()" style="background: #e67e22;">🔍 Debug Historial</button>
</div>
<div id="historyDebug" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
<h4>🔧 Información de Debug:</h4>
<div id="historyDebugContent"></div>
</div>
<div class="table-wrapper">
<table class="table" id="historyTable">
<thead>
<tr>
<th style="min-width: 150px;">Estudiante</th>
<th style="min-width: 120px;">Grado</th>
<th style="min-width: 140px;">Motivo</th>
<th style="min-width: 110px;">Fecha Salida</th>
<th style="min-width: 100px;">Hora Salida</th>
<th style="min-width: 140px;">Autorizado por</th>
<th style="min-width: 160px;">Estado</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="scroll-hint" style="text-align: center; font-size: 12px; color: #666; padding: 8px; background: #f8f9fa; border-top: 1px solid #ddd; border-radius: 0 0 8px 8px;">
💡 Desliza horizontalmente para ver toda la información
</div>
</div>
</div>
</div>
</div>
<!-- Modals -->
<div class="modal" id="studentModal">
<div class="modal-content">
<span class="close" onclick="closeModal('studentModal')">×</span>
<h2>Agregar/Editar Estudiante</h2>
<form id="studentForm">
<div class="form-group">
  <label for="uploadStudentPhoto">Subir Foto:</label>
  <input type="file" id="uploadStudentPhoto" accept="image/jpeg,image/png,image/gif" onchange="handleImageUpload(event)" />
  <img id="studentPhotoPreview" src="https://via.placeholder.com/120" alt="Foto del estudiante" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; display: block; margin: 10px auto; border: 2px solid #ccc;">
  <input type="hidden" id="studentPhotoBase64" />
  <small>Formatos permitidos: JPG, PNG, GIF. Máximo 2MB.</small>
</div>

<div class="form-group">
<label>Nombre: *</label>
<input id="studentName" required="" type="text" maxlength="50" pattern="[A-Za-zÀ-ÿ\s]{2,50}" oninput="validateNameInput(this)"/>
</div>
<div class="form-group">
<label>Apellidos: *</label>
<input id="studentLastName" required="" type="text" maxlength="50" pattern="[A-Za-zÀ-ÿ\s]{2,50}" oninput="validateNameInput(this)"/>
</div>
<div class="form-group">
<label>Documento:</label>
<input id="studentDocument" type="text" maxlength="20" pattern="[0-9]{6,20}" oninput="validateDocumentInput(this)"/>
</div>
<div class="form-group">
<label>Grado: *</label>
<select id="studentGrade" required="">
<option value="">Seleccionar grado...</option>
</select>

<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  <img id="authStudentPhoto" src="https://via.placeholder.com/120" alt="Foto del estudiante"
    style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #ccc;">
</div>


<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  
</div>

</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('studentModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<div class="modal" id="userModal">
<div class="modal-content">
<span class="close" onclick="closeModal('userModal')">×</span>
<h2>Agregar/Editar Usuario</h2>
<form id="userForm">
<div class="form-group">
<label>Nombre: *</label>
<input id="userName" required="" type="text" maxlength="50" pattern="[A-Za-zÀ-ÿ\s]{2,50}" oninput="validateNameInput(this)"/>
</div>
<div class="form-group">
<label>Email: *</label>
<input id="userEmail" required="" type="email" maxlength="100" oninput="validateEmailInput(this)"/>
</div>
<div class="form-group">
<label>Contraseña: <span id="passwordNote">(dejar vacío para mantener actual)</span></label>
<input id="userPassword" type="password" maxlength="50" onkeyup="checkPasswordStrength()" oninput="validatePasswordInput(this)"/>
<div class="password-strength" id="userPasswordStrength" style="display: none;"></div>
</div>
<div class="form-group">
<label>Rol: *</label>
<select id="userRole" required="">
<option value="">Seleccionar rol...</option>
</select>

<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  <img id="authStudentPhoto" src="https://via.placeholder.com/120" alt="Foto del estudiante"
    style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #ccc;">
</div>


<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  
</div>

</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('userModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<div class="modal" id="reasonModal">
<div class="modal-content">
<span class="close" onclick="closeModal('reasonModal')">×</span>
<h2>Agregar/Editar Motivo</h2>
<form id="reasonForm">
<div class="form-group">
<label>Nombre: *</label>
<input id="reasonName" required="" type="text" maxlength="50" oninput="validateTextInput(this)"/>
</div>
<div class="form-group">
<label>Descripción:</label>
<textarea id="reasonDescription" rows="3" maxlength="200" oninput="validateTextInput(this)"></textarea>
</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('reasonModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<div class="modal" id="gradeModal">
<div class="modal-content">
<span class="close" onclick="closeModal('gradeModal')">×</span>
<h2>Agregar/Editar Grado</h2>
<form id="gradeForm">
<div class="form-group">
<label>Nombre: *</label>
<input id="gradeName" required="" type="text" maxlength="20" oninput="validateTextInput(this)"/>
</div>
<div class="form-group">
<label>Nivel: *</label>
<select id="gradeLevel" required="">
<option value="">Seleccionar nivel...</option>
<option value="Primaria">Primaria</option>
<option value="Bachillerato">Bachillerato</option>
</select>

<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  <img id="authStudentPhoto" src="https://via.placeholder.com/120" alt="Foto del estudiante"
    style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #ccc;">
</div>


<div id="authStudentFotoWrapper" style="text-align:center; margin-top:15px;">
  
</div>

</div>
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" onclick="closeModal('gradeModal')" type="button">Cancelar</button>
</form>
</div>
</div>
<script>
        // ========================================
        // VERIFICACIÓN Y CARGA DE CHART.JS
        // ========================================

        function waitForChartJS() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 segundos máximo
                
                const checkChart = () => {
                    attempts++;
                    console.log(`🔍 Verificando Chart.js - Intento ${attempts}/${maxAttempts}`);
                    
                    if (typeof Chart !== 'undefined') {
                        console.log('✅ Chart.js cargado exitosamente:', Chart.version);
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        console.error('❌ Chart.js no se pudo cargar después de', maxAttempts, 'intentos');
                        reject(new Error('Chart.js no se cargó'));
                    } else {
                        setTimeout(checkChart, 100);
                    }
                };
                
                checkChart();
            });
        }

        async function loadChartJSFallback() {
            try {
                console.log('🔄 Intentando cargar Chart.js como fallback...');
                
                // Crear elemento script para Chart.js
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
                script.crossOrigin = 'anonymous';
                
                return new Promise((resolve, reject) => {
                    script.onload = () => {
                        console.log('✅ Chart.js fallback cargado exitosamente');
                        resolve(true);
                    };
                    
                    script.onerror = () => {
                        console.error('❌ Error cargando Chart.js fallback');
                        reject(new Error('Fallback falló'));
                    };
                    
                    document.head.appendChild(script);
                    
                    // Timeout de 10 segundos
                    setTimeout(() => {
                        reject(new Error('Timeout cargando Chart.js'));
                    }, 10000);
                });
                
            } catch (error) {
                console.error('❌ Error en fallback de Chart.js:', error);
                throw error;
            }
        }

        async function ensureChartJSLoaded() {
            try {
                // Intentar con la carga normal primero
                await waitForChartJS();
                return true;
            } catch (error) {
                console.log('⚠️ Carga normal falló, intentando fallback...');
                try {
                    await loadChartJSFallback();
                    // Esperar un poco más después del fallback
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await waitForChartJS();
                    return true;
                } catch (fallbackError) {
                    console.error('❌ Ambos métodos de carga fallaron:', fallbackError);
                    return false;
                }
            }
        }

        // Crear gráficos simples sin Chart.js como última opción
        function createSimpleCharts() {
            console.log('📊 Creando gráficos simples sin Chart.js...');
            
            // Gráfico de estado simple
            const statusChart = document.getElementById('statusChart');
            if (statusChart) {
                statusChart.parentElement.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h4>Estado de Salidas</h4>
                        <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                            <div style="background: #2ecc71; color: white; padding: 15px; border-radius: 10px; flex: 1; margin: 0 5px;">
                                <div style="font-size: 24px; font-weight: bold;" id="simple-pending">0</div>
                                <div>🟢 Pendientes</div>
                            </div>
                            <div style="background: #3498db; color: white; padding: 15px; border-radius: 10px; flex: 1; margin: 0 5px;">
                                <div style="font-size: 24px; font-weight: bold;" id="simple-confirmed">0</div>
                                <div>🔵 Confirmadas</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Otros gráficos simples
            ['gradeChart', 'reasonChart', 'timelineChart'].forEach(chartId => {
                const chart = document.getElementById(chartId);
                if (chart) {
                    chart.parentElement.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #666;">
                            <p>📊 Gráfico no disponible</p>
                            <p><small>Chart.js no se pudo cargar. Los datos básicos están disponibles arriba.</small></p>
                        </div>
                    `;
                }
            });
        }

        function updateSimpleCharts(pendingCount, confirmedCount) {
            const simplePending = document.getElementById('simple-pending');
            const simpleConfirmed = document.getElementById('simple-confirmed');
            
            if (simplePending) simplePending.textContent = pendingCount;
            if (simpleConfirmed) simpleConfirmed.textContent = confirmedCount;
        }

        // Detectar tipo de dispositivo y ajustar UI
        function detectDeviceAndAdjustUI() {
            const isMobile = window.innerWidth <= 480;
            const isTablet = window.innerWidth > 480 && window.innerWidth <= 768;
            const isDesktop = window.innerWidth > 768;
            
            // Ajustar tabla en móvil
            if (isMobile) {
                adjustTablesForMobile();
                adjustModalsForMobile();
                adjustCardsForMobile();
            }
            
            // Ajustar navegación según el dispositivo
            adjustNavigationForDevice();
            
            // Ajustar captcha según el tamaño
            adjustCaptchaSize();
        }

        function adjustTablesForMobile() {
            const tables = document.querySelectorAll('.table');
            tables.forEach(table => {
                // Configurar scroll para la nueva estructura
                const wrapper = table.closest('.table-wrapper');
                if (wrapper) {
                    updateScrollIndicators(wrapper);
                }
            });
        }

        function adjustModalsForMobile() {
            const modals = document.querySelectorAll('.modal-content');
            const isMobile = window.innerWidth <= 480;
            
            modals.forEach(modal => {
                if (isMobile) {
                    modal.style.margin = '2% auto';
                    modal.style.width = '95%';
                    modal.style.maxHeight = '95vh';
                } else {
                    modal.style.margin = '5% auto';
                    modal.style.width = '90%';
                    modal.style.maxHeight = '90vh';
                }
            });
        }

        function adjustCardsForMobile() {
            const cards = document.querySelectorAll('.verification-card');
            const isMobile = window.innerWidth <= 480;
            
            cards.forEach(card => {
                const content = card.querySelector('.verification-card-content');
                if (content) {
                    if (isMobile) {
                        content.style.gridTemplateColumns = '1fr';
                        content.style.gap = '15px';
                    } else {
                        content.style.gridTemplateColumns = '1fr 1fr';
                        content.style.gap = '20px';
                    }
                }
            });
        }

        function adjustNavigationForDevice() {
            const navButtons = document.getElementById('navButtons');
            if (!navButtons) return;
            
            const isMobile = window.innerWidth <= 480;
            
            if (isMobile) {
                navButtons.style.flexDirection = 'column';
                navButtons.style.gap = '10px';
                
                // Hacer botones de navegación más grandes en móvil
                const buttons = navButtons.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.style.width = '100%';
                    btn.style.padding = '12px';
                    btn.style.fontSize = '14px';
                });
            } else {
                navButtons.style.flexDirection = 'row';
                navButtons.style.gap = '15px';
                
                const buttons = navButtons.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.style.width = 'auto';
                    btn.style.padding = '12px 24px';
                    btn.style.fontSize = '16px';
                });
            }
        }

        function adjustCaptchaSize() {
            const captchaContainer = document.querySelector('.captcha-container');
            if (!captchaContainer) return;
            
            const isMobile = window.innerWidth <= 480;
            
            if (isMobile) {
                captchaContainer.style.transform = 'scale(0.9)';
                captchaContainer.style.transformOrigin = 'center';
            } else {
                captchaContainer.style.transform = 'scale(1)';
            }
        }

        // ========================================
        // FUNCIONES DEL DASHBOARD
        // ========================================

        let dashboardCharts = {};

        async function loadDashboard() {
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                console.log('📊 Iniciando carga del dashboard...');
                
                // Mostrar indicador de carga
                document.getElementById('dashPendingCount').textContent = '...';
                document.getElementById('dashConfirmedCount').textContent = '...';
                document.getElementById('dashTotalCount').textContent = '...';
                document.getElementById('dashRecentCount').textContent = '...';
                
                const todayColombia = getColombiaDate();
                console.log('📅 Fecha Colombia para consulta:', todayColombia);
                
                // Consulta simplificada - solo datos básicos primero
                const { data: todayAuthorizations, error: authError } = await supabase
                    .from('autorizaciones_salida')
                    .select('*')
                    .eq('fecha_salida', todayColombia)
                    .eq('autorizada', true)
                    .order('fecha_creacion', { ascending: false });

                if (authError) {
                    console.error('❌ Error en consulta de autorizaciones:', authError);
                    throw authError;
                }

                const authorizations = todayAuthorizations || [];
                console.log(`📊 Autorizaciones encontradas: ${authorizations.length}`);

                // Procesar estadísticas básicas
                const pending = authorizations.filter(auth => !auth.salida_efectiva);
                const confirmed = authorizations.filter(auth => auth.salida_efectiva);
                
                console.log(`📈 Estadísticas: ${pending.length} pendientes, ${confirmed.length} confirmadas`);
                
                // Actividad de la última hora
                const oneHourAgo = new Date();
                oneHourAgo.setHours(oneHourAgo.getHours() - 1);
                const recentActivity = authorizations.filter(auth => 
                    new Date(auth.fecha_creacion) > oneHourAgo || 
                    (auth.salida_efectiva && new Date(auth.salida_efectiva) > oneHourAgo)
                );

                // Actualizar estadísticas básicas primero
                document.getElementById('dashPendingCount').textContent = pending.length;
                document.getElementById('dashConfirmedCount').textContent = confirmed.length;
                document.getElementById('dashTotalCount').textContent = authorizations.length;
                document.getElementById('dashRecentCount').textContent = recentActivity.length;

                console.log('✅ Estadísticas básicas actualizadas');

                // Verificar si Chart.js está disponible
                console.log('🔍 Verificando disponibilidad de Chart.js...');
                const chartJSAvailable = await ensureChartJSLoaded();
                
                if (chartJSAvailable) {
                    console.log('✅ Chart.js disponible, cargando gráficos completos...');
                    // Cargar gráficos con Chart.js
                    await loadDashboardCharts(authorizations);
                } else {
                    console.log('⚠️ Chart.js no disponible, usando gráficos simples...');
                    // Usar gráficos simples
                    createSimpleCharts();
                    updateSimpleCharts(pending.length, confirmed.length);
                }

                // Cargar actividad reciente (esto no depende de Chart.js)
                await loadDashboardActivity(authorizations);

                console.log('✅ Dashboard completamente cargado');
                
            } catch (error) {
                console.error('❌ Error general en dashboard:', error);
                await logSecurityEvent('error', 'Error al cargar dashboard', { 
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al cargar el dashboard: ' + error.message);
                updateEmptyDashboard();
            }
        }

        function updateEmptyDashboard() {
            // Mostrar ceros en lugar de errores
            document.getElementById('dashPendingCount').textContent = '0';
            document.getElementById('dashConfirmedCount').textContent = '0';
            document.getElementById('dashTotalCount').textContent = '0';
            document.getElementById('dashRecentCount').textContent = '0';

            // Verificar si Chart.js está disponible
            if (typeof Chart !== 'undefined') {
                // Crear gráficos vacíos con Chart.js
                createStatusChart(0, 0);
                createGradeChart([]);
                createReasonChart([]);
                createTimelineChart([]);
            } else {
                // Usar gráficos simples
                createSimpleCharts();
                updateSimpleCharts(0, 0);
            }
            
            // Mostrar mensaje en actividad reciente
            const container = document.getElementById('recentActivity');
            if (container) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay salidas registradas para hoy</p>';
            }
            
            console.log('📊 Dashboard inicializado con datos vacíos');
        }

        async function loadDashboardCharts(authorizations) {
            try {
                console.log('📊 Cargando datos para gráficos...');
                
                // Obtener datos relacionados para gráficos
                const studentIds = [...new Set(authorizations.map(auth => auth.estudiante_id))];
                const reasonIds = [...new Set(authorizations.map(auth => auth.motivo_id))];

                let students = [];
                let reasons = [];

                // Consultas separadas más robustas
                if (studentIds.length > 0) {
                    const { data: studentsData, error: studentsError } = await supabase
                        .from('estudiantes')
                        .select(`
                            id, 
                            nombre, 
                            apellidos,
                            grado:grados(nombre)
                        `)
                        .in('id', studentIds);

                    if (studentsError) {
                        console.error('Error cargando estudiantes:', studentsError);
                    } else {
                        students = studentsData || [];
                    }
                }

                if (reasonIds.length > 0) {
                    const { data: reasonsData, error: reasonsError } = await supabase
                        .from('motivos')
                        .select('id, nombre')
                        .in('id', reasonIds);

                    if (reasonsError) {
                        console.error('Error cargando motivos:', reasonsError);
                    } else {
                        reasons = reasonsData || [];
                    }
                }

                // Crear mapas para búsqueda rápida
                const studentMap = {};
                const reasonMap = {};

                students.forEach(student => {
                    studentMap[student.id] = student;
                });

                reasons.forEach(reason => {
                    reasonMap[reason.id] = reason;
                });

                // Enriquecer datos de autorizaciones
                const enrichedAuthorizations = authorizations.map(auth => ({
                    ...auth,
                    estudiante: studentMap[auth.estudiante_id],
                    motivo: reasonMap[auth.motivo_id]
                }));

                // Crear gráficos con datos enriquecidos
                const pending = enrichedAuthorizations.filter(auth => !auth.salida_efectiva);
                const confirmed = enrichedAuthorizations.filter(auth => auth.salida_efectiva);

                createStatusChart(pending.length, confirmed.length);
                createGradeChart(enrichedAuthorizations);
                createReasonChart(enrichedAuthorizations);
                createTimelineChart(enrichedAuthorizations);

                console.log('✅ Gráficos creados exitosamente');

            } catch (error) {
                console.error('❌ Error cargando datos para gráficos:', error);
                // Crear gráficos básicos en caso de error
                const pending = authorizations.filter(auth => !auth.salida_efectiva);
                const confirmed = authorizations.filter(auth => auth.salida_efectiva);
                createStatusChart(pending.length, confirmed.length);
                createGradeChart([]);
                createReasonChart([]);
                createTimelineChart([]);
            }
        }

        async function loadDashboardActivity(authorizations) {
            try {
                console.log('📊 Cargando actividad reciente...');
                
                const userIds = [...new Set(authorizations.map(auth => auth.usuario_autorizador_id))];
                const vigilanteIds = [...new Set(authorizations.filter(auth => auth.vigilante_id).map(auth => auth.vigilante_id))];
                const allUserIds = [...new Set([...userIds, ...vigilanteIds])];

                let users = [];

                if (allUserIds.length > 0) {
                    const { data: usersData, error: usersError } = await supabase
                        .from('usuarios')
                        .select('id, nombre')
                        .in('id', allUserIds);

                    if (usersError) {
                        console.error('Error cargando usuarios:', usersError);
                    } else {
                        users = usersData || [];
                    }
                }

                const userMap = {};
                users.forEach(user => {
                    userMap[user.id] = user;
                });

                // Enriquecer con datos de usuarios
                const enrichedForActivity = authorizations.map(auth => ({
                    ...auth,
                    usuario: userMap[auth.usuario_autorizador_id],
                    vigilante: userMap[auth.vigilante_id]
                }));

                displayRecentActivity(enrichedForActivity.slice(0, 15));
                console.log('✅ Actividad reciente cargada');

            } catch (error) {
                console.error('❌ Error cargando actividad:', error);
                // Mostrar actividad básica
                displayRecentActivity(authorizations.slice(0, 10));
            }
        }

        function createStatusChart(pendingCount, confirmedCount) {
            try {
                const ctx = document.getElementById('statusChart');
                if (!ctx) {
                    console.error('❌ Elemento statusChart no encontrado');
                    return;
                }
                
                // Verificar que Chart.js esté disponible
                if (typeof Chart === 'undefined') {
                    console.error('❌ Chart.js no está disponible');
                    ctx.parentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Chart.js no está cargado</p>';
                    return;
                }
                
                console.log(`📊 Creando gráfico de estado: ${pendingCount} pendientes, ${confirmedCount} confirmadas`);
                
                // Destruir gráfico existente si existe
                if (dashboardCharts.statusChart) {
                    dashboardCharts.statusChart.destroy();
                }

                // Si no hay datos, mostrar gráfico vacío
                if (pendingCount === 0 && confirmedCount === 0) {
                    dashboardCharts.statusChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Sin datos'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#ecf0f1'],
                                borderColor: ['#bdc3c7'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        font: {
                                            size: 14
                                        }
                                    }
                                }
                            }
                        }
                    });
                    return;
                }

                dashboardCharts.statusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['🟢 Pendientes', '🔵 Confirmadas'],
                        datasets: [{
                            data: [pendingCount, confirmedCount],
                            backgroundColor: ['#2ecc71', '#3498db'],
                            borderColor: ['#27ae60', '#2980b9'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = pendingCount + confirmedCount;
                                        const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('✅ Gráfico de estado creado');
                
            } catch (error) {
                console.error('❌ Error creando gráfico de estado:', error);
                const ctx = document.getElementById('statusChart');
                if (ctx) {
                    ctx.parentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Error cargando gráfico</p>';
                }
            }
        }

        function createGradeChart(authorizations) {
            try {
                const ctx = document.getElementById('gradeChart');
                if (!ctx || typeof Chart === 'undefined') {
                    console.error('❌ gradeChart no disponible o Chart.js no cargado');
                    return;
                }
                
                console.log(`📊 Creando gráfico por grados con ${authorizations.length} autorizaciones`);
                
                // Destruir gráfico existente
                if (dashboardCharts.gradeChart) {
                    dashboardCharts.gradeChart.destroy();
                }

                // Agrupar por grado
                const gradeData = {};
                authorizations.forEach(auth => {
                    const gradeName = auth.estudiante?.grado?.nombre || 'Sin grado';
                    if (!gradeData[gradeName]) {
                        gradeData[gradeName] = { pending: 0, confirmed: 0 };
                    }
                    
                    if (auth.salida_efectiva) {
                        gradeData[gradeName].confirmed++;
                    } else {
                        gradeData[gradeName].pending++;
                    }
                });

                const labels = Object.keys(gradeData);
                const pendingData = labels.map(grade => gradeData[grade].pending);
                const confirmedData = labels.map(grade => gradeData[grade].confirmed);

                // Si no hay datos, mostrar gráfico vacío
                if (labels.length === 0) {
                    dashboardCharts.gradeChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Sin datos'],
                            datasets: [{
                                label: 'Sin datos',
                                data: [0],
                                backgroundColor: '#ecf0f1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 1 }
                                }
                            }
                        }
                    });
                    return;
                }

                dashboardCharts.gradeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '🟢 Pendientes',
                                data: pendingData,
                                backgroundColor: '#2ecc71',
                                borderColor: '#27ae60',
                                borderWidth: 1
                            },
                            {
                                label: '🔵 Confirmadas',
                                data: confirmedData,
                                backgroundColor: '#3498db',
                                borderColor: '#2980b9',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
                
                console.log('✅ Gráfico por grados creado');
                
            } catch (error) {
                console.error('❌ Error creando gráfico por grados:', error);
                const ctx = document.getElementById('gradeChart');
                if (ctx) {
                    ctx.parentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Error cargando gráfico</p>';
                }
            }
        }

        function createReasonChart(authorizations) {
            try {
                const ctx = document.getElementById('reasonChart');
                if (!ctx || typeof Chart === 'undefined') {
                    console.error('❌ reasonChart no disponible o Chart.js no cargado');
                    return;
                }
                
                console.log(`📊 Creando gráfico por motivos con ${authorizations.length} autorizaciones`);
                
                // Destruir gráfico existente
                if (dashboardCharts.reasonChart) {
                    dashboardCharts.reasonChart.destroy();
                }

                // Agrupar por motivo
                const reasonData = {};
                authorizations.forEach(auth => {
                    const reasonName = auth.motivo?.nombre || 'Sin motivo';
                    reasonData[reasonName] = (reasonData[reasonName] || 0) + 1;
                });

                const labels = Object.keys(reasonData);
                const data = Object.values(reasonData);
                const colors = ['#e74c3c', '#f39c12', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#1abc9c'];

                // Si no hay datos
                if (labels.length === 0) {
                    dashboardCharts.reasonChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['Sin datos'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#ecf0f1']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                    return;
                }

                dashboardCharts.reasonChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('✅ Gráfico por motivos creado');
                
            } catch (error) {
                console.error('❌ Error creando gráfico por motivos:', error);
                const ctx = document.getElementById('reasonChart');
                if (ctx) {
                    ctx.parentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Error cargando gráfico</p>';
                }
            }
        }

        function createTimelineChart(authorizations) {
            try {
                const ctx = document.getElementById('timelineChart');
                if (!ctx || typeof Chart === 'undefined') {
                    console.error('❌ timelineChart no disponible o Chart.js no cargado');
                    return;
                }
                
                console.log(`📊 Creando timeline con ${authorizations.length} autorizaciones`);
                
                // Destruir gráfico existente
                if (dashboardCharts.timelineChart) {
                    dashboardCharts.timelineChart.destroy();
                }

                // Agrupar por hora
                const hourlyData = {};
                for (let i = 6; i <= 18; i++) {
                    hourlyData[i] = { pending: 0, confirmed: 0 };
                }

                authorizations.forEach(auth => {
                    if (auth.hora_salida) {
                        const hour = parseInt(auth.hora_salida.split(':')[0]);
                        if (hour >= 6 && hour <= 18) {
                            if (auth.salida_efectiva) {
                                hourlyData[hour].confirmed++;
                            } else {
                                hourlyData[hour].pending++;
                            }
                        }
                    }
                });

                const labels = Object.keys(hourlyData).map(hour => `${hour}:00`);
                const pendingData = Object.values(hourlyData).map(data => data.pending);
                const confirmedData = Object.values(hourlyData).map(data => data.confirmed);

                dashboardCharts.timelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '🟢 Pendientes',
                                data: pendingData,
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: '🔵 Confirmadas',
                                data: confirmedData,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
                
                console.log('✅ Timeline creado');
                
            } catch (error) {
                console.error('❌ Error creando timeline:', error);
                const ctx = document.getElementById('timelineChart');
                if (ctx) {
                    ctx.parentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Error cargando gráfico</p>';
                }
            }
        }

        function displayRecentActivity(authorizations) {
            const container = document.getElementById('recentActivity');
            
            if (!container) {
                console.error('❌ Contenedor recentActivity no encontrado');
                return;
            }
            
            if (!authorizations || authorizations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay actividad reciente en el sistema</p>';
                return;
            }

            console.log(`📋 Mostrando ${authorizations.length} actividades recientes`);

            let html = '';
            authorizations.forEach((auth, index) => {
                try {
                    const isConfirmed = !!auth.salida_efectiva;
                    
                    // Manejar datos faltantes de manera segura
                    const studentName = auth.estudiante ? 
                        `${auth.estudiante.nombre || ''} ${auth.estudiante.apellidos || ''}`.trim() : 
                        'Estudiante no encontrado';
                    
                    const gradeName = auth.estudiante?.grado?.nombre || 'Sin grado';
                    const time = auth.hora_salida ? formatTime(auth.hora_salida) : 'N/A';
                    const authorizedBy = auth.usuario?.nombre || 'Usuario no encontrado';
                    const confirmedBy = auth.vigilante?.nombre || '';
                    
                    // Mostrar hora de creación vs hora de confirmación
                    let activityTime, actionText;
                    
                    if (isConfirmed) {
                        activityTime = auth.salida_efectiva ? formatDateTime(auth.salida_efectiva) : 'N/A';
                        actionText = confirmedBy ? `Confirmada por ${confirmedBy}` : 'Confirmada';
                    } else {
                        activityTime = auth.fecha_creacion ? formatDateTime(auth.fecha_creacion) : 'N/A';
                        actionText = `Autorizada por ${authorizedBy}`;
                    }

                    html += `
                        <div class="student-item ${isConfirmed ? 'confirmed' : 'pending'}">
                            <div class="student-info">
                                <div class="student-name">${sanitizeHtml(studentName)}</div>
                                <div class="student-details">
                                    ${sanitizeHtml(gradeName)} • Hora salida: ${time}<br>
                                    <small>${sanitizeHtml(actionText)} • ${activityTime}</small>
                                </div>
                            </div>
                            <span class="status-badge ${isConfirmed ? 'status-confirmed' : 'status-pending'}">
                                ${isConfirmed ? '🔵 Confirmada' : '🟢 Pendiente'}
                            </span>
                        </div>
                    `;
                } catch (error) {
                    console.error(`❌ Error procesando actividad ${index}:`, error, auth);
                    // Continuar con el siguiente elemento en lugar de fallar completamente
                }
            });

            container.innerHTML = html || '<p style="text-align: center; color: #666; padding: 20px;">Error al mostrar actividades</p>';
        }

        // ========================================
        // FUNCIONES ESPECÍFICAS PARA VIGILANCIA
        // ========================================

        function showMyConfirmedExits() {
            // Alternar visibilidad de las secciones
            const myConfirmedSection = document.getElementById('myConfirmedSection');
            const pendingSection = document.getElementById('pendingExitsSection');
            const searchSection = document.getElementById('searchSection');
            
            if (myConfirmedSection.style.display === 'none') {
                myConfirmedSection.style.display = 'block';
                pendingSection.style.display = 'none';
                searchSection.style.display = 'none';
                loadMyConfirmedExits();
            } else {
                myConfirmedSection.style.display = 'none';
                pendingSection.style.display = 'block';
                loadPendingExits();
            }
        }

        async function loadMyConfirmedExits() {
            const confirmedList = document.getElementById('myConfirmedList');
            
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                confirmedList.innerHTML = '<div class="card" style="text-align: center; padding: 20px;"><p style="color: #666;">🔄 Cargando mis confirmaciones...</p></div>';
                
                const todayColombia = getColombiaDate();
                console.log(`📋 Cargando salidas confirmadas por ${currentUser.nombre} para Colombia:`, todayColombia);
                
                // Obtener autorizaciones confirmadas por el vigilante actual
                const { data: myConfirmations, error } = await supabase
                    .from('autorizaciones_salida')
                    .select('*')
                    .eq('fecha_salida', todayColombia)
                    .eq('vigilante_id', currentUser.id)
                    .not('salida_efectiva', 'is', null)
                    .order('salida_efectiva', { ascending: false });

                if (error) {
                    console.error('❌ Error al cargar mis confirmaciones:', error);
                    throw error;
                }

                if (!myConfirmations || myConfirmations.length === 0) {
                    const currentTime = getColombiaTime();
                    confirmedList.innerHTML = `
                        <div class="verification-card" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d);">
                            <h3>📋 Sin confirmaciones aún</h3>
                            <p><strong>No has confirmado salidas hoy</strong></p>
                            <p>Fecha: ${formatDate(todayColombia)} - Hora: ${currentTime}</p>
                            <p>Las salidas que confirmes aparecerán aquí</p>
                        </div>
                    `;
                    return;
                }

                console.log('📊 Mis confirmaciones encontradas:', myConfirmations.length);

                // Obtener información adicional de estudiantes, motivos y usuarios
                const studentIds = [...new Set(myConfirmations.map(auth => auth.estudiante_id))];
                const reasonIds = [...new Set(myConfirmations.map(auth => auth.motivo_id))];
                const userIds = [...new Set(myConfirmations.map(auth => auth.usuario_autorizador_id))];

                const [studentsResult, reasonsResult, usersResult] = await Promise.all([
                    supabase
                        .from('estudiantes')
                        .select('id, nombre, apellidos, grado:grados(nombre)')
                        .in('id', studentIds),
                    supabase
                        .from('motivos')
                        .select('id, nombre')
                        .in('id', reasonIds),
                    supabase
                        .from('usuarios')
                        .select('id, nombre')
                        .in('id', userIds)
                ]);

                // Crear mapas para búsqueda rápida
                const studentMap = {};
                const reasonMap = {};
                const userMap = {};

                studentsResult.data?.forEach(student => {
                    studentMap[student.id] = student;
                });

                reasonsResult.data?.forEach(reason => {
                    reasonMap[reason.id] = reason;
                });

                usersResult.data?.forEach(user => {
                    userMap[user.id] = user;
                });

                // Generar HTML para cada confirmación
                const currentTime = getColombiaTime();
                let html = `<div style="text-align: center; margin-bottom: 25px; background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px;">
                    <p style="color: #2c3e50; font-weight: bold; font-size: 16px;">📅 ${formatDate(todayColombia)} - 🕐 ${currentTime} (Hora Colombia)</p>
                    <p style="color: #7f8c8d; margin-top: 8px;">Salidas confirmadas por mí: <strong>${myConfirmations.length}</strong></p>
                </div>`;
                
                myConfirmations.forEach(auth => {
                    const student = studentMap[auth.estudiante_id];
                    const reason = reasonMap[auth.motivo_id];
                    const user = userMap[auth.usuario_autorizador_id];

                    html += `
                        <div class="verification-card verified">
                            <h3>✅ SALIDA CONFIRMADA POR MÍ</h3>
                            
                            <div class="verification-card-content">
                                <div class="verification-card-info">
                                    <p>
                                        <strong>👨‍🎓 Estudiante:</strong>
                                        <span class="info-value">${student ? sanitizeHtml(`${student.nombre} ${student.apellidos}`) : 'No encontrado'}</span>
                                    </p>
                                    <p>
                                        <strong>🎓 Grado:</strong>
                                        <span class="info-value">${student?.grado?.nombre ? sanitizeHtml(student.grado.nombre) : 'No encontrado'}</span>
                                    </p>
                                </div>
                                <div class="verification-card-info">
                                    <p>
                                        <strong>📝 Motivo de Salida:</strong>
                                        <span class="info-value">${reason?.nombre ? sanitizeHtml(reason.nombre) : 'No encontrado'}</span>
                                    </p>
                                    <p>
                                        <strong>🕐 Hora Autorizada:</strong>
                                        <span class="info-value">${formatTime(auth.hora_salida)}</span>
                                    </p>
                                </div>
                            </div>
                            
                            <div class="verification-card-footer">
                                <p><strong>✅ Autorizado por:</strong> ${user?.nombre ? sanitizeHtml(user.nombre) : 'No encontrado'}</p>
                                ${auth.observaciones ? `
                                    <div class="verification-card-obs">
                                        <strong>📝 Observaciones:</strong><br>
                                        ${sanitizeHtml(auth.observaciones)}
                                    </div>
                                ` : ''}
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                                    <p style="color: white; font-weight: bold; margin: 0;">
                                        ✅ CONFIRMADA: ${formatDateTime(auth.salida_efectiva)}<br>
                                        <small>Confirmada por: ${sanitizeHtml(currentUser.nombre)}</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                confirmedList.innerHTML = html;
                console.log('✅ Mis confirmaciones cargadas exitosamente');

            } catch (error) {
                console.error('❌ Error general:', error);
                await logSecurityEvent('error', 'Error al cargar confirmaciones del vigilante', { 
                    vigilanteId: currentUser.id,
                    error: error.message.substring(0, 200) 
                }, false);
                confirmedList.innerHTML = `
                    <div class="verification-card not-authorized">
                        <h3>❌ Error al cargar</h3>
                        <p>No se pudieron cargar mis confirmaciones</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <button class="btn btn-secondary" onclick="loadMyConfirmedExits()" style="margin-top: 10px;">
                            🔄 Intentar de nuevo
                        </button>
                    </div>
                `;
            }
        }

        async function refreshDashboard() {
            try {
                console.log('🔄 Iniciando actualización manual del dashboard...');
                showSuccess('Actualizando dashboard...');
                
                // Limpiar datos actuales
                document.getElementById('dashPendingCount').textContent = '...';
                document.getElementById('dashConfirmedCount').textContent = '...';
                document.getElementById('dashTotalCount').textContent = '...';
                document.getElementById('dashRecentCount').textContent = '...';
                
                // Recargar dashboard
                await loadDashboard();
                
                const currentTime = getColombiaTime();
                showSuccess(`✅ Dashboard actualizado exitosamente a las ${currentTime}`);
                console.log('✅ Actualización manual completada');
                
            } catch (error) {
                console.error('❌ Error en actualización manual:', error);
                showError('Error al actualizar el dashboard: ' + error.message);
            }
        }

        // Función de debug mejorada para verificar datos
        async function debugDashboard() {
            try {
                console.log('🔧 === DEBUG DASHBOARD COMPLETO ===');
                const todayColombia = getColombiaDate();
                console.log('📅 Fecha Colombia:', todayColombia);
                
                // 1. Verificar dependencias críticas
                console.log('📊 === VERIFICACIÓN DE DEPENDENCIAS ===');
                console.log('Chart.js disponible:', typeof Chart !== 'undefined');
                if (typeof Chart !== 'undefined') {
                    console.log('Chart.js versión:', Chart.version || 'Versión no disponible');
                } else {
                    console.error('❌ Chart.js NO ESTÁ CARGADO');
                    
                    // Intentar cargar Chart.js ahora
                    console.log('🔄 Intentando cargar Chart.js...');
                    try {
                        const loaded = await ensureChartJSLoaded();
                        console.log('Chart.js carga forzada:', loaded ? 'ÉXITO' : 'FALLÓ');
                    } catch (error) {
                        console.error('❌ Error cargando Chart.js:', error.message);
                    }
                }
                
                console.log('Supabase disponible:', typeof supabase !== 'undefined');
                console.log('CryptoJS disponible:', typeof CryptoJS !== 'undefined');
                
                // 2. Verificar elementos del DOM
                console.log('📊 === VERIFICACIÓN DE ELEMENTOS DOM ===');
                const elements = [
                    'statusChart', 'gradeChart', 'reasonChart', 'timelineChart', 'recentActivity',
                    'dashPendingCount', 'dashConfirmedCount', 'dashTotalCount', 'dashRecentCount'
                ];
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    console.log(`🎯 Elemento ${id}:`, element ? 'ENCONTRADO' : '❌ NO ENCONTRADO');
                    if (element && id.includes('Chart')) {
                        console.log(`   Canvas ${id} dimensiones:`, element.offsetWidth, 'x', element.offsetHeight);
                    }
                });
                
                // 3. Probar consulta de base de datos
                console.log('📊 === VERIFICACIÓN DE BASE DE DATOS ===');
                
                try {
                    const { data, error } = await supabase
                        .from('autorizaciones_salida')
                        .select('*')
                        .eq('fecha_salida', todayColombia);
                        
                    console.log('📊 Consulta básica autorizaciones:', {
                        error: error ? error.message : 'Sin error',
                        count: data ? data.length : 0,
                        sample: data && data.length > 0 ? data[0] : 'No hay datos'
                    });
                    
                    if (data && data.length > 0) {
                        const pending = data.filter(auth => !auth.salida_efectiva);
                        const confirmed = data.filter(auth => auth.salida_efectiva);
                        console.log('📈 Estadísticas calculadas:', {
                            total: data.length,
                            pendientes: pending.length,
                            confirmadas: confirmed.length
                        });
                    }
                    
                } catch (dbError) {
                    console.error('❌ Error en consulta de base de datos:', dbError);
                }
                
                // 4. Verificar tablas relacionadas
                console.log('📊 === VERIFICACIÓN DE TABLAS RELACIONADAS ===');
                try {
                    const [estudiantes, motivos, usuarios] = await Promise.all([
                        supabase.from('estudiantes').select('*').limit(1),
                        supabase.from('motivos').select('*').limit(1),
                        supabase.from('usuarios').select('*').limit(1)
                    ]);
                    
                    console.log('📊 Tablas relacionadas:', {
                        estudiantes: estudiantes.data ? `${estudiantes.data.length} encontrados` : `Error: ${estudiantes.error?.message}`,
                        motivos: motivos.data ? `${motivos.data.length} encontrados` : `Error: ${motivos.error?.message}`,
                        usuarios: usuarios.data ? `${usuarios.data.length} encontrados` : `Error: ${usuarios.error?.message}`
                    });
                } catch (tablesError) {
                    console.error('❌ Error verificando tablas relacionadas:', tablesError);
                }
                
                // 5. Verificar estado actual del dashboard
                console.log('📊 === ESTADO ACTUAL DEL DASHBOARD ===');
                const currentStats = {
                    pendientes: document.getElementById('dashPendingCount')?.textContent || 'N/A',
                    confirmadas: document.getElementById('dashConfirmedCount')?.textContent || 'N/A',
                    total: document.getElementById('dashTotalCount')?.textContent || 'N/A',
                    recientes: document.getElementById('dashRecentCount')?.textContent || 'N/A'
                };
                console.log('📊 Estadísticas mostradas:', currentStats);
                
                // 6. Verificar gráficos existentes
                console.log('📊 === ESTADO DE GRÁFICOS ===');
                console.log('Gráficos en dashboardCharts:', Object.keys(dashboardCharts || {}));
                
                // 7. Intentar crear un gráfico de prueba
                if (typeof Chart !== 'undefined') {
                    console.log('🧪 === PRUEBA DE CREACIÓN DE GRÁFICO ===');
                    try {
                        const testCanvas = document.createElement('canvas');
                        testCanvas.width = 100;
                        testCanvas.height = 100;
                        
                        const testChart = new Chart(testCanvas, {
                            type: 'doughnut',
                            data: {
                                labels: ['Prueba'],
                                datasets: [{
                                    data: [1],
                                    backgroundColor: ['#2ecc71']
                                }]
                            },
                            options: {
                                responsive: false,
                                animation: false
                            }
                        });
                        
                        console.log('✅ Gráfico de prueba creado exitosamente');
                        testChart.destroy();
                    } catch (chartError) {
                        console.error('❌ Error creando gráfico de prueba:', chartError);
                    }
                }
                
                console.log('🔧 === FIN DEBUG COMPLETO ===');
                
                // Mostrar resumen en la UI
                showSuccess('Debug completado. Revisa la consola del navegador para detalles completos.');
                
            } catch (error) {
                console.error('❌ Error en debug completo:', error);
                showError('Error en debug: ' + error.message);
            }
        }

        async function exportDashboardData() {
            try {
                const todayColombia = getColombiaDate();
                
                const { data: authorizations, error } = await supabase
                    .from('autorizaciones_salida')
                    .select(`
                        *,
                        estudiante:estudiantes(nombre, apellidos, documento, grado:grados(nombre)),
                        motivo:motivos(nombre),
                        usuario:usuarios(nombre),
                        vigilante:usuarios!autorizaciones_salida_vigilante_id_fkey(nombre)
                    `)
                    .eq('fecha_salida', todayColombia);

                if (error) throw error;

                // Crear CSV con información completa
                const csvContent = generateCSVFromData(authorizations);
                downloadCSV(csvContent, `dashboard_salidas_general_${todayColombia}.csv`);
                
                await logSecurityEvent('export', 'Exportación de datos del dashboard', { 
                    fecha: todayColombia,
                    registros: authorizations.length 
                }, true);
                
                showSuccess(`Datos exportados exitosamente: ${authorizations.length} registros`);
                
            } catch (error) {
                console.error('Error exportando datos:', error);
                await logSecurityEvent('error', 'Error al exportar datos del dashboard', { 
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al exportar datos: ' + error.message);
            }
        }

        function generateCSVFromData(data) {
            const headers = [
                'Estudiante', 
                'Documento', 
                'Grado', 
                'Motivo', 
                'Fecha Salida', 
                'Hora Salida', 
                'Estado', 
                'Autorizado Por', 
                'Fecha Autorización',
                'Confirmado Por',
                'Fecha Confirmación',
                'Observaciones'
            ];
            
            const rows = data.map(auth => [
                auth.estudiante ? `${auth.estudiante.nombre} ${auth.estudiante.apellidos}` : '',
                auth.estudiante?.documento || '',
                auth.estudiante?.grado?.nombre || '',
                auth.motivo?.nombre || '',
                auth.fecha_salida,
                auth.hora_salida,
                auth.salida_efectiva ? 'Confirmada' : 'Pendiente',
                auth.usuario?.nombre || '',
                auth.fecha_creacion,
                auth.vigilante?.nombre || '',
                auth.salida_efectiva || '',
                auth.observaciones || ''
            ]);

            return [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function forceReloadCharts() {
            try {
                console.log('🔄 Forzando recarga de gráficos...');
                showSuccess('Intentando recargar Chart.js...');
                
                // Mostrar estado
                const statusDiv = document.getElementById('chartjsStatus');
                const statusText = document.getElementById('chartjsStatusText');
                
                if (statusDiv && statusText) {
                    statusDiv.style.display = 'block';
                    statusText.textContent = 'Recargando Chart.js...';
                }
                
                // Intentar cargar Chart.js de nuevo
                const loaded = await ensureChartJSLoaded();
                
                if (loaded) {
                    console.log('✅ Chart.js recargado exitosamente');
                    if (statusText) {
                        statusText.textContent = 'Chart.js cargado ✅';
                        statusText.style.color = '#2ecc71';
                    }
                    
                    showSuccess('Chart.js cargado exitosamente. Actualizando dashboard...');
                    
                    // Recargar dashboard con gráficos
                    setTimeout(async () => {
                        await loadDashboard();
                        showSuccess('Dashboard actualizado con gráficos completos');
                    }, 500);
                    
                } else {
                    console.error('❌ No se pudo cargar Chart.js');
                    if (statusText) {
                        statusText.textContent = 'Chart.js no disponible ❌';
                        statusText.style.color = '#e74c3c';
                    }
                    showError('No se pudo cargar Chart.js. El dashboard funcionará en modo simplificado.');
                }
                
            } catch (error) {
                console.error('❌ Error forzando recarga de gráficos:', error);
                showError('Error al recargar gráficos: ' + error.message);
                
                const statusText = document.getElementById('chartjsStatusText');
                if (statusText) {
                    statusText.textContent = 'Error cargando Chart.js ❌';
                    statusText.style.color = '#e74c3c';
                }
            }
        }

        function updateChartJSStatus() {
            const statusDiv = document.getElementById('chartjsStatus');
            const statusText = document.getElementById('chartjsStatusText');
            
            if (!statusDiv || !statusText) return;
            
            statusDiv.style.display = 'block';
            
            if (typeof Chart !== 'undefined') {
                statusText.textContent = `Chart.js ${Chart.version || 'cargado'} ✅`;
                statusText.style.color = '#2ecc71';
            } else {
                statusText.textContent = 'Chart.js no disponible ❌';
                statusText.style.color = '#e74c3c';
            }
        }

        // ========================================
        // FUNCIONES DE SCROLL MEJORADO PARA TABLAS
        // ========================================

        function setupTableScroll() {
            const tableWrappers = document.querySelectorAll('.table-wrapper');
            
            tableWrappers.forEach(wrapper => {
                // Configurar listeners de scroll
                wrapper.addEventListener('scroll', function() {
                    updateScrollIndicators(this);
                });

                // Configurar scroll inicial
                updateScrollIndicators(wrapper);
                
                // Agregar smooth scrolling
                wrapper.style.scrollBehavior = 'smooth';
            });
        }

        function updateScrollIndicators(wrapper) {
            const scrollLeft = wrapper.scrollLeft;
            const scrollWidth = wrapper.scrollWidth;
            const clientWidth = wrapper.clientWidth;
            
            // Verificar si necesita scroll
            if (scrollWidth <= clientWidth) {
                wrapper.classList.remove('has-scroll-left', 'has-scroll-right');
                return;
            }

            // Indicador izquierdo (hay contenido a la izquierda)
            if (scrollLeft > 5) {
                wrapper.classList.add('has-scroll-left');
            } else {
                wrapper.classList.remove('has-scroll-left');
            }

            // Indicador derecho (hay contenido a la derecha)
            if (scrollLeft < scrollWidth - clientWidth - 5) {
                wrapper.classList.add('has-scroll-right');
            } else {
                wrapper.classList.remove('has-scroll-right');
            }
        }

        // Función para centrar una columna específica en la vista
        function scrollToColumn(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const wrapper = table.closest('.table-wrapper');
            if (!wrapper) return;

            const headerCells = table.querySelectorAll('thead th');
            if (columnIndex >= headerCells.length) return;

            const targetCell = headerCells[columnIndex];
            const cellLeft = targetCell.offsetLeft;
            const cellWidth = targetCell.offsetWidth;
            const wrapperWidth = wrapper.clientWidth;

            // Calcular posición para centrar la columna
            const scrollPosition = cellLeft - (wrapperWidth / 2) + (cellWidth / 2);
            
            wrapper.scrollTo({
                left: Math.max(0, scrollPosition),
                behavior: 'smooth'
            });
        }

        // Función para mejorar la experiencia táctil
        function enhanceTouchExperience() {
            // Agregar feedback táctil a botones
            const buttons = document.querySelectorAll('.btn');
            
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                }, { passive: true });
                
                button.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 100);
                }, { passive: true });
            });
        }

        // Función para manejar el cambio de orientación
        function handleOrientationChange() {
            // Esperar a que la orientación cambie completamente
            setTimeout(() => {
                detectDeviceAndAdjustUI();
                optimizeTableScroll();
            }, 200);
        }

        // Función para optimizar el viewport en dispositivos móviles
        function optimizeViewport() {
            // Prevenir zoom en inputs en iOS
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    if (window.innerWidth <= 480) {
                        // Scroll suave al input enfocado
                        setTimeout(() => {
                            this.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }, 300);
                    }
                });
            });
        }

        // Función para crear botones de acción rápida en móvil
        function createMobileQuickActions() {
            if (window.innerWidth > 480) return;
            
            const quickActions = document.createElement('div');
            quickActions.id = 'mobileQuickActions';
            quickActions.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 999;
                display: flex;
                flex-direction: column;
                gap: 10px;
            `;
            
            // Botón de scroll to top
            const scrollTopBtn = document.createElement('button');
            scrollTopBtn.innerHTML = '↑';
            scrollTopBtn.className = 'btn btn-secondary';
            scrollTopBtn.style.cssText = `
                width: 50px;
                height: 50px;
                border-radius: 50%;
                font-size: 20px;
                font-weight: bold;
                display: none;
            `;
            
            scrollTopBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
            
            // Mostrar/ocultar botón según scroll
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                if (window.scrollY > 200) {
                    scrollTopBtn.style.display = 'block';
                } else {
                    scrollTopBtn.style.display = 'none';
                }
                
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    if (window.scrollY > 200) {
                        scrollTopBtn.style.opacity = '0.7';
                    }
                }, 2000);
            });
            
            quickActions.appendChild(scrollTopBtn);
            document.body.appendChild(quickActions);
        }
        
        // Configuración de Supabase
        const SUPABASE_URL = 'https://mbosvnmhnbrslfwlfcxu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ib3N2bm1obmJyc2xmd2xmY3h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1ODU2MzUsImV4cCI6MjA2NTE2MTYzNX0.evgs5gWsCRyfeo273tLiAAoIdB-IjMaPq8U23xK4lqc';
        
        // Configuración de cifrado
        const ENCRYPTION_KEY = 'GemellisecureSystem2024@#$%^&*()';
        
        let supabase;
        let currentUser = null;
        let currentEditingId = null;
        let sessionToken = null;
        let loginAttempts = 0;
        let lastLoginAttempt = null;
        let sessionStartTime = null;
        let sessionTimeout = null;

        // Configuración de seguridad
        const MAX_LOGIN_ATTEMPTS = 5;
        const LOGIN_COOLDOWN = 300000; // 5 minutos
        const SESSION_TIMEOUT = 1800000; // 30 minutos
        const SECURE_HEADERS = {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRF-Token': generateCSRFToken()
        };

        // ========================================
        // FUNCIONES DE SEGURIDAD AVANZADAS
        // ========================================

        // Generar token CSRF
        function generateCSRFToken() {
            return 'csrf_' + Date.now() + '_' + Math.random().toString(36).substr(2, 16);
        }

        // Función de sanitización XSS mejorada
        function sanitizeHtml(str) {
            if (!str) return '';
            
            // Crear elemento temporal para escape
            const temp = document.createElement('div');
            temp.textContent = str;
            let escaped = temp.innerHTML;
            
            // Filtros adicionales contra XSS
            escaped = escaped.replace(/javascript:/gi, '')
                           .replace(/vbscript:/gi, '')
                           .replace(/data:/gi, '')
                           .replace(/on\w+=/gi, '')
                           .replace(/<script[^>]*>.*?<\/script>/gi, '')
                           .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '')
                           .replace(/<object[^>]*>.*?<\/object>/gi, '')
                           .replace(/<embed[^>]*>/gi, '')
                           .replace(/<link[^>]*>/gi, '')
                           .replace(/<meta[^>]*>/gi, '');
            
            return escaped;
        }

        // Función de cifrado de contraseñas
        function encryptPassword(password) {
            if (!password) return '';
            try {
                // Crear salt único
                const salt = CryptoJS.lib.WordArray.random(32);
                const iterations = 10000;
                
                // Derivar clave usando PBKDF2
                const key = CryptoJS.PBKDF2(password, salt, {
                    keySize: 256/32,
                    iterations: iterations,
                    hasher: CryptoJS.algo.SHA256
                });
                
                // Cifrar con AES
                const encrypted = CryptoJS.AES.encrypt(password, key.toString()).toString();
                
                // Combinar salt + iterations + encrypted
                return salt.toString() + ':' + iterations + ':' + encrypted;
            } catch (error) {
                console.error('Error al cifrar contraseña:', error);
                return CryptoJS.SHA256(password).toString(); // Fallback a SHA256
            }
        }

        // Función para verificar contraseña
        function verifyPassword(password, hash) {
            if (!password || !hash) return false;
            
            try {
                // Si es el formato nuevo (salt:iterations:encrypted)
                if (hash.includes(':')) {
                    const parts = hash.split(':');
                    if (parts.length === 3) {
                        const salt = CryptoJS.enc.Hex.parse(parts[0]);
                        const iterations = parseInt(parts[1]);
                        const encrypted = parts[2];
                        
                        // Derivar la misma clave
                        const key = CryptoJS.PBKDF2(password, salt, {
                            keySize: 256/32,
                            iterations: iterations,
                            hasher: CryptoJS.algo.SHA256
                        });
                        
                        // Intentar descifrar
                        try {
                            const decrypted = CryptoJS.AES.decrypt(encrypted, key.toString()).toString(CryptoJS.enc.Utf8);
                            return decrypted === password;
                        } catch {
                            return false;
                        }
                    }
                }
                
                // Fallback: comparación directa para contraseñas no cifradas (legacy)
                return password === hash;
                
            } catch (error) {
                console.error('Error al verificar contraseña:', error);
                return false;
            }
        }

        // Validación de email mejorada
        function validateEmail(email) {
            if (!email) return false;
            
            // Verificar longitud
            if (email.length > 100) return false;
            
            // Patrón RFC compliant
            const emailPattern = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            
            // Verificar patrón básico
            if (!emailPattern.test(email)) return false;
            
            // Verificar caracteres peligrosos
            const dangerousChars = /<|>|"|'|;|&|javascript:|vbscript:|data:/i;
            if (dangerousChars.test(email)) return false;
            
            return true;
        }

        // Validación de contraseña mejorada
        function validatePassword(password) {
            if (!password) return false;
            if (password.length < 8 || password.length > 50) return false;
            
            // Verificar caracteres peligrosos
            const dangerousChars = /<|>|"|'|;|&|javascript:|vbscript:|data:/i;
            if (dangerousChars.test(password)) return false;
            
            return true;
        }

        // Validación de nombres
        function validateName(name) {
            if (!name) return false;
            if (name.length < 2 || name.length > 50) return false;
            
            // Solo letras, espacios y acentos
            const namePattern = /^[A-Za-zÀ-ÿ\u00f1\u00d1\s]{2,50}$/;
            if (!namePattern.test(name)) return false;
            
            // Verificar caracteres peligrosos
            const dangerousChars = /<|>|"|'|;|&|javascript:|vbscript:|data:/i;
            if (dangerousChars.test(name)) return false;
            
            return true;
        }

        // Validación de documento
        function validateDocument(document) {
            if (!document) return true; // Es opcional
            
            // Solo números, 6-20 dígitos
            const docPattern = /^[0-9]{6,20}$/;
            return docPattern.test(document);
        }

        // Validación de texto general
        function validateText(text) {
            if (!text) return true; // Campos opcionales
            
            // Verificar caracteres peligrosos
            const dangerousChars = /<script|<iframe|<object|<embed|javascript:|vbscript:|data:|on\w+=/i;
            if (dangerousChars.test(text)) return false;
            
            return true;
        }

        // ========================================
        // FUNCIONES DE VALIDACIÓN EN TIEMPO REAL
        // ========================================

        function validateEmailInput(input) {
            const value = input.value.trim();
            
            if (!value) {
                input.className = input.className.replace(/input-(secure|warning|error)/g, '');
                return;
            }
            
            if (validateEmail(value)) {
                input.className = input.className.replace(/input-(warning|error)/g, '');
                input.classList.add('input-secure');
            } else {
                input.className = input.className.replace(/input-(secure|warning)/g, '');
                input.classList.add('input-error');
            }
        }

        function validatePasswordInput(input) {
            const value = input.value;
            
            if (!value) {
                input.className = input.className.replace(/input-(secure|warning|error)/g, '');
                return;
            }
            
            if (validatePassword(value)) {
                const strength = calculatePasswordStrength(value);
                if (strength >= 4) {
                    input.className = input.className.replace(/input-(warning|error)/g, '');
                    input.classList.add('input-secure');
                } else {
                    input.className = input.className.replace(/input-(secure|error)/g, '');
                    input.classList.add('input-warning');
                }
            } else {
                input.className = input.className.replace(/input-(secure|warning)/g, '');
                input.classList.add('input-error');
            }
        }

        function validateNameInput(input) {
            const value = input.value.trim();
            
            if (!value) {
                input.className = input.className.replace(/input-(secure|warning|error)/g, '');
                return;
            }
            
            if (validateName(value)) {
                input.className = input.className.replace(/input-(warning|error)/g, '');
                input.classList.add('input-secure');
            } else {
                input.className = input.className.replace(/input-(secure|warning)/g, '');
                input.classList.add('input-error');
            }
        }

        function validateDocumentInput(input) {
            const value = input.value.trim();
            
            if (!value) {
                input.className = input.className.replace(/input-(secure|warning|error)/g, '');
                return;
            }
            
            if (validateDocument(value)) {
                input.className = input.className.replace(/input-(warning|error)/g, '');
                input.classList.add('input-secure');
            } else {
                input.className = input.className.replace(/input-(secure|warning)/g, '');
                input.classList.add('input-error');
            }
        }

        function validateTextInput(input) {
            const value = input.value;
            
            if (!value) {
                input.className = input.className.replace(/input-(secure|warning|error)/g, '');
                return;
            }
            
            if (validateText(value)) {
                input.className = input.className.replace(/input-(warning|error)/g, '');
                input.classList.add('input-secure');
            } else {
                input.className = input.className.replace(/input-(secure|warning)/g, '');
                input.classList.add('input-error');
            }
        }

        function validateSearchInput(input) {
            const value = input.value.trim();
            
            if (!value) {
                input.className = input.className.replace(/input-(secure|warning|error)/g, '');
                return;
            }
            
            if (validateText(value) && value.length >= 3) {
                input.className = input.className.replace(/input-(warning|error)/g, '');
                input.classList.add('input-secure');
                
                // Trigger search with debounce
                clearTimeout(input.searchTimeout);
                input.searchTimeout = setTimeout(() => {
                    searchStudent();
                }, 500);
            } else if (value.length < 3) {
                input.className = input.className.replace(/input-(secure|error)/g, '');
                input.classList.add('input-warning');
            } else {
                input.className = input.className.replace(/input-(secure|warning)/g, '');
                input.classList.add('input-error');
            }
        }

        // ========================================
        // FUNCIONES DE TOKENS Y SESIONES SEGURAS
        // ========================================

        function generateSecureToken() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return 'sess_' + Date.now() + '_' + Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        function validateSession() {
            if (!sessionToken || !sessionStartTime) {
                return false;
            }
            
            const now = Date.now();
            if (now - sessionStartTime > SESSION_TIMEOUT) {
                return false;
            }
            
            return true;
        }

        function renewSession() {
            if (validateSession()) {
                sessionStartTime = Date.now();
                resetSessionTimeout();
                return true;
            }
            return false;
        }

        // ========================================
        // FUNCIONES DE RATE LIMITING MEJORADAS
        // ========================================

        function checkRateLimit() {
            const now = Date.now();
            const clientId = getClientId();
            
            // Obtener intentos desde localStorage (por cliente)
            const attemptsKey = `login_attempts_${clientId}`;
            const lastAttemptKey = `last_attempt_${clientId}`;
            
            const storedAttempts = localStorage.getItem(attemptsKey);
            const storedLastAttempt = localStorage.getItem(lastAttemptKey);
            
            const attempts = storedAttempts ? parseInt(storedAttempts) : 0;
            const lastAttempt = storedLastAttempt ? parseInt(storedLastAttempt) : 0;
            
            if (attempts >= MAX_LOGIN_ATTEMPTS) {
                if (now - lastAttempt < LOGIN_COOLDOWN) {
                    const remainingTime = Math.ceil((LOGIN_COOLDOWN - (now - lastAttempt)) / 1000);
                    showRateLimitWarning(remainingTime);
                    return false;
                } else {
                    // Reset intentos después del cooldown
                    localStorage.setItem(attemptsKey, '0');
                    localStorage.removeItem(lastAttemptKey);
                }
            }
            
            return true;
        }

        function recordFailedAttempt() {
            const clientId = getClientId();
            const attemptsKey = `login_attempts_${clientId}`;
            const lastAttemptKey = `last_attempt_${clientId}`;
            
            const storedAttempts = localStorage.getItem(attemptsKey);
            const attempts = storedAttempts ? parseInt(storedAttempts) + 1 : 1;
            
            localStorage.setItem(attemptsKey, attempts.toString());
            localStorage.setItem(lastAttemptKey, Date.now().toString());
        }

        function getClientId() {
            let clientId = localStorage.getItem('client_id');
            if (!clientId) {
                clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('client_id', clientId);
            }
            return clientId;
        }

        // ========================================
        // FUNCIONES DE CAPTCHA
        // ========================================

        function validateCaptcha() {
            const captchaResponse = hcaptcha.getResponse();
            if (!captchaResponse) {
                showError('Por favor, completa el CAPTCHA de verificación');
                return false;
            }
            return true;
        }

        function resetCaptcha() {
            if (typeof hcaptcha !== 'undefined') {
                hcaptcha.reset();
            }
        }

        // ========================================
        // FUNCIONES DE AUDITORÍA MEJORADAS
        // ========================================

        async function logSecurityEvent(type, action, details = {}, success = true) {
            try {
                const now = new Date();
                const userAgent = navigator.userAgent;
                const clientId = getClientId();
                
                // Obtener información de geolocalización (opcional)
                let location = 'No disponible';
                if (navigator.geolocation && currentUser) {
                    // Solo para usuarios autenticados y con permiso
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            location = `${position.coords.latitude},${position.coords.longitude}`;
                        },
                        () => {
                            location = 'Geolocalización no disponible';
                        },
                        { timeout: 5000 }
                    );
                }

                const logEntry = {
                    usuario_id: currentUser?.id || null,
                    tipo: sanitizeHtml(type),
                    accion: sanitizeHtml(action),
                    detalles: JSON.stringify({
                        ...details,
                        clientId: clientId,
                        sessionToken: sessionToken ? sessionToken.substring(0, 20) + '...' : null,
                        userAgent: userAgent.substring(0, 200), // Limitar longitud
                        timestamp: now.toISOString(),
                        location: location
                    }),
                    ip_address: 'Cliente', // En producción, obtener desde el servidor
                    user_agent: userAgent.substring(0, 500), // Limitar longitud
                    exitoso: success,
                    timestamp: now.toISOString()
                };

                await supabase
                    .from('audit_logs')
                    .insert([logEntry]);
                    
                console.log('🔒 Evento de seguridad registrado:', type, action);
                
            } catch (error) {
                console.error('Error al registrar evento de seguridad:', error);
                // No mostrar error al usuario para no revelar información del sistema
            }
        }

        // ========================================
        // FUNCIONES DE INDICADORES DE SEGURIDAD
        // ========================================

        function updateSecurityIndicator(status, message) {
            const indicator = document.getElementById('securityIndicator');
            if (!indicator) return;
            
            indicator.className = 'security-indicator';
            
            switch (status) {
                case 'secure':
                    indicator.classList.add('secure');
                    indicator.innerHTML = '🔒 ' + message;
                    break;
                case 'warning':
                    indicator.classList.add('warning');
                    indicator.innerHTML = '⚠️ ' + message;
                    break;
                case 'error':
                    indicator.classList.add('error');
                    indicator.innerHTML = '🚨 ' + message;
                    break;
            }
        }

        // ========================================
        // FUNCIONES DE FUERZA DE CONTRASEÑA
        // ========================================

        function calculatePasswordStrength(password) {
            if (!password) return 0;
            
            let strength = 0;
            
            // Longitud
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            
            // Complejidad
            if (password.match(/[a-z]+/)) strength++;
            if (password.match(/[A-Z]+/)) strength++;
            if (password.match(/[0-9]+/)) strength++;
            if (password.match(/[^a-zA-Z0-9]+/)) strength++;
            
            // Patrones comunes (penalizar)
            const commonPatterns = ['123456', 'password', 'qwerty', 'abc123', '111111'];
            if (commonPatterns.some(pattern => password.toLowerCase().includes(pattern))) {
                strength = Math.max(0, strength - 2);
            }
            
            return Math.min(strength, 6);
        }

        function checkPasswordStrength() {
            const password = document.getElementById('userPassword').value;
            const strengthDiv = document.getElementById('userPasswordStrength');
            
            if (!password) {
                strengthDiv.style.display = 'none';
                return;
            }
            
            strengthDiv.style.display = 'block';
            
            const strength = calculatePasswordStrength(password);
            
            strengthDiv.className = 'password-strength';
            if (strength < 3) {
                strengthDiv.classList.add('weak');
            } else if (strength < 5) {
                strengthDiv.classList.add('medium');
            } else {
                strengthDiv.classList.add('strong');
            }
        }

        // ========================================
        // FUNCIONES PRINCIPALES (MEJORADAS)
        // ========================================

        // Inicializar Supabase con seguridad mejorada
        async function initSupabase() {
            try {
                console.log('🔄 Inicializando Supabase con medidas de seguridad...');
                
                if (!window.supabase) {
                    console.error('❌ window.supabase no está disponible');
                    throw new Error('Supabase no está cargado');
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: false, // No persistir sesiones por seguridad
                        autoRefreshToken: false
                    }
                });
                
                console.log('✅ Cliente Supabase creado con configuración segura');
                
                // Verificar conexión
                const { data, error } = await supabase.from('roles').select('*').limit(1);
                
                if (error) throw error;
                
                updateConnectionStatus(true, 'Conexión Segura');
                updateSecurityIndicator('secure', 'Conexión Segura');
                console.log('✅ Conexión segura establecida');
                
                return true;
                
            } catch (error) {
                console.error('❌ Error:', error);
                updateConnectionStatus(false, 'Error de conexión');
                updateSecurityIndicator('error', 'Error de Conexión');
                
                // Log del error de manera segura
                await logSecurityEvent('error', 'Error de conexión', { 
                    error: error.message.substring(0, 200) 
                }, false);
                
                return false;
            }
        }

        // Función de login con seguridad mejorada
        async function login() {
            try {
                // Verificar rate limiting
                if (!checkRateLimit()) {
                    return;
                }

                // Verificar CAPTCHA
                if (!validateCaptcha()) {
                    recordFailedAttempt();
                    return;
                }

                const email = document.getElementById('email').value.trim().toLowerCase();
                const password = document.getElementById('password').value;

                // Validaciones de seguridad
                if (!email || !password) {
                    showError('Por favor, ingresa email y contraseña');
                    recordFailedAttempt();
                    return;
                }

                if (!validateEmail(email)) {
                    showError('Formato de email inválido');
                    recordFailedAttempt();
                    await logSecurityEvent('login', 'Intento con email inválido', { email: email.substring(0, 20) + '...' }, false);
                    return;
                }

                if (!validatePassword(password)) {
                    showError('Formato de contraseña inválido');
                    recordFailedAttempt();
                    await logSecurityEvent('login', 'Intento con contraseña inválida', { email: email.substring(0, 20) + '...' }, false);
                    return;
                }

                // Deshabilitar botón de login
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = true;
                loginBtn.textContent = 'Verificando...';

                // Verificar conexión
                const connected = await initSupabase();
                if (!connected) {
                    showError('No se puede conectar a la base de datos. Verifica tu conexión a internet.');
                    resetCaptcha();
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesión';
                    return;
                }

                console.log('🔐 Intentando login seguro para:', email.substring(0, 5) + '...');
                
                // Buscar usuario en la base de datos
                const { data: user, error } = await supabase
                    .from('usuarios')
                    .select(`
                        *,
                        rol:roles(nombre, descripcion)
                    `)
                    .eq('email', email)
                    .eq('activo', true)
                    .single();

                if (error || !user) {
                    recordFailedAttempt();
                    await logSecurityEvent('login', 'Usuario no encontrado', { email: email.substring(0, 20) + '...' }, false);
                    showError('Credenciales incorrectas');
                    resetCaptcha();
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesión';
                    return;
                }

                console.log('✅ Usuario encontrado:', user.nombre);

                // Verificar contraseña con cifrado
                if (!verifyPassword(password, user.password_hash)) {
                    recordFailedAttempt();
                    await logSecurityEvent('login', 'Contraseña incorrecta', { 
                        email: email.substring(0, 20) + '...',
                        userId: user.id 
                    }, false);
                    showError('Credenciales incorrectas');
                    resetCaptcha();
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesión';
                    return;
                }

                console.log('✅ Login exitoso para:', user.nombre);
                
                // Limpiar intentos fallidos
                const clientId = getClientId();
                localStorage.removeItem(`login_attempts_${clientId}`);
                localStorage.removeItem(`last_attempt_${clientId}`);
                
                // Generar token de sesión seguro
                sessionToken = generateSecureToken();
                sessionStartTime = Date.now();
                currentUser = user;
                
                // Registrar login exitoso
                await logSecurityEvent('login', 'Login exitoso', { 
                    userId: user.id, 
                    email: email.substring(0, 20) + '...',
                    role: user.rol.nombre 
                }, true);
                
                resetCaptcha();
                showDashboard();
                updateSecurityIndicator('secure', 'Sesión Activa');
                
            } catch (error) {
                console.error('❌ Error general en login:', error);
                recordFailedAttempt();
                await logSecurityEvent('error', 'Error general en login', { 
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al iniciar sesión. Inténtalo de nuevo.');
                resetCaptcha();
            } finally {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
            }
        }

        // Función de logout mejorada
        async function logout() {
            try {
                if (currentUser) {
                    await logSecurityEvent('logout', 'Cierre de sesión', { 
                        userId: currentUser.id,
                        sessionDuration: sessionStartTime ? Date.now() - sessionStartTime : 0
                    }, true);
                }
                
                // Limpiar datos de sesión
                currentUser = null;
                sessionToken = null;
                sessionStartTime = null;
                clearTimeout(sessionTimeout);
                
                // Limpiar UI
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
                document.querySelector('.logout-btn').style.display = 'none';
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                
                // Resetear CAPTCHA
                resetCaptcha();
                
                updateSecurityIndicator('secure', 'Conexión Segura');
                showSuccess('Sesión cerrada exitosamente');
                
            } catch (error) {
                console.error('Error en logout:', error);
            }
        }

        // ========================================
        // FUNCIONES DE TIMEOUT DE SESIÓN
        // ========================================

        function resetSessionTimeout() {
            clearTimeout(sessionTimeout);
            sessionTimeout = setTimeout(() => {
                showError('Tu sesión ha expirado por inactividad');
                logout();
            }, SESSION_TIMEOUT);
        }

        // Resetear timeout en actividad del usuario
        function setupActivityListeners() {
            const events = ['click', 'keypress', 'mousemove', 'scroll'];
            events.forEach(event => {
                document.addEventListener(event, () => {
                    if (currentUser && validateSession()) {
                        renewSession();
                    }
                }, { passive: true });
            });
        }

        // ========================================
        // RESTO DE FUNCIONES (COPIADAS DEL ORIGINAL CON MEJORAS DE SEGURIDAD)
        // ========================================

        function updateConnectionStatus(connected, message) {
            const statusElement = document.getElementById('connectionStatus');
            const iconElement = document.getElementById('connectionIcon');
            const textElement = document.getElementById('connectionText');
            
            if (connected) {
                statusElement.className = 'connection-status connected';
                iconElement.textContent = '🟢';
                textElement.textContent = message || 'Conectado';
            } else {
                statusElement.className = 'connection-status disconnected';
                iconElement.textContent = '🔴';
                textElement.textContent = message || 'Desconectado';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = sanitizeHtml(message);
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const infoDiv = document.getElementById('loginInfo');
            if (infoDiv) {
                infoDiv.textContent = sanitizeHtml(message);
                infoDiv.style.display = 'block';
                setTimeout(() => {
                    infoDiv.style.display = 'none';
                }, 5000);
            } else {
                alert('✅ ' + sanitizeHtml(message));
            }
        }

        function showRateLimitWarning(seconds) {
            const warning = document.getElementById('rateLimitWarning');
            warning.textContent = `⚠️ Demasiados intentos. Espera ${seconds} segundos antes de intentar de nuevo.`;
            warning.style.display = 'block';
            setTimeout(() => {
                warning.style.display = 'none';
            }, 5000);
        }

        async function testConnection() {
            updateConnectionStatus(false, 'Probando...');
            updateSecurityIndicator('warning', 'Probando Conexión');
            
            try {
                console.log('🔄 Test de conexión segura');
                
                if (!window.supabase) {
                    throw new Error('Supabase no está cargado. Recarga la página.');
                }
                
                const connected = await initSupabase();
                
                if (connected) {
                    showSuccess('✅ Conexión segura establecida!');
                } else {
                    showError('❌ Error en la conexión');
                }
            } catch (error) {
                console.error('❌ Error:', error);
                showError('Error: ' + error.message);
                updateSecurityIndicator('error', 'Error de Conexión');
            }
        }

        // Funciones de utilidad para zona horaria de Colombia
        function getColombiaDate() {
            return new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Bogota' });
        }

        function getColombiaDateTime() {
            return new Date().toLocaleString('sv-SE', { timeZone: 'America/Bogota' }).replace(' ', 'T');
        }

        function getColombiaTime() {
            return new Date().toLocaleTimeString('sv-SE', { timeZone: 'America/Bogota', hour12: false }).substring(0, 5);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00-05:00');
            return date.toLocaleDateString('es-CO', { 
                timeZone: 'America/Bogota',
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
        }

        function formatTime(timeString) {
            if (!timeString) return 'N/A';
            return timeString.substring(0, 5);
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = new Date(dateTimeString);
            return date.toLocaleString('es-CO', { 
                timeZone: 'America/Bogota',
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.querySelector('.logout-btn').style.display = 'block';
            
            setupNavigation();
            loadInitialData();
            resetSessionTimeout();
        }

        function setupNavigation() {
            const navButtons = document.getElementById('navButtons');
            const role = currentUser.rol.nombre;
            const email = currentUser.email;
            
            navButtons.innerHTML = '';

            if (role === 'administrador') {
                navButtons.innerHTML = `
                    <button class="btn" onclick="showSection('dashboardSectionDiv')">📊 Dashboard</button>
                    <button class="btn" onclick="showSection('authorizeSectionDiv')">Autorizar Salidas</button>
                    <button class="btn" onclick="showSection('adminSectionDiv')">Administración</button>
                    <button class="btn" onclick="showSection('historySectionDiv')">Historial</button>
                    <button class="btn" onclick="showSection('verifySectionDiv')">Verificar Salidas</button>
                `;
            } else if (role === 'vigilante' || email === 'vigilancia@colgemelli.edu.co') {
                navButtons.innerHTML = `
                    <button class="btn" onclick="showSection('dashboardSectionDiv')">📊 Dashboard</button>
                    <button class="btn" onclick="showSection('verifySectionDiv')">Control de Salidas</button>
                    <button class="btn" onclick="showSection('historySectionDiv')">Historial</button>
                `;
            } else if (email === 'convivencia@colgemelli.edu.co' || email === 'gformativa@colgemelli.edu.co') {
                // Dashboard especial para convivencia y gestión formativa
                navButtons.innerHTML = `
                    <button class="btn" onclick="showSection('dashboardSectionDiv')">📊 Dashboard</button>
                    <button class="btn" onclick="showSection('authorizeSectionDiv')">Autorizar Salidas</button>
                    <button class="btn" onclick="showSection('historySectionDiv')">Historial</button>
                `;
            } else if (email === 'enfermeria@colgemelli.edu.co') {
                // Enfermería NO tiene acceso al dashboard
                navButtons.innerHTML = `
                    <button class="btn" onclick="showSection('authorizeSectionDiv')">Autorizar Salidas</button>
                    <button class="btn" onclick="showSection('historySectionDiv')">Historial</button>
                `;
            } else {
                // Todos los demás usuarios tienen acceso al dashboard
                navButtons.innerHTML = `
                    <button class="btn" onclick="showSection('dashboardSectionDiv')">📊 Dashboard</button>
                    <button class="btn" onclick="showSection('authorizeSectionDiv')">Autorizar Salidas</button>
                    <button class="btn" onclick="showSection('historySectionDiv')">Historial</button>
                `;
            }

            // Mostrar la primera sección disponible
            if (role === 'vigilante' || email === 'vigilancia@colgemelli.edu.co') {
                showSection('dashboardSectionDiv'); // Vigilancia empieza con dashboard
            } else if (email === 'convivencia@colgemelli.edu.co' || email === 'gformativa@colgemelli.edu.co') {
                showSection('dashboardSectionDiv');
            } else if (email === 'enfermeria@colgemelli.edu.co') {
                showSection('authorizeSectionDiv'); // Enfermería empieza con autorizar
            } else {
                showSection('dashboardSectionDiv'); // Todos los demás empiezan con dashboard
            }
        }

        function showSection(sectionId) {
            if (!validateSession()) {
                showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                logout();
                return;
            }

            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            
            if (sectionId === 'historySectionDiv') {
                loadHistory(true);
                setTimeout(setupTableScroll, 100);
            } else if (sectionId === 'verifySectionDiv') {
                // Resetear las secciones de vigilancia al estado inicial
                document.getElementById('searchSection').style.display = 'none';
                document.getElementById('myConfirmedSection').style.display = 'none';
                document.getElementById('pendingExitsSection').style.display = 'block';
                
                if (currentUser && (currentUser.rol.nombre === 'vigilante' || currentUser.email === 'vigilancia@colgemelli.edu.co')) {
                    loadPendingExits();
                }
            } else if (sectionId === 'dashboardSectionDiv') {
                console.log('📊 Iniciando sección dashboard...');
                
                // Mostrar mensaje de carga inmediatamente
                document.getElementById('dashPendingCount').textContent = '...';
                document.getElementById('dashConfirmedCount').textContent = '...';
                document.getElementById('dashTotalCount').textContent = '...';
                document.getElementById('dashRecentCount').textContent = '...';
                
                // Cargar dashboard con manejo de Chart.js
                setTimeout(async () => {
                    try {
                        await loadDashboard();
                    } catch (error) {
                        console.error('❌ Error cargando dashboard desde showSection:', error);
                        showError('Error al cargar el dashboard. Usa el botón Debug para más información.');
                    }
                }, 100);
            }
            
            renewSession();
        }

        async function loadInitialData() {
            try {
                await loadStudents();
                await loadReasons();
                await loadGrades();
                await loadRoles();
                
                if (currentUser.rol.nombre === 'administrador') {
                    await loadUsers();
                    await loadSecurityStats();
                }
                
                setupEventListeners();
                
            } catch (error) {
                console.error('Error al cargar datos iniciales:', error);
                await logSecurityEvent('error', 'Error al cargar datos iniciales', { 
                    error: error.message.substring(0, 200) 
                }, false);
            }
        }

        function setupEventListeners() {
            document.getElementById('authorizeForm').addEventListener('submit', authorizeExit);
            
            const studentSearchInput = document.getElementById('studentSearch');
            if (studentSearchInput) {
                studentSearchInput.addEventListener('input', () => {
                    validateSearchInput(studentSearchInput);
                });
            }
            
            document.getElementById('studentForm').addEventListener('submit', saveStudent);
            document.getElementById('userForm').addEventListener('submit', saveUser);
            document.getElementById('reasonForm').addEventListener('submit', saveReason);
            document.getElementById('gradeForm').addEventListener('submit', saveGrade);

            const todayColombia = getColombiaDate();
            document.getElementById('exitDate').value = todayColombia;
            document.getElementById('historyDate').value = todayColombia;
            document.getElementById('logDateFrom').value = todayColombia;
            document.getElementById('logDateTo').value = todayColombia;
            
            console.log('📅 Fecha actual Colombia establecida:', todayColombia);
        }

        // ========================================
        // FUNCIONES DE CARGA DE DATOS (COPIADAS CON MEJORAS)
        // ========================================

        async function loadStudents() {
            try {
                if (!validateSession()) return;

                const { data: students, error } = await supabase
                    .from('estudiantes')
                    .select(`
                        *,
                        grado:grados(nombre)
                    `)
                    .eq('activo', true)
                    .order('nombre');

                if (error) throw error;

                const select = document.getElementById('studentSelect');
                const gradeSelect = document.getElementById('studentGrade');
                
                select.innerHTML = '<option value="">Seleccionar estudiante...</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = sanitizeHtml(`${student.nombre} ${student.apellidos} - ${student.grado.nombre}`);
                    select.appendChild(option);
                });

                updateStudentsTable(students);
                
            } catch (error) {
                console.error('Error loading students:', error);
                await logSecurityEvent('error', 'Error al cargar estudiantes', { 
                    error: error.message.substring(0, 200) 
                }, false);
            }
        }

        async function loadReasons() {
            try {
                if (!validateSession()) return;

                const { data: reasons, error } = await supabase
                    .from('motivos')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre');

                if (error) throw error;

                const select = document.getElementById('reasonSelect');
                select.innerHTML = '<option value="">Seleccionar motivo...</option>';
                
                reasons.forEach(reason => {
                    const option = document.createElement('option');
                    option.value = reason.id;
                    option.textContent = sanitizeHtml(reason.nombre);
                    select.appendChild(option);
                });

                updateReasonsTable(reasons);
                
            } catch (error) {
                console.error('Error loading reasons:', error);
                await logSecurityEvent('error', 'Error al cargar motivos', { 
                    error: error.message.substring(0, 200) 
                }, false);
            }
        }

        async function loadGrades() {
            try {
                if (!validateSession()) return;

                const { data: grades, error } = await supabase
                    .from('grados')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre');

                if (error) throw error;

                const gradeSelect = document.getElementById('gradeSelect');
                gradeSelect.innerHTML = '<option value="">Seleccionar grado...</option>';
                
                grades.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade.id;
                    option.textContent = sanitizeHtml(`${grade.nombre} - ${grade.nivel}`);
                    gradeSelect.appendChild(option);
                });

                const studentGradeSelect = document.getElementById('studentGrade');
                if (studentGradeSelect) {
                    studentGradeSelect.innerHTML = '<option value="">Seleccionar grado...</option>';
                    
                    grades.forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade.id;
                        option.textContent = sanitizeHtml(`${grade.nombre} - ${grade.nivel}`);
                        studentGradeSelect.appendChild(option);
                    });
                }

                updateGradesTable(grades);
                console.log('✅ Grados cargados:', grades.length);
                
            } catch (error) {
                console.error('Error loading grades:', error);
                await logSecurityEvent('error', 'Error al cargar grados', { 
                    error: error.message.substring(0, 200) 
                }, false);
            }
        }

        async function loadRoles() {
            try {
                if (!validateSession()) return;

                const { data: roles, error } = await supabase
                    .from('roles')
                    .select('*')
                    .order('nombre');

                if (error) throw error;

                const select = document.getElementById('userRole');
                select.innerHTML = '<option value="">Seleccionar rol...</option>';
                
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = sanitizeHtml(role.descripcion);
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading roles:', error);
                await logSecurityEvent('error', 'Error al cargar roles', { 
                    error: error.message.substring(0, 200) 
                }, false);
            }
        }

        async function loadUsers() {
            try {
                if (!validateSession()) return;

                const { data: users, error } = await supabase
                    .from('usuarios')
                    .select(`
                        *,
                        rol:roles(nombre, descripcion)
                    `)
                    .order('nombre');

                if (error) throw error;

                updateUsersTable(users);
                
            } catch (error) {
                console.error('Error loading users:', error);
                await logSecurityEvent('error', 'Error al cargar usuarios', { 
                    error: error.message.substring(0, 200) 
                }, false);
            }
        }

        async function loadStudentsByGrade() {
            const gradeId = document.getElementById('gradeSelect').value;
            const studentSelect = document.getElementById('studentSelect');
            
            if (!gradeId) {
                studentSelect.innerHTML = '<option value="">Primero selecciona un grado...</option>';
                studentSelect.disabled = true;
                return;
            }
            
            try {
                if (!validateSession()) return;

                studentSelect.innerHTML = '<option value="">Cargando estudiantes...</option>';
                studentSelect.disabled = true;
                
                console.log('🔄 Cargando estudiantes del grado ID:', gradeId);
                
                const { data: students, error } = await supabase
                    .from('estudiantes')
                    .select(`
                        id,
                        nombre,
                        apellidos,
                        documento
                    `)
                    .eq('grado_id', gradeId)
                    .eq('activo', true)
                    .order('apellidos')
                    .order('nombre');

                if (error) throw error;

                console.log('📊 Estudiantes encontrados:', students.length);

                studentSelect.innerHTML = '<option value="">Seleccionar estudiante...</option>';
                
                if (students && students.length > 0) {
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = sanitizeHtml(`${student.apellidos}, ${student.nombre}${student.documento ? ' - Doc: ' + student.documento : ''}`);
                        studentSelect.appendChild(option);
                    });
                    
                    studentSelect.disabled = false;
                    console.log('✅ Select de estudiantes habilitado con', students.length, 'estudiantes');
                } else {
                    studentSelect.innerHTML = '<option value="">No hay estudiantes en este grado</option>';
                    console.log('⚠️ No se encontraron estudiantes para el grado seleccionado');
                }
                
            } catch (error) {
                console.error('❌ Error al cargar estudiantes por grado:', error);
                showError('Error al cargar los estudiantes: ' + error.message);
                studentSelect.innerHTML = '<option value="">Error al cargar estudiantes</option>';
                studentSelect.disabled = true;
                
                await logSecurityEvent('error', 'Error al cargar estudiantes por grado', { 
                    gradeId: gradeId,
                    error: error.message.substring(0, 200) 
                }, false);
            }
        }

        // ========================================
        // FUNCIONES DE AUTORIZACIÓN Y VERIFICACIÓN (COPIADAS CON MEJORAS)
        // ========================================

        async function authorizeExit(e) {
            e.preventDefault();
            
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }
                
                const gradeId = document.getElementById('gradeSelect').value;
                const studentId = document.getElementById('studentSelect').value;
                const reasonId = document.getElementById('reasonSelect').value;
                const exitDate = document.getElementById('exitDate').value;
                const exitTime = document.getElementById('exitTime').value;
                const observations = sanitizeHtml(document.getElementById('observations').value.trim());

                // Validaciones de seguridad
                if (!gradeId || !studentId || !reasonId || !exitDate || !exitTime) {
                    showError('Por favor, completa todos los campos obligatorios');
                    return;
                }

                // Validar fecha no sea pasada
                const todayColombia = getColombiaDate();
                if (exitDate < todayColombia) {
                    showError('No se puede autorizar una salida para una fecha pasada');
                    return;
                }

                // Validar observaciones
                if (observations && !validateText(observations)) {
                    showError('Las observaciones contienen caracteres no permitidos');
                    return;
                }

                const colombiaDateTime = new Date().toLocaleString('sv-SE', { 
                    timeZone: 'America/Bogota' 
                });

                const { data, error } = await supabase
                    .from('autorizaciones_salida')
                    .insert([{
                        estudiante_id: studentId,
                        motivo_id: reasonId,
                        usuario_autorizador_id: currentUser.id,
                        fecha_salida: exitDate,
                        hora_salida: exitTime,
                        observaciones: observations || null,
                        fecha_creacion: colombiaDateTime,
                        autorizada: true
                    }]);

                if (error) throw error;

                const gradeSelect = document.getElementById('gradeSelect');
                const studentSelect = document.getElementById('studentSelect');
                const gradeName = gradeSelect.options[gradeSelect.selectedIndex].text;
                const studentName = studentSelect.options[studentSelect.selectedIndex].text;

                await logSecurityEvent('create', 'Autorización de salida creada', {
                    studentId,
                    gradeId,
                    reasonId,
                    exitDate,
                    exitTime
                }, true);

                showSuccess(`✅ Autorización creada exitosamente para ${sanitizeHtml(studentName)} (${sanitizeHtml(gradeName)})`);
                
                resetAuthorizationForm();
                
                console.log(`✅ Autorización creada: ${studentName} - ${gradeName} - ${exitDate} ${exitTime}`);
                
            } catch (error) {
                await logSecurityEvent('error', 'Error al crear autorización', { 
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al crear la autorización: ' + error.message);
            }
        }

        function resetAuthorizationForm() {
            document.getElementById('authorizeForm').reset();
            
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">Primero selecciona un grado...</option>';
            studentSelect.disabled = true;
            
            const todayColombia = getColombiaDate();
            document.getElementById('exitDate').value = todayColombia;
        }

        async function searchStudent() {
            const searchTerm = sanitizeHtml(document.getElementById('studentSearch').value.trim());
            const resultDiv = document.getElementById('searchResult');
            
            if (searchTerm.length < 3) {
                resultDiv.innerHTML = '<div class="card"><p style="text-align: center; color: #666;">Escribe al menos 3 caracteres para buscar...</p></div>';
                return;
            }

            // Validar entrada de búsqueda
            if (!validateText(searchTerm)) {
                resultDiv.innerHTML = '<div class="verification-card not-authorized"><h3>❌ BÚSQUEDA INVÁLIDA</h3><p>La búsqueda contiene caracteres no permitidos.</p></div>';
                return;
            }

            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                const todayColombia = getColombiaDate();
                
                console.log('🔍 Buscando autorizaciones para:', searchTerm.substring(0, 10) + '...', 'en fecha Colombia:', todayColombia);
                
                const { data: authorizations, error } = await supabase
                    .from('autorizaciones_salida')
                    .select('*')
                    .eq('fecha_salida', todayColombia)
                    .eq('autorizada', true);

                if (error) {
                    console.error('Error en búsqueda:', error);
                    showError('Error al buscar autorizaciones: ' + error.message);
                    return;
                }

                if (!authorizations || authorizations.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="verification-card not-authorized">
                            <h3>❌ NO HAY AUTORIZACIONES</h3>
                            <p>No se encontraron autorizaciones para la fecha de hoy (${formatDate(todayColombia)}).</p>
                        </div>
                    `;
                    return;
                }

                const { data: students, error: studentsError } = await supabase
                    .from('estudiantes')
                    .select('id, nombre, apellidos, grado:grados(nombre)')
                    .or(`nombre.ilike.%${searchTerm}%,apellidos.ilike.%${searchTerm}%`)
                    .eq('activo', true);

                if (studentsError) {
                    console.error('Error buscando estudiantes:', studentsError);
                    resultDiv.innerHTML = `
                        <div class="verification-card not-authorized">
                            <h3>❌ ERROR EN BÚSQUEDA</h3>
                            <p>Error al buscar estudiantes: ${studentsError.message}</p>
                        </div>
                    `;
                    return;
                }

                const studentIds = students?.map(s => s.id) || [];
                const matchingAuth = authorizations.filter(auth => 
                    studentIds.includes(auth.estudiante_id)
                );

                if (matchingAuth.length === 0) {
                    let studentsList = students?.map(s => `${sanitizeHtml(s.nombre)} ${sanitizeHtml(s.apellidos)} (${sanitizeHtml(s.grado.nombre)})`).join(', ') || '';
                    resultDiv.innerHTML = `
                        <div class="verification-card not-authorized">
                            <h3>❌ NO AUTORIZADO</h3>
                            <p>No se encontraron autorizaciones para "${sanitizeHtml(searchTerm)}" en la fecha de hoy (${formatDate(todayColombia)}).</p>
                            ${studentsList ? `<p><strong>Estudiantes encontrados:</strong> ${studentsList}</p>` : ''}
                            <p><em>Verifica que tengan autorización para hoy o contacta al personal autorizado.</em></p>
                        </div>
                    `;
                    return;
                }

                const reasonIds = [...new Set(matchingAuth.map(auth => auth.motivo_id))];
                const userIds = [...new Set(matchingAuth.map(auth => auth.usuario_autorizador_id))];

                const [reasonsResult, usersResult] = await Promise.all([
                    supabase.from('motivos').select('id, nombre').in('id', reasonIds),
                    supabase.from('usuarios').select('id, nombre').in('id', userIds)
                ]);

                const studentMap = {};
                const reasonMap = {};
                const userMap = {};

                students?.forEach(student => {
                    studentMap[student.id] = student;
                });

                reasonsResult.data?.forEach(reason => {
                    reasonMap[reason.id] = reason;
                });

                usersResult.data?.forEach(user => {
                    userMap[user.id] = user;
                });

                const currentTime = getColombiaTime();
                let html = `<div style="text-align: center; margin-bottom: 20px; background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 5px;">
                    <p style="color: #2c3e50; font-size: 15px; font-weight: bold;">📅 ${formatDate(todayColombia)} - 🕐 ${currentTime} (Hora Colombia)</p>
                </div>`;
                
                matchingAuth.forEach(auth => {
                    const student = studentMap[auth.estudiante_id];
                    const reason = reasonMap[auth.motivo_id];
                    const user = userMap[auth.usuario_autorizador_id];

                    let cardClass, titleText, footerHtml;
                    
                    if (auth.salida_efectiva) {
                        cardClass = 'verified';
                        titleText = '✅ SALIDA YA CONFIRMADA';
                        footerHtml = `
                            <div class="verification-card-footer">
                                <p><strong>✅ Autorizado por:</strong> ${user?.nombre ? sanitizeHtml(user.nombre) : 'No encontrado'}</p>
                                ${auth.observaciones ? `
                                    <div class="verification-card-obs">
                                        <strong>📝 Observaciones:</strong><br>
                                        ${sanitizeHtml(auth.observaciones)}
                                    </div>
                                ` : ''}
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                                    <p style="color: white; font-weight: bold; margin: 0;">
                                        ✅ CONFIRMADA: ${formatDateTime(auth.salida_efectiva)}<br>
                                        <small>Vigilante: ${sanitizeHtml(currentUser.nombre)}</small>
                                    </p>
                                </div>
                            </div>
                        `;
                    } else {
                        cardClass = 'authorized';
                        titleText = '✅ AUTORIZADO PARA SALIR';
                        footerHtml = `
                            <div class="verification-card-footer">
                                <p><strong>✅ Autorizado por:</strong> ${user?.nombre ? sanitizeHtml(user.nombre) : 'No encontrado'}</p>
                                ${auth.observaciones ? `
                                    <div class="verification-card-obs">
                                        <strong>📝 Observaciones:</strong><br>
                                        ${sanitizeHtml(auth.observaciones)}
                                    </div>
                                ` : ''}
                                <button class="btn btn-success" onclick="confirmExit(${auth.id})" style="font-size: 18px; padding: 15px 40px; margin-top: 15px;">
                                    ✅ CONFIRMAR SALIDA
                                </button>
                            </div>
                        `;
                    }

                    html += `
                        <div class="verification-card ${cardClass}">
                            <h3>${titleText}</h3>
                            
                            <div class="verification-card-content">
                                <div class="verification-card-info">
                                    <p>
                                        <strong>👨‍🎓 Estudiante:</strong>
                                        <span class="info-value">${student ? `${sanitizeHtml(student.nombre)} ${sanitizeHtml(student.apellidos)}` : 'No encontrado'}</span>
                                    </p>
                                    <p>
                                        <strong>🎓 Grado:</strong>
                                        <span class="info-value">${student?.grado?.nombre ? sanitizeHtml(student.grado.nombre) : 'No encontrado'}</span>
                                    </p>
                                </div>
                                <div class="verification-card-info">
                                    <p>
                                        <strong>📝 Motivo de Salida:</strong>
                                        <span class="info-value">${reason?.nombre ? sanitizeHtml(reason.nombre) : 'No encontrado'}</span>
                                    </p>
                                    <p>
                                        <strong>🕐 Hora Autorizada:</strong>
                                        <span class="info-value">${formatTime(auth.hora_salida)}</span>
                                    </p>
                                </div>
                            </div>
                            
                            ${footerHtml}
                        </div>
                    `;
                });

                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error general en búsqueda:', error);
                await logSecurityEvent('error', 'Error en búsqueda de estudiante', { 
                    searchTerm: searchTerm.substring(0, 20) + '...',
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al buscar autorizaciones: ' + error.message);
                resultDiv.innerHTML = `
                    <div class="verification-card not-authorized">
                        <h3>❌ ERROR</h3>
                        <p>Error en la búsqueda: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadPendingExits() {
            const pendingList = document.getElementById('pendingExitsList');
            
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                pendingList.innerHTML = '<div class="card" style="text-align: center; padding: 20px;"><p style="color: #666;">🔄 Cargando salidas pendientes...</p></div>';
                
                const todayColombia = getColombiaDate();
                console.log('📅 Cargando salidas pendientes para Colombia:', todayColombia);
                
                const { data: authorizations, error } = await supabase
                    .from('autorizaciones_salida')
                    .select('*')
                    .eq('fecha_salida', todayColombia)
                    .eq('autorizada', true)
                    .is('salida_efectiva', null)
                    .order('hora_salida', { ascending: true });

                if (error) {
                    console.error('❌ Error al cargar salidas pendientes:', error);
                    throw error;
                }

                if (!authorizations || authorizations.length === 0) {
                    const currentTime = getColombiaTime();
                    pendingList.innerHTML = `
                        <div class="verification-card" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d);">
                            <h3>✅ ¡Todo en orden!</h3>
                            <p><strong>No hay salidas pendientes para hoy</strong></p>
                            <p>Fecha: ${formatDate(todayColombia)} - Hora: ${currentTime}</p>
                            <p>Todos los estudiantes autorizados ya han sido confirmados</p>
                        </div>
                    `;
                    return;
                }

                console.log('📊 Salidas pendientes encontradas:', authorizations.length);

                const studentIds = [...new Set(authorizations.map(auth => auth.estudiante_id))];
                const reasonIds = [...new Set(authorizations.map(auth => auth.motivo_id))];
                const userIds = [...new Set(authorizations.map(auth => auth.usuario_autorizador_id))];

                const [studentsResult, reasonsResult, usersResult] = await Promise.all([
                    supabase
                        .from('estudiantes')
                        .select('id, nombre, apellidos, grado:grados(nombre)')
                        .in('id', studentIds),
                    supabase
                        .from('motivos')
                        .select('id, nombre')
                        .in('id', reasonIds),
                    supabase
                        .from('usuarios')
                        .select('id, nombre')
                        .in('id', userIds)
                ]);

                const studentMap = {};
                const reasonMap = {};
                const userMap = {};

                studentsResult.data?.forEach(student => {
                    studentMap[student.id] = student;
                });

                reasonsResult.data?.forEach(reason => {
                    reasonMap[reason.id] = reason;
                });

                usersResult.data?.forEach(user => {
                    userMap[user.id] = user;
                });

                const currentTime = getColombiaTime();
                let html = `<div style="text-align: center; margin-bottom: 25px; background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px;">
                    <p style="color: #2c3e50; font-weight: bold; font-size: 16px;">📅 ${formatDate(todayColombia)} - 🕐 ${currentTime} (Hora Colombia)</p>
                    <p style="color: #7f8c8d; margin-top: 8px;">Salidas pendientes de confirmación: <strong>${authorizations.length}</strong></p>
                </div>`;
                
                authorizations.forEach(auth => {
                    const student = studentMap[auth.estudiante_id];
                    const reason = reasonMap[auth.motivo_id];
                    const user = userMap[auth.usuario_autorizador_id];

                    html += `
                        <div class="verification-card authorized">
                            <h3>⏳ PENDIENTE CONFIRMAR SALIDA</h3>
                            
                            <div class="verification-card-content">
                                <div class="verification-card-info">
                                    <p>
                                        <strong>👨‍🎓 Estudiante:</strong>
                                        <span class="info-value">${student ? sanitizeHtml(`${student.nombre} ${student.apellidos}`) : 'No encontrado'}</span>
                                    </p>
                                    <p>
                                        <strong>🎓 Grado:</strong>
                                        <span class="info-value">${student?.grado?.nombre ? sanitizeHtml(student.grado.nombre) : 'No encontrado'}</span>
                                    </p>
                                </div>
                                <div class="verification-card-info">
                                    <p>
                                        <strong>📝 Motivo de Salida:</strong>
                                        <span class="info-value">${reason?.nombre ? sanitizeHtml(reason.nombre) : 'No encontrado'}</span>
                                    </p>
                                    <p>
                                        <strong>🕐 Hora Autorizada:</strong>
                                        <span class="info-value">${formatTime(auth.hora_salida)}</span>
                                    </p>
                                </div>
                            </div>
                            
                            <div class="verification-card-footer">
                                <p><strong>✅ Autorizado por:</strong> ${user?.nombre ? sanitizeHtml(user.nombre) : 'No encontrado'}</p>
                                ${auth.observaciones ? `
                                    <div class="verification-card-obs">
                                        <strong>📝 Observaciones:</strong><br>
                                        ${sanitizeHtml(auth.observaciones)}
                                    </div>
                                ` : ''}
                                <button class="btn btn-success" onclick="confirmExit(${auth.id})" style="font-size: 18px; padding: 15px 40px; margin-top: 15px;">
                                    ✅ CONFIRMAR SALIDA
                                </button>
                            </div>
                        </div>
                    `;
                });

                pendingList.innerHTML = html;
                console.log('✅ Lista de salidas pendientes cargada');

            } catch (error) {
                console.error('❌ Error general:', error);
                await logSecurityEvent('error', 'Error al cargar salidas pendientes', { 
                    error: error.message.substring(0, 200) 
                }, false);
                pendingList.innerHTML = `
                    <div class="verification-card not-authorized">
                        <h3>❌ Error al cargar</h3>
                        <p>No se pudieron cargar las salidas pendientes</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <button class="btn btn-secondary" onclick="loadPendingExits()" style="margin-top: 10px;">
                            🔄 Intentar de nuevo
                        </button>
                    </div>
                `;
            }
        }

        async function confirmExit(authId) {
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                const colombiaDateTime = new Date().toLocaleString('sv-SE', { 
                    timeZone: 'America/Bogota' 
                });

                const { data, error } = await supabase
                    .from('autorizaciones_salida')
                    .update({
                        salida_efectiva: colombiaDateTime,
                        vigilante_id: currentUser.id
                    })
                    .eq('id', authId);

                if (error) throw error;

                await logSecurityEvent('update', 'Salida confirmada', { 
                    authId, 
                    vigilanteId: currentUser.id 
                }, true);

                const colombiaTime = getColombiaTime();
                showSuccess(`Salida confirmada exitosamente a las ${colombiaTime}`);
                
                const confirmButton = document.querySelector(`button[onclick="confirmExit(${authId})"]`);
                if (confirmButton) {
                    const card = confirmButton.closest('.verification-card');
                    if (card) {
                        card.classList.remove('authorized');
                        card.classList.add('verified');
                        
                        const titleElement = card.querySelector('h3');
                        if (titleElement) {
                            titleElement.textContent = '✅ SALIDA CONFIRMADA';
                        }
                        
                        const footerElement = confirmButton.closest('.verification-card-footer');
                        if (footerElement) {
                            const observationsHtml = footerElement.querySelector('.verification-card-obs')?.outerHTML || '';
                            
                            footerElement.innerHTML = `
                                <p><strong>✅ Autorizado por:</strong> Usuario</p>
                                ${observationsHtml}
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                                    <p style="color: white; font-weight: bold; margin: 0;">
                                        ✅ SALIDA CONFIRMADA<br>
                                        <small>Hora: ${colombiaTime} - Vigilante: ${sanitizeHtml(currentUser.nombre)}</small>
                                    </p>
                                </div>
                            `;
                        }
                        
                        card.style.transform = 'scale(1.02)';
                        setTimeout(() => {
                            card.style.transform = 'scale(1)';
                        }, 300);
                    }
                }
                
                const searchInput = document.getElementById('studentSearch');
                if (searchInput) {
                    searchInput.value = '';
                }
                const searchResult = document.getElementById('searchResult');
                if (searchResult) {
                    searchResult.innerHTML = '';
                }
                
                if (currentUser.rol.nombre === 'vigilante') {
                    setTimeout(async () => {
                        await loadPendingExits();
                    }, 2000);
                }
                
            } catch (error) {
                await logSecurityEvent('error', 'Error al confirmar salida', { 
                    authId,
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al confirmar la salida: ' + error.message);
            }
        }

        function toggleSearch() {
            const searchSection = document.getElementById('searchSection');
            const pendingSection = document.getElementById('pendingExitsSection');
            const myConfirmedSection = document.getElementById('myConfirmedSection');
            
            if (searchSection.style.display === 'none') {
                searchSection.style.display = 'block';
                pendingSection.style.display = 'none';
                myConfirmedSection.style.display = 'none';
            } else {
                searchSection.style.display = 'none';
                pendingSection.style.display = 'block';
                myConfirmedSection.style.display = 'none';
                // Limpiar búsqueda
                document.getElementById('studentSearch').value = '';
                document.getElementById('searchResult').innerHTML = '';
                // Recargar pendientes
                loadPendingExits();
            }
        }

        // ========================================
        // FUNCIONES DE ADMINISTRACIÓN CON SEGURIDAD
        // ========================================

        function showAdminSection(section) {
            if (!validateSession()) {
                showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                logout();
                return;
            }

            if (currentUser.rol.nombre !== 'administrador') {
                showError('No tienes permisos para acceder a esta sección');
                return;
            }

            document.querySelectorAll('.admin-subsection').forEach(sub => {
                sub.style.display = 'none';
            });
            document.getElementById(`admin${section.charAt(0).toUpperCase() + section.slice(1)}`).style.display = 'block';
            
            if (section === 'security') {
                loadSecurityStats();
                loadSecurityLogs();
            }
            
            renewSession();
        }

        async function loadSecurityStats() {
            try {
                if (!validateSession()) return;

                const todayColombia = getColombiaDate();
                
                const { data: todayLogs, error: logsError } = await supabase
                    .from('audit_logs')
                    .select('*')
                    .gte('timestamp', todayColombia + 'T00:00:00')
                    .lte('timestamp', todayColombia + 'T23:59:59');

                if (!logsError && todayLogs) {
                    const loginCount = todayLogs.filter(log => log.tipo === 'login' && log.exitoso).length;
                    const changeCount = todayLogs.filter(log => ['create', 'update', 'delete'].includes(log.tipo)).length;
                    const failedCount = todayLogs.filter(log => !log.exitoso).length;
                    
                    document.getElementById('todayLogins').textContent = loginCount;
                    document.getElementById('todayChanges').textContent = changeCount;
                    document.getElementById('failedAttempts').textContent = failedCount;
                }

                const { data: activeUsers, error: usersError } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('activo', true);

                if (!usersError && activeUsers) {
                    document.getElementById('activeUsers').textContent = activeUsers.length;
                }

                const logUserSelect = document.getElementById('logUser');
                if (activeUsers && logUserSelect) {
                    logUserSelect.innerHTML = '<option value="">Todos</option>';
                    activeUsers.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = sanitizeHtml(user.nombre);
                        logUserSelect.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Error al cargar estadísticas de seguridad:', error);
                await logSecurityEvent('error', 'Error al cargar estadísticas de seguridad', { 
                    error: error.message.substring(0, 200) 
                }, false);
            }
        }

        async function loadSecurityLogs() {
            try {
                if (!validateSession()) return;

                const dateFrom = document.getElementById('logDateFrom').value;
                const dateTo = document.getElementById('logDateTo').value;
                const logType = document.getElementById('logType').value;
                const logUser = document.getElementById('logUser').value;

                let query = supabase
                    .from('audit_logs')
                    .select(`
                        *,
                        usuario:usuarios(nombre, email)
                    `)
                    .order('timestamp', { ascending: false })
                    .limit(100);

                if (dateFrom) {
                    query = query.gte('timestamp', dateFrom + 'T00:00:00');
                }
                if (dateTo) {
                    query = query.lte('timestamp', dateTo + 'T23:59:59');
                }
                if (logType) {
                    query = query.eq('tipo', logType);
                }
                if (logUser) {
                    query = query.eq('usuario_id', logUser);
                }

                const { data: logs, error } = await query;

                if (error) {
                    console.error('Error al cargar logs:', error);
                    showError('Error al cargar los logs de seguridad');
                    return;
                }

                const tbody = document.querySelector('#securityLogsTable tbody');
                tbody.innerHTML = '';

                if (!logs || logs.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #666; padding: 20px;">
                                No se encontraron logs para los filtros seleccionados
                            </td>
                        </tr>
                    `;
                    return;
                }

                logs.forEach(log => {
                    const row = tbody.insertRow();
                    const typeClass = getLogTypeClass(log.tipo);
                    let details = {};
                    
                    try {
                        details = log.detalles ? JSON.parse(log.detalles) : {};
                    } catch (e) {
                        details = { error: 'Error al parsear detalles' };
                    }
                    
                    row.innerHTML = `
                        <td>${formatDateTime(log.timestamp)}</td>
                        <td>${log.usuario ? sanitizeHtml(log.usuario.nombre) : 'Sistema'}</td>
                        <td><span class="log-type ${typeClass}">${sanitizeHtml(log.tipo)}</span></td>
                        <td>${sanitizeHtml(log.accion)}</td>
                        <td title="${sanitizeHtml(JSON.stringify(details))}">${sanitizeHtml(JSON.stringify(details).substring(0, 50))}...</td>
                        <td>${sanitizeHtml(log.ip_address || 'N/A')}</td>
                    `;
                });

                showSuccess(`Se cargaron ${logs.length} registros de logs`);
                
                // Configurar scroll después de cargar logs
                setTimeout(setupTableScroll, 50);
                
            } catch (error) {
                console.error('Error general al cargar logs:', error);
                await logSecurityEvent('error', 'Error al cargar logs de seguridad', { 
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al cargar los logs de seguridad');
            }
        }

        function getLogTypeClass(type) {
            const classes = {
                'login': 'login',
                'logout': 'logout',
                'create': 'create',
                'update': 'update',
                'delete': 'delete',
                'error': 'error'
            };
            return classes[type] || '';
        }

        async function exportLogs() {
            showSuccess('Función de exportación en desarrollo');
        }

        // ========================================
        // FUNCIONES DE MODALES CON SEGURIDAD
        // ========================================

        function openModal(modalId) {
            if (!validateSession()) {
                showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                logout();
                return;
            }

            document.getElementById(modalId).style.display = 'block';
            currentEditingId = null;
            
            if (modalId === 'studentModal') {
                document.getElementById('studentForm').reset();
            } else if (modalId === 'userModal') {
                document.getElementById('userForm').reset();
                document.getElementById('passwordNote').textContent = '(obligatorio para nuevos usuarios)';
                document.getElementById('userPassword').required = true;
                document.getElementById('userPasswordStrength').style.display = 'none';
            } else if (modalId === 'reasonModal') {
                document.getElementById('reasonForm').reset();
            } else if (modalId === 'gradeModal') {
                document.getElementById('gradeForm').reset();
            }
            
            renewSession();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            currentEditingId = null;
        }

        // ========================================
        // FUNCIONES CRUD CON SEGURIDAD MEJORADA
        // ========================================

        async function saveStudent(e) {
            e.preventDefault();
            
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                const name = document.getElementById('studentName').value.trim();
                const lastName = document.getElementById('studentLastName').value.trim();
                const documentValue = document.getElementById('studentDocument').value.trim();
                const gradeId = document.getElementById('studentGrade').value;

                // Validaciones de seguridad
                if (!name || !lastName || !gradeId) {
                    showError('Por favor, completa todos los campos obligatorios');
                    return;
                }

                if (!validateName(name) || !validateName(lastName)) {
                    showError('Los nombres solo deben contener letras, espacios y acentos');
                    return;
                }

                if (documentValue && !validateDocument(documentValue)) {
                    showError('El documento debe contener solo números (6-20 dígitos)');
                    return;
                }

                let result;
                if (currentEditingId) {
                    result = await supabase
                        .from('estudiantes')
                        .update({
                            nombre: name,
                            apellidos: lastName,
                            documento: documentValue || null,
                            grado_id: gradeId
                        })
                        .eq('id', currentEditingId);
                        
                    await logSecurityEvent('update', 'Estudiante actualizado', { 
                        studentId: currentEditingId,
                        name: name.substring(0, 20) + '...',
                        lastName: lastName.substring(0, 20) + '...'
                    }, true);
                } else {
                    result = await supabase
                        .from('estudiantes')
                        .insert([{
                            nombre: name,
                            apellidos: lastName,
                            documento: documentValue || null,
                            grado_id: gradeId,
                            activo: true
                        }]);
                        
                    await logSecurityEvent('create', 'Estudiante creado', { 
                        name: name.substring(0, 20) + '...',
                        lastName: lastName.substring(0, 20) + '...',
                        gradeId 
                    }, true);
                }

                if (result.error) {
                    console.error('Error al guardar estudiante:', result.error);
                    throw result.error;
                }

                showSuccess('Estudiante guardado exitosamente');
                closeModal('studentModal');
                await loadStudents();
                
            } catch (error) {
                console.error('Error completo al guardar estudiante:', error);
                await logSecurityEvent('error', 'Error al guardar estudiante', { 
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al guardar el estudiante: ' + error.message);
            }
        }

        async function saveUser(e) {
            e.preventDefault();
            
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                const name = document.getElementById('userName').value.trim();
                const email = document.getElementById('userEmail').value.trim().toLowerCase();
                const password = document.getElementById('userPassword').value;
                const roleId = document.getElementById('userRole').value;

                // Validaciones de seguridad
                if (!name || !email || !roleId) {
                    showError('Por favor, completa todos los campos obligatorios');
                    return;
                }

                if (!validateEmail(email)) {
                    showError('Formato de email inválido');
                    return;
                }

                if (!validateName(name)) {
                    showError('El nombre solo debe contener letras, espacios y acentos');
                    return;
                }

                if (!currentEditingId && !password) {
                    showError('La contraseña es obligatoria para nuevos usuarios');
                    return;
                }

                if (password && !validatePassword(password)) {
                    showError('La contraseña debe tener entre 8 y 50 caracteres');
                    return;
                }

                let result;
                if (currentEditingId) {
                    const updateData = {
                        nombre: name,
                        email: email,
                        rol_id: roleId
                    };
                    
                    if (password && password.trim() !== '') {
                        updateData.password_hash = encryptPassword(password);
                    }

                    result = await supabase
                        .from('usuarios')
                        .update(updateData)
                        .eq('id', currentEditingId);
                        
                    await logSecurityEvent('update', 'Usuario actualizado', { 
                        userId: currentEditingId, 
                        email: email.substring(0, 20) + '...',
                        passwordChanged: !!password
                    }, true);
                } else {
                    result = await supabase
                        .from('usuarios')
                        .insert([{
                            nombre: name,
                            email: email,
                            password_hash: encryptPassword(password),
                            rol_id: roleId,
                            activo: true
                        }]);
                        
                    await logSecurityEvent('create', 'Usuario creado', { 
                        email: email.substring(0, 20) + '...',
                        roleId 
                    }, true);
                }

                if (result.error) {
                    console.error('Error al guardar usuario:', result.error);
                    if (result.error.code === '23505') {
                        showError('Ya existe un usuario con ese email');
                    } else {
                        throw result.error;
                    }
                    return;
                }

                showSuccess('Usuario guardado exitosamente');
                closeModal('userModal');
                await loadUsers();
                
            } catch (error) {
                console.error('Error completo al guardar usuario:', error);
                await logSecurityEvent('error', 'Error al guardar usuario', { 
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al guardar el usuario: ' + error.message);
            }
        }

        async function saveReason(e) {
            e.preventDefault();
            
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                const name = document.getElementById('reasonName').value.trim();
                const description = document.getElementById('reasonDescription').value.trim();

                if (!name) {
                    showError('El nombre del motivo es obligatorio');
                    return;
                }

                if (name.length > 50) {
                    showError('El nombre del motivo no puede exceder 50 caracteres');
                    return;
                }

                if (!validateText(name) || (description && !validateText(description))) {
                    showError('El texto contiene caracteres no permitidos');
                    return;
                }

                let result;
                if (currentEditingId) {
                    result = await supabase
                        .from('motivos')
                        .update({
                            nombre: name,
                            descripcion: description || null
                        })
                        .eq('id', currentEditingId);
                        
                    await logSecurityEvent('update', 'Motivo actualizado', { 
                        reasonId: currentEditingId,
                        name: name.substring(0, 30) + '...'
                    }, true);
                } else {
                    result = await supabase
                        .from('motivos')
                        .insert([{
                            nombre: name,
                            descripcion: description || null,
                            activo: true
                        }]);
                        
                    await logSecurityEvent('create', 'Motivo creado', { 
                        name: name.substring(0, 30) + '...'
                    }, true);
                }

                if (result.error) {
                    console.error('Error al guardar motivo:', result.error);
                    throw result.error;
                }

                showSuccess('Motivo guardado exitosamente');
                closeModal('reasonModal');
                await loadReasons();
                
            } catch (error) {
                console.error('Error completo al guardar motivo:', error);
                await logSecurityEvent('error', 'Error al guardar motivo', { 
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al guardar el motivo: ' + error.message);
            }
        }

        async function saveGrade(e) {
            e.preventDefault();
            
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                const name = document.getElementById('gradeName').value.trim();
                const level = document.getElementById('gradeLevel').value;

                if (!name || !level) {
                    showError('Por favor, completa todos los campos obligatorios');
                    return;
                }

                if (name.length > 20) {
                    showError('El nombre del grado no puede exceder 20 caracteres');
                    return;
                }

                if (!validateText(name)) {
                    showError('El nombre contiene caracteres no permitidos');
                    return;
                }

                let result;
                if (currentEditingId) {
                    result = await supabase
                        .from('grados')
                        .update({
                            nombre: name,
                            nivel: level
                        })
                        .eq('id', currentEditingId);
                        
                    await logSecurityEvent('update', 'Grado actualizado', { 
                        gradeId: currentEditingId,
                        name: name,
                        level: level
                    }, true);
                } else {
                    result = await supabase
                        .from('grados')
                        .insert([{
                            nombre: name,
                            nivel: level,
                            activo: true
                        }]);
                        
                    await logSecurityEvent('create', 'Grado creado', { 
                        name: name, 
                        level: level 
                    }, true);
                }

                if (result.error) {
                    console.error('Error al guardar grado:', result.error);
                    throw result.error;
                }

                showSuccess('Grado guardado exitosamente');
                closeModal('gradeModal');
                await loadGrades();
                
            } catch (error) {
                console.error('Error completo al guardar grado:', error);
                await logSecurityEvent('error', 'Error al guardar grado', { 
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al guardar el grado: ' + error.message);
            }
        }

        // ========================================
        // FUNCIONES DE ACTUALIZACIÓN DE TABLAS (CON SANITIZACIÓN)
        // ========================================

        function updateStudentsTable(students) {
            const tbody = document.querySelector('#studentsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            students.forEach(student => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${sanitizeHtml(student.nombre)}</td>
                    <td>${sanitizeHtml(student.apellidos)}</td>
                    <td>${student.documento ? sanitizeHtml(student.documento) : 'N/A'}</td>
                    <td>${student.grado?.nombre ? sanitizeHtml(student.grado.nombre) : 'Sin grado'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editStudent(${student.id})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteStudent(${student.id})">Eliminar</button>
                    </td>
                `;
            });
            
            // Configurar scroll después de actualizar la tabla
            setTimeout(setupTableScroll, 50);
        }

        function updateUsersTable(users) {
            const tbody = document.querySelector('#usersTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            users.forEach(user => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${sanitizeHtml(user.nombre)}</td>
                    <td>${sanitizeHtml(user.email)}</td>
                    <td>${user.rol?.descripcion ? sanitizeHtml(user.rol.descripcion) : 'Sin rol'}</td>
                    <td>${user.activo ? 'Activo' : 'Inactivo'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editUser(${user.id})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteUser(${user.id})">Eliminar</button>
                    </td>
                `;
            });
            
            setTimeout(setupTableScroll, 50);
        }

        function updateReasonsTable(reasons) {
            const tbody = document.querySelector('#reasonsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            reasons.forEach(reason => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${sanitizeHtml(reason.nombre)}</td>
                    <td>${reason.descripcion ? sanitizeHtml(reason.descripcion) : 'N/A'}</td>
                    <td>${reason.activo ? 'Activo' : 'Inactivo'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editReason(${reason.id})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteReason(${reason.id})">Eliminar</button>
                    </td>
                `;
            });
            
            setTimeout(setupTableScroll, 50);
        }

        function updateGradesTable(grades) {
            const tbody = document.querySelector('#gradesTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            grades.forEach(grade => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${sanitizeHtml(grade.nombre)}</td>
                    <td>${sanitizeHtml(grade.nivel)}</td>
                    <td>${grade.activo ? 'Activo' : 'Inactivo'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editGrade(${grade.id})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteGrade(${grade.id})">Eliminar</button>
                    </td>
                `;
            });
            
            setTimeout(setupTableScroll, 50);
        }

        // ========================================
        // FUNCIONES DE HISTORIAL (CON MEJORAS DE SEGURIDAD)
        // ========================================

        async function loadHistory(all = false) {
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                console.log('🔍 Cargando historial...');
                
                let query = supabase
                    .from('autorizaciones_salida')
                    .select('*')
                    .order('fecha_creacion', { ascending: false });

                if (!all) {
                    const date = document.getElementById('historyDate').value;
                    if (date) {
                        console.log('🗓️ Filtrando por fecha:', date);
                        query = query.eq('fecha_salida', date);
                    } else {
                        const todayColombia = getColombiaDate();
                        const thirtyDaysAgo = new Date(todayColombia);
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        const dateLimit = thirtyDaysAgo.toISOString().split('T')[0];
                        console.log('🗓️ Filtrando últimos 30 días desde:', dateLimit, 'hasta:', todayColombia);
                        query = query.gte('fecha_salida', dateLimit);
                    }
                }

                const { data: authorizations, error } = await query;

                if (error) {
                    console.error('❌ Error en consulta de historial:', error);
                    showError('Error al cargar el historial: ' + error.message);
                    return;
                }

                if (!authorizations || authorizations.length === 0) {
                    console.log('📊 No se encontraron autorizaciones');
                    const tbody = document.querySelector('#historyTable tbody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #666; padding: 20px;">
                                No se encontraron registros para el período seleccionado<br>
                                <small>Zona horaria: Colombia (UTC-5)</small>
                            </td>
                        </tr>
                    `;
                    showSuccess('Historial cargado: 0 registros');
                    return;
                }

                console.log('📊 Autorizaciones encontradas:', authorizations.length);

                const studentIds = [...new Set(authorizations.map(auth => auth.estudiante_id))];
                const reasonIds = [...new Set(authorizations.map(auth => auth.motivo_id))];
                const userIds = [...new Set(authorizations.map(auth => auth.usuario_autorizador_id))];

                console.log('👥 IDs únicos - Estudiantes:', studentIds.length, 'Motivos:', reasonIds.length, 'Usuarios:', userIds.length);

                const [studentsResult, reasonsResult, usersResult] = await Promise.all([
                    supabase
                        .from('estudiantes')
                        .select(`
                            id, nombre, apellidos,
                            grado:grados(nombre)
                        `)
                        .in('id', studentIds),
                    supabase
                        .from('motivos')
                        .select('id, nombre')
                        .in('id', reasonIds),
                    supabase
                        .from('usuarios')
                        .select('id, nombre')
                        .in('id', userIds)
                ]);

                if (studentsResult.error) console.error('Error estudiantes:', studentsResult.error);
                if (reasonsResult.error) console.error('Error motivos:', reasonsResult.error);
                if (usersResult.error) console.error('Error usuarios:', usersResult.error);

                const studentMap = {};
                const reasonMap = {};
                const userMap = {};

                studentsResult.data?.forEach(student => {
                    studentMap[student.id] = student;
                });

                reasonsResult.data?.forEach(reason => {
                    reasonMap[reason.id] = reason;
                });

                usersResult.data?.forEach(user => {
                    userMap[user.id] = user;
                });

                console.log('📋 Mapas creados - Estudiantes:', Object.keys(studentMap).length, 'Motivos:', Object.keys(reasonMap).length, 'Usuarios:', Object.keys(userMap).length);

                const tbody = document.querySelector('#historyTable tbody');
                tbody.innerHTML = '';
                
                authorizations.forEach(record => {
                    const student = studentMap[record.estudiante_id];
                    const reason = reasonMap[record.motivo_id];
                    const user = userMap[record.usuario_autorizador_id];

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${student ? `${sanitizeHtml(student.nombre)} ${sanitizeHtml(student.apellidos)}` : 'Estudiante no encontrado'}</td>
                        <td>${student?.grado?.nombre ? sanitizeHtml(student.grado.nombre) : 'Grado no encontrado'}</td>
                        <td>${reason?.nombre ? sanitizeHtml(reason.nombre) : 'Motivo no encontrado'}</td>
                        <td>${formatDate(record.fecha_salida)}</td>
                        <td>${formatTime(record.hora_salida)}</td>
                        <td>${user?.nombre ? sanitizeHtml(user.nombre) : 'Usuario no encontrado'}</td>
                        <td>
                            <span style="color: ${record.salida_efectiva ? '#2ecc71' : '#f39c12'}">
                                ${record.salida_efectiva ? '✅ Confirmada' : '⏳ Pendiente'}
                            </span>
                            ${record.salida_efectiva ? `<br><small style="color: #666;">Hora: ${formatDateTime(record.salida_efectiva)}</small>` : ''}
                            ${record.observaciones ? `<br><small style="color: #666;">Obs: ${sanitizeHtml(record.observaciones)}</small>` : ''}
                        </td>
                    `;
                });

                const currentTime = getColombiaTime();
                showSuccess(`Historial cargado: ${authorizations.length} registros (${currentTime} - Colombia)`);
                console.log('✅ Historial cargado exitosamente');
                
                // Configurar scroll después de cargar los datos
                setTimeout(() => {
                    setupTableScroll();
                }, 100);
                
            } catch (error) {
                console.error('❌ Error general en loadHistory:', error);
                await logSecurityEvent('error', 'Error al cargar historial', { 
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al cargar el historial: ' + error.message);
            }
        }

        async function debugHistory() {
            const debugDiv = document.getElementById('historyDebug');
            const debugContent = document.getElementById('historyDebugContent');
            
            debugDiv.style.display = 'block';
            debugContent.innerHTML = '🔄 Analizando datos del historial...';
            
            try {
                if (!validateSession()) {
                    debugContent.innerHTML = '❌ Sesión expirada';
                    return;
                }

                console.log('🔧 Iniciando debug del historial...');
                
                const todayColombia = getColombiaDate();
                const currentTime = getColombiaTime();
                
                const [totalAuthResult, totalStudentsResult, totalUsersResult, totalReasonsResult, totalGradesResult, todayAuthResult, lastAuthResult] = await Promise.all([
                    supabase.from('autorizaciones_salida').select('*'),
                    supabase.from('estudiantes').select('*'),
                    supabase.from('usuarios').select('*'),
                    supabase.from('motivos').select('*'),
                    supabase.from('grados').select('*'),
                    supabase.from('autorizaciones_salida').select('*').eq('fecha_salida', todayColombia),
                    supabase.from('autorizaciones_salida').select('*').order('fecha_creacion', { ascending: false }).limit(5)
                ]);
                
                let html = '<ul style="text-align: left;">';
                html += `<li><strong>🕐 Hora actual Colombia:</strong> ${formatDate(todayColombia)} ${currentTime} (UTC-5)</li>`;
                html += `<li><strong>📊 Total autorizaciones:</strong> ${totalAuthResult.data?.length || 0} ${totalAuthResult.error ? '❌ Error: ' + totalAuthResult.error.message : '✅'}</li>`;
                html += `<li><strong>👨‍🎓 Total estudiantes:</strong> ${totalStudentsResult.data?.length || 0} ${totalStudentsResult.error ? '❌ Error: ' + totalStudentsResult.error.message : '✅'}</li>`;
                html += `<li><strong>👥 Total usuarios:</strong> ${totalUsersResult.data?.length || 0} ${totalUsersResult.error ? '❌ Error: ' + totalUsersResult.error.message : '✅'}</li>`;
                html += `<li><strong>📝 Total motivos:</strong> ${totalReasonsResult.data?.length || 0} ${totalReasonsResult.error ? '❌ Error: ' + totalReasonsResult.error.message : '✅'}</li>`;
                html += `<li><strong>🎓 Total grados:</strong> ${totalGradesResult.data?.length || 0} ${totalGradesResult.error ? '❌ Error: ' + totalGradesResult.error.message : '✅'}</li>`;
                html += `<li><strong>📅 Autorizaciones hoy (${formatDate(todayColombia)}):</strong> ${todayAuthResult.data?.length || 0} ${todayAuthResult.error ? '❌ Error: ' + todayAuthResult.error.message : '✅'}</li>`;
                html += `<li><strong>🕐 Últimas 5 autorizaciones:</strong> ${lastAuthResult.data?.length || 0} ${lastAuthResult.error ? '❌ Error: ' + lastAuthResult.error.message : '✅'}</li>`;
                
                if (lastAuthResult.data && lastAuthResult.data.length > 0) {
                    html += '<li><strong>📋 Detalles de últimas autorizaciones:</strong><br>';
                    lastAuthResult.data.forEach((auth, index) => {
                        const fechaCreacion = auth.fecha_creacion ? formatDateTime(auth.fecha_creacion) : 'N/A';
                        html += `&nbsp;&nbsp;${index + 1}. ID: ${auth.id}, Estudiante ID: ${auth.estudiante_id}, Fecha salida: ${auth.fecha_salida}, Autorizada: ${auth.autorizada ? 'Sí' : 'No'}, Creada: ${fechaCreacion}<br>`;
                    });
                    html += '</li>';
                }

                if (totalAuthResult.data && totalAuthResult.data.length > 0) {
                    const sampleAuth = totalAuthResult.data[0];
                    html += '<li><strong>🔍 Estructura de autorización (muestra):</strong><br>';
                    html += `&nbsp;&nbsp;Columnas disponibles: ${Object.keys(sampleAuth).join(', ')}<br>`;
                    html += '</li>';
                }
                
                html += '</ul>';
                
                debugContent.innerHTML = html;
                console.log('🔧 Debug completado');
                
            } catch (error) {
                console.error('❌ Error en debug:', error);
                debugContent.innerHTML = `❌ Error en debug: ${error.message}`;
                await logSecurityEvent('error', 'Error en debug de historial', { 
                    error: error.message.substring(0, 200) 
                }, false);
            }
        }

        // ========================================
        // FUNCIONES DE EDICIÓN Y ELIMINACIÓN (CON VALIDACIONES)
        // ========================================

        async function editStudent(id) {
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                const { data: student, error } = await supabase
                    .from('estudiantes')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditingId = id;
                document.getElementById('studentName').value = student.nombre;
                document.getElementById('studentLastName').value = student.apellidos;
                document.getElementById('studentDocument').value = student.documento || '';
                document.getElementById('studentGrade').value = student.grado_id;
                
                openModal('studentModal');
                
            } catch (error) {
                await logSecurityEvent('error', 'Error al cargar datos de estudiante', { 
                    studentId: id,
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al cargar los datos del estudiante: ' + error.message);
            }
        }

        async function deleteStudent(id) {
            if (!validateSession()) {
                showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                logout();
                return;
            }

            if (confirm('¿Estás seguro de que quieres eliminar este estudiante?')) {
                try {
                    const { data, error } = await supabase
                        .from('estudiantes')
                        .update({ activo: false })
                        .eq('id', id);

                    if (error) throw error;

                    await logSecurityEvent('delete', 'Estudiante eliminado', { studentId: id }, true);
                    showSuccess('Estudiante eliminado exitosamente');
                    await loadStudents();
                    
                } catch (error) {
                    await logSecurityEvent('error', 'Error al eliminar estudiante', { 
                        studentId: id,
                        error: error.message.substring(0, 200) 
                    }, false);
                    showError('Error al eliminar el estudiante: ' + error.message);
                }
            }
        }

        async function editUser(id) {
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                const { data: user, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditingId = id;
                document.getElementById('userName').value = user.nombre;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userPassword').value = '';
                document.getElementById('userRole').value = user.rol_id;
                
                document.getElementById('passwordNote').textContent = '(dejar vacío para mantener actual)';
                document.getElementById('userPassword').required = false;
                document.getElementById('userPasswordStrength').style.display = 'none';
                
                openModal('userModal');
                
            } catch (error) {
                await logSecurityEvent('error', 'Error al cargar datos de usuario', { 
                    userId: id,
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al cargar los datos del usuario: ' + error.message);
            }
        }

        async function deleteUser(id) {
            if (!validateSession()) {
                showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                logout();
                return;
            }

            if (id === currentUser.id) {
                showError('No puedes eliminar tu propio usuario');
                return;
            }
            
            if (confirm('¿Estás seguro de que quieres eliminar este usuario?')) {
                try {
                    const { data, error } = await supabase
                        .from('usuarios')
                        .update({ activo: false })
                        .eq('id', id);

                    if (error) throw error;

                    await logSecurityEvent('delete', 'Usuario eliminado', { userId: id }, true);
                    showSuccess('Usuario eliminado exitosamente');
                    await loadUsers();
                    
                } catch (error) {
                    await logSecurityEvent('error', 'Error al eliminar usuario', { 
                        userId: id,
                        error: error.message.substring(0, 200) 
                    }, false);
                    showError('Error al eliminar el usuario: ' + error.message);
                }
            }
        }

        async function editReason(id) {
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                const { data: reason, error } = await supabase
                    .from('motivos')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditingId = id;
                document.getElementById('reasonName').value = reason.nombre;
                document.getElementById('reasonDescription').value = reason.descripcion || '';
                
                openModal('reasonModal');
                
            } catch (error) {
                await logSecurityEvent('error', 'Error al cargar datos de motivo', { 
                    reasonId: id,
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al cargar los datos del motivo: ' + error.message);
            }
        }

        async function deleteReason(id) {
            if (!validateSession()) {
                showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                logout();
                return;
            }

            if (confirm('¿Estás seguro de que quieres eliminar este motivo?')) {
                try {
                    const { data, error } = await supabase
                        .from('motivos')
                        .update({ activo: false })
                        .eq('id', id);

                    if (error) throw error;

                    await logSecurityEvent('delete', 'Motivo eliminado', { reasonId: id }, true);
                    showSuccess('Motivo eliminado exitosamente');
                    await loadReasons();
                    
                } catch (error) {
                    await logSecurityEvent('error', 'Error al eliminar motivo', { 
                        reasonId: id,
                        error: error.message.substring(0, 200) 
                    }, false);
                    showError('Error al eliminar el motivo: ' + error.message);
                }
            }
        }

        async function editGrade(id) {
            try {
                if (!validateSession()) {
                    showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    logout();
                    return;
                }

                const { data: grade, error } = await supabase
                    .from('grados')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditingId = id;
                document.getElementById('gradeName').value = grade.nombre;
                document.getElementById('gradeLevel').value = grade.nivel;
                
                openModal('gradeModal');
                
            } catch (error) {
                await logSecurityEvent('error', 'Error al cargar datos de grado', { 
                    gradeId: id,
                    error: error.message.substring(0, 200) 
                }, false);
                showError('Error al cargar los datos del grado: ' + error.message);
            }
        }

        async function deleteGrade(id) {
            if (!validateSession()) {
                showError('Sesión expirada. Por favor, inicia sesión de nuevo.');
                logout();
                return;
            }

            if (confirm('¿Estás seguro de que quieres eliminar este grado?')) {
                try {
                    const { data, error } = await supabase
                        .from('grados')
                        .update({ activo: false })
                        .eq('id', id);

                    if (error) throw error;

                    await logSecurityEvent('delete', 'Grado eliminado', { gradeId: id }, true);
                    showSuccess('Grado eliminado exitosamente');
                    await loadGrades();
                    
                } catch (error) {
                    await logSecurityEvent('error', 'Error al eliminar grado', { 
                        gradeId: id,
                        error: error.message.substring(0, 200) 
                    }, false);
                    showError('Error al eliminar el grado: ' + error.message);
                }
            }
        }

        // ========================================
        // EVENT LISTENERS Y CONFIGURACIÓN INICIAL
        // ========================================

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Prevenir inyección de scripts en todos los inputs
        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                const value = e.target.value;
                
                // Detectar y bloquear scripts maliciosos
                const scriptPatterns = [
                    /<script[^>]*>.*?<\/script>/gi,
                    /javascript:/gi,
                    /vbscript:/gi,
                    /on\w+\s*=/gi,
                    /<iframe[^>]*>.*?<\/iframe>/gi,
                    /<object[^>]*>.*?<\/object>/gi,
                    /<embed[^>]*>/gi
                ];
                
                let hasScripts = false;
                scriptPatterns.forEach(pattern => {
                    if (pattern.test(value)) {
                        hasScripts = true;
                    }
                });
                
                if (hasScripts) {
                    e.target.value = value.replace(/[<>]/g, '');
                    showError('Se detectaron caracteres potencialmente peligrosos y fueron removidos');
                    
                    // Log del intento de inyección
                    logSecurityEvent('security', 'Intento de inyección de script detectado', {
                        input: e.target.id || e.target.name || 'campo desconocido',
                        value: value.substring(0, 100) + '...'
                    }, false);
                }
            }
        });

        // Prevenir copiar/pegar código malicioso
        document.addEventListener('paste', function(e) {
            const pastedData = (e.clipboardData || window.clipboardData).getData('text');
            
            const scriptPatterns = [
                /<script[^>]*>.*?<\/script>/gi,
                /javascript:/gi,
                /vbscript:/gi,
                /on\w+\s*=/gi
            ];
            
            let hasScripts = false;
            scriptPatterns.forEach(pattern => {
                if (pattern.test(pastedData)) {
                    hasScripts = true;
                }
            });
            
            if (hasScripts) {
                e.preventDefault();
                showError('El contenido pegado contiene código potencialmente peligroso y fue bloqueado');
                
                logSecurityEvent('security', 'Intento de pegar contenido malicioso', {
                    content: pastedData.substring(0, 100) + '...'
                }, false);
            }
        });

        // Configurar listeners de actividad para sesión
        function setupActivityListeners() {
            const events = ['click', 'keypress', 'mousemove', 'scroll', 'touchstart'];
            events.forEach(event => {
                document.addEventListener(event, () => {
                    if (currentUser && validateSession()) {
                        renewSession();
                    }
                }, { passive: true });
            });
        }

        // Detectar intentos de manipulación del DOM
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            const scripts = node.querySelectorAll ? node.querySelectorAll('script') : [];
                            if (scripts.length > 0) {
                                console.warn('🚨 Intento de inyección de script detectado');
                                scripts.forEach(script => script.remove());
                                
                                logSecurityEvent('security', 'Intento de inyección DOM detectado', {
                                    element: node.tagName || 'unknown'
                                }, false);
                            }
                        }
                    });
                }
            });
        });

        // Inicializar la aplicación con todas las medidas de seguridad
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Sistema iniciado con medidas de seguridad avanzadas');
            console.log('🔒 Medidas activas:');
            console.log('  ✅ Headers de Seguridad CSP');
            console.log('  ✅ Sanitización XSS');
            console.log('  ✅ Rate Limiting');
            console.log('  ✅ CAPTCHA Anti-Bot');
            console.log('  ✅ Logs de Auditoría');
            console.log('  ✅ Validación HTML');
            console.log('  ✅ Sesiones Seguras');
            console.log('  ✅ Cifrado de Datos');
            console.log('  ✅ Diseño Responsive');
            console.log('  ✅ Dashboard General');
            console.log('  ✅ Control de Vigilancia');
            
            updateConnectionStatus(false, 'Conectando...');
            updateSecurityIndicator('warning', 'Iniciando Sistema');
            
            // Verificar dependencias críticas
            setTimeout(() => {
                console.log('🔍 Verificando dependencias...');
                
                // Verificar Chart.js
                if (typeof Chart === 'undefined') {
                    console.error('❌ Chart.js no se cargó correctamente');
                    updateSecurityIndicator('error', 'Error: Chart.js no cargado');
                } else {
                    console.log('✅ Chart.js cargado correctamente:', Chart.version);
                }
                
                // Verificar Supabase
                if (!window.supabase) {
                    console.error('❌ Supabase no se cargó correctamente');
                    updateSecurityIndicator('error', 'Error: Supabase no cargado');
                } else {
                    console.log('✅ Supabase disponible');
                }
                
                // Verificar CryptoJS
                if (typeof CryptoJS === 'undefined') {
                    console.error('❌ CryptoJS no se cargó correctamente');
                } else {
                    console.log('✅ CryptoJS disponible');
                }
                
            }, 500);
            
            // Configurar observador de DOM
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // Configurar listeners de actividad
            setupActivityListeners();
            
            // Inicializar responsive design
            detectDeviceAndAdjustUI();
            setupTableScroll();
            enhanceTouchExperience();
            optimizeViewport();
            createMobileQuickActions();
            
            // Listeners para cambios de ventana
            window.addEventListener('resize', () => {
                clearTimeout(window.resizeTimeout);
                window.resizeTimeout = setTimeout(() => {
                    detectDeviceAndAdjustUI();
                    setupTableScroll();
                }, 250);
            });
            
            window.addEventListener('orientationchange', handleOrientationChange);
            
            // Esperar un momento para que todas las librerías terminen de cargar
            setTimeout(() => {
                console.log('🔗 Iniciando conexión a Supabase...');
                initSupabase();
            }, 1000);
        });

        // Limpiar recursos al cerrar la página
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                logSecurityEvent('logout', 'Cierre de página', { 
                    userId: currentUser.id 
                }, true);
            }
            
            // Limpiar datos sensibles
            currentUser = null;
            sessionToken = null;
            sessionStartTime = null;
        });

        // Detectar cambios de visibilidad de la página (seguridad adicional)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden' && currentUser) {
                // La página se oculta, pausar actividad sensible
                console.log('📱 Página oculta, pausando actividad');
            } else if (document.visibilityState === 'visible' && currentUser) {
                // La página vuelve a ser visible, verificar sesión
                console.log('📱 Página visible, verificando sesión');
                if (!validateSession()) {
                    showError('Sesión expirada por inactividad');
                    logout();
                }
            }
        });

    </script>

<script>
  function handleImageUpload(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('studentPhotoPreview');
    const base64Input = document.getElementById('studentPhotoBase64');
    if (!file) return;

    if (!file.type.match(/^image\/(jpeg|png|gif)$/)) {
      alert("Formato no válido. Solo JPG, PNG o GIF.");
      event.target.value = '';
      return;
    }

    if (file.size > 2 * 1024 * 1024) {
      alert("La imagen debe ser menor a 2MB.");
      event.target.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const maxWidth = 400;
        const scale = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const resizedBase64 = canvas.toDataURL(file.type);
        preview.src = resizedBase64;
        base64Input.value = resizedBase64;
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
</script>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = createClient(
    'https://YOUR_PROJECT.supabase.co',
    'YOUR_ANON_KEY'
  );

  document.getElementById('studentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const name = document.getElementById('studentName').value;
    const lastName = document.getElementById('studentLastName').value;
    const documentId = document.getElementById('studentDocument').value;
    const grade = document.getElementById('studentGrade').value;
    const photoBase64 = document.getElementById('studentPhotoBase64').value;

    const { data, error } = await supabase
      .from('estudiantes')
      .insert([
        {
          nombre: name,
          apellido: lastName,
          documento: documentId,
          grado: grade,
          foto_base64: photoBase64
        }
      ]);

    if (error) {
      console.error('Error al guardar:', error);
      alert("❌ Error al guardar estudiante.");
    } else {
      console.log('Estudiante guardado:', data);
      alert("✅ Estudiante guardado correctamente.");
      document.getElementById('studentForm').reset();
      document.getElementById('studentPhotoPreview').src = "https://via.placeholder.com/120";
    }
  });
</script>


<script>
  document.getElementById('studentSelect').addEventListener('change', function () {
    const selected = this.value;
    fetch('https://YOUR_PROJECT.supabase.co/rest/v1/estudiantes?documento=eq.' + selected, {
      headers: {
        'apikey': 'YOUR_ANON_KEY',
        'Authorization': 'Bearer YOUR_ANON_KEY',
        'Content-Type': 'application/json'
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.length > 0) {
        const img = document.getElementById('authStudentPhoto');
        img.src = data[0].foto_base64 || "https://via.placeholder.com/120";
      }
    });
  });
</script>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = createClient(
    'https://mbosvnmhnbrslfwlfcxu.supabase.co',
    'b2492d7cbbbf22854205609ca01f16f2'
  );

  async function uploadImageToStorage(file) {
    const fileName = Date.now() + '-' + file.name.replace(/[^a-zA-Z0-9.]/g, '_');
    const { data, error } = await supabase.storage
      .from('autorizaciones')
      .upload('fotos/' + fileName, file, {
        cacheControl: '3600',
        upsert: true
      });
    if (error) {
      console.error("Error al subir imagen:", error.message);
      alert("❌ Error subiendo imagen");
      return null;
    }

    const { data: urlData } = supabase
      .storage
      .from('autorizaciones')
      .getPublicUrl('fotos/' + fileName);
    return urlData.publicUrl;
  }

  document.getElementById('studentForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const file = document.getElementById('uploadStudentPhoto').files[0];
    let photoUrl = "";

    if (file) {
      photoUrl = await uploadImageToStorage(file);
      if (!photoUrl) return;
    }

    const name = document.getElementById('studentName').value;
    const lastName = document.getElementById('studentLastName').value;
    const documentId = document.getElementById('studentDocument').value;
    const grade = document.getElementById('studentGrade').value;

    const { data, error } = await supabase
      .from('estudiantes')
      .insert([ {
        nombre: name,
        apellido: lastName,
        documento: documentId,
        grado: grade,
        foto_url: photoUrl
      } ]);

    if (error) {
      console.error('Error al guardar estudiante:', error.message);
      alert("❌ Error al guardar estudiante.");
    } else {
      alert("✅ Estudiante guardado correctamente.");
      document.getElementById('studentForm').reset();
      document.getElementById('studentPhotoPreview').src = "https://via.placeholder.com/120";
    }
  });
</script>





<script>
  document.getElementById('studentSelect')?.addEventListener('change', async function () {
    const studentId = this.value;
    if (!studentId) return;

    const { data, error } = await supabase
      .from('estudiantes')
      .select('foto_url')
      .eq('documento', studentId)
      .single();

    const img = document.getElementById('authStudentPhoto');
    if (error || !data?.foto_url) {
      console.error("No se pudo cargar la foto:", error?.message);
      img.src = "https://via.placeholder.com/120";
    } else {
      img.src = data.foto_url;
    }
  });
</script>


<script>
  async function cargarVerificaciones() {
    const contenedor = document.getElementById("verificaciones");
    contenedor.innerHTML = "";

    const { data: salidas, error: errorSalidas } = await supabase
      .from("autorizaciones")
      .select("documento, motivo, hora");

    if (errorSalidas) {
      console.error("Error cargando salidas:", errorSalidas.message);
      return;
    }

    for (const salida of salidas) {
      const { data: estudiante, error: errorEst } = await supabase
        .from("estudiantes")
        .select("nombre, grado, foto_url")
        .eq("documento", salida.documento)
        .single();

      const div = document.createElement("div");
      div.className = "verificacion-card";
      div.style = "border:1px solid #ddd; padding:10px; border-radius:10px; margin:10px 0; text-align:center;";

      div.innerHTML = `
        <img src="${estudiante?.foto_url || 'https://via.placeholder.com/120'}"
          style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #bbb;margin-bottom:10px;">
        <h3>${estudiante?.nombre || 'Estudiante'}</h3>
        <p><strong>Grado:</strong> ${estudiante?.grado || '--'}</p>
        <p><strong>Motivo:</strong> ${salida?.motivo || '--'}</p>
        <p><strong>Hora:</strong> ${salida?.hora || '--:--'}</p>
      `;
      contenedor.appendChild(div);
    }
  }

  window.addEventListener('DOMContentLoaded', cargarVerificaciones);
</script>

</body>
</html>
