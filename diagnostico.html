<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIAGN√ìSTICO - Sistema Colegio Gemelli</title>
    <!-- M√∫ltiples CDNs de Supabase para asegurar carga -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Verificar si Supabase est√° disponible y cargar alternativa si no
        if (typeof window.supabase === 'undefined') {
            console.log('‚ö†Ô∏è Supabase no carg√≥ desde CDN principal, intentando alternativa...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.39.0/umd.min.js';
            script.onload = function() {
                console.log('‚úÖ Supabase cargado desde CDN alternativa');
                initApp();
            };
            script.onerror = function() {
                console.error('‚ùå Error cargando Supabase desde todas las fuentes');
                document.getElementById('connectionStatus').innerHTML = '‚ùå Error: No se pudo cargar la librer√≠a de Supabase';
            };
            document.head.appendChild(script);
        } else {
            console.log('‚úÖ Supabase cargado correctamente');
            initApp();
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .log-area {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß DIAGN√ìSTICO - Sistema Colegio Gemelli</h1>
        
        <div id="connectionStatus" class="status warning">
            üîÑ Iniciando diagn√≥stico...
        </div>

        <div class="form-group">
            <h3>üìã Pasos de Diagn√≥stico:</h3>
            <button class="btn" onclick="step1()">1. Verificar URLs de Supabase</button>
            <button class="btn" onclick="step2()">2. Probar Conexi√≥n B√°sica</button>
            <button class="btn" onclick="step3()">3. Verificar Tablas</button>
            <button class="btn" onclick="step4()">4. Verificar Usuarios</button>
            <button class="btn" onclick="step5()">5. Probar Login</button>
            <button class="btn" onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
        </div>

        <div class="log-area" id="logArea">
            Sistema de diagn√≥stico iniciado...\n
        </div>

        <div class="form-group">
            <h3>üîê Prueba de Login:</h3>
            <label>Email:</label>
            <input type="email" id="testEmail" placeholder="usuario@colgemelli.edu.co">
        </div>
        <div class="form-group">
            <label>Contrase√±a:</label>
            <input type="password" id="testPassword" placeholder="contrase√±a">
        </div>
        <button class="btn" onclick="testLogin()">üöÄ Probar Login</button>

        <div class="form-group">
            <h3>üìä Informaci√≥n del Sistema:</h3>
            <div id="systemInfo"></div>
        </div>
    </div>

    <script defer src="env.js"></script>
    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = process.env.SUPABASE_URL;
        const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY;
        
        let supabase;

        // Funci√≥n para escribir en el log
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'success': '#00ff00',
                'error': '#ff0000',
                'warning': '#ffaa00',
                'info': '#00aaff'
            };
            
            logArea.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = 'Log limpiado...\n';
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        // Paso 1: Verificar configuraci√≥n
        function step1() {
            log('=== PASO 1: Verificando URLs de Supabase ===');
            log(`URL: ${SUPABASE_URL}`);
            log(`API Key length: ${SUPABASE_ANON_KEY.length} caracteres`);
            log(`API Key empieza con: ${SUPABASE_ANON_KEY.substring(0, 20)}...`);
            
            if (SUPABASE_URL.includes('supabase.co') && SUPABASE_ANON_KEY.length > 100) {
                log('‚úÖ URLs parecen correctas', 'success');
                updateStatus('‚úÖ URLs verificadas', 'success');
            } else {
                log('‚ùå URLs parecen incorrectas', 'error');
                updateStatus('‚ùå Error en URLs', 'error');
            }
        }

        // Paso 2: Probar conexi√≥n b√°sica
        async function step2() {
            log('=== PASO 2: Probando conexi√≥n b√°sica ===');
            
            // Verificar si Supabase est√° disponible
            log(`window.supabase existe: ${typeof window.supabase !== 'undefined'}`);
            log(`Objeto window.supabase: ${window.supabase ? 'S√ç' : 'NO'}`);
            
            if (typeof window.supabase === 'undefined') {
                log('‚ùå window.supabase no est√° definido', 'error');
                log('üí° Intentando cargar manualmente...', 'warning');
                
                // Intentar cargar manualmente
                try {
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/@supabase/supabase-js@2';
                    document.head.appendChild(script);
                    
                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = reject;
                        setTimeout(reject, 5000); // timeout de 5 segundos
                    });
                    
                    log('‚úÖ Librer√≠a cargada manualmente', 'success');
                } catch (error) {
                    log('‚ùå No se pudo cargar la librer√≠a manualmente', 'error');
                    updateStatus('‚ùå Error cargando librer√≠a Supabase', 'error');
                    return;
                }
            }
            
            try {
                // Verificar que createClient existe
                if (typeof window.supabase.createClient !== 'function') {
                    log('‚ùå createClient no es una funci√≥n', 'error');
                    log(`Tipo de createClient: ${typeof window.supabase.createClient}`, 'error');
                    updateStatus('‚ùå Error en librer√≠a Supabase', 'error');
                    return;
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('‚úÖ Cliente Supabase creado', 'success');
                
                // Probar una consulta muy simple
                const { data, error } = await supabase
                    .from('roles')
                    .select('count');
                
                if (error) {
                    log(`‚ùå Error en consulta: ${error.message}`, 'error');
                    log(`C√≥digo de error: ${error.code}`, 'error');
                    log(`Detalles: ${JSON.stringify(error, null, 2)}`, 'error');
                    updateStatus('‚ùå Error de conexi√≥n a BD', 'error');
                } else {
                    log('‚úÖ Conexi√≥n establecida correctamente', 'success');
                    updateStatus('‚úÖ Conectado a Supabase', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
                updateStatus('‚ùå Error de conexi√≥n', 'error');
            }
        }

        // Paso 3: Verificar tablas
        async function step3() {
            log('=== PASO 3: Verificando tablas ===');
            
            const tables = ['roles', 'usuarios', 'grados', 'estudiantes', 'motivos', 'autorizaciones_salida'];
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        log(`‚ùå Tabla '${table}': ${error.message}`, 'error');
                    } else {
                        log(`‚úÖ Tabla '${table}': OK`, 'success');
                    }
                } catch (error) {
                    log(`‚ùå Error al verificar tabla '${table}': ${error.message}`, 'error');
                }
            }
        }

        // Paso 4: Verificar usuarios
        async function step4() {
            log('=== PASO 4: Verificando usuarios ===');
            
            try {
                const { data: users, error } = await supabase
                    .from('usuarios')
                    .select('id, nombre, email, rol_id, activo');
                
                if (error) {
                    log(`‚ùå Error al buscar usuarios: ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Usuarios encontrados: ${users.length}`, 'success');
                    users.forEach(user => {
                        log(`   - ${user.nombre} (${user.email}) - Rol: ${user.rol_id} - Activo: ${user.activo}`, 'info');
                    });
                }
            } catch (error) {
                log(`‚ùå Error al verificar usuarios: ${error.message}`, 'error');
            }
        }

        // Paso 5: Probar login espec√≠fico
        async function step5() {
            log('=== PASO 5: Probando login espec√≠fico ===');
            
            try {
                const email = document.getElementById('testEmail').value;
                const { data: user, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (error) {
                    log(`‚ùå Error al buscar usuario: ${error.message}`, 'error');
                    if (error.code === 'PGRST116') {
                        log('   üí° Este error significa que no se encontr√≥ el usuario', 'warning');
                    }
                } else {
                    log(`‚úÖ Usuario encontrado: ${user.nombre}`, 'success');
                    log(`   Email: ${user.email}`, 'info');
                    log(`   Password hash: ${user.password_hash}`, 'info');
                    log(`   Rol ID: ${user.rol_id}`, 'info');
                    log(`   Activo: ${user.activo}`, 'info');
                }
            } catch (error) {
                log(`‚ùå Error en paso 5: ${error.message}`, 'error');
            }
        }

        // Funci√≥n de login de prueba
        async function testLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            log('=== PRUEBA DE LOGIN ===');
            log(`Intentando login con: ${email}`);
            
            try {
                const { data: user, error } = await supabase
                    .from('usuarios')
                    .select(`
                        *,
                        rol:roles(nombre, descripcion)
                    `)
                    .eq('email', email)
                    .eq('activo', true)
                    .single();

                if (error) {
                    log(`‚ùå Error en login: ${error.message}`, 'error');
                    log(`C√≥digo: ${error.code}`, 'error');
                } else if (!user) {
                    log('‚ùå Usuario no encontrado', 'error');
                } else {
                    log(`‚úÖ Usuario encontrado: ${user.nombre}`, 'success');
                    
                    if (user.password_hash === password) {
                        log('‚úÖ Contrase√±a correcta', 'success');
                        log(`‚úÖ LOGIN EXITOSO! Rol: ${user.rol.nombre}`, 'success');
                        updateStatus('‚úÖ Login exitoso', 'success');
                    } else {
                        log(`‚ùå Contrase√±a incorrecta`, 'error');
                        log(`   Esperada: '${password}'`, 'error');
                        log(`   En BD: '${user.password_hash}'`, 'error');
                    }
                }
            } catch (error) {
                log(`‚ùå Error general en login: ${error.message}`, 'error');
            }
        }

        // Ejecutar diagn√≥stico autom√°tico al cargar
        function initApp() {
            log('üöÄ Sistema de diagn√≥stico iniciado');
            
            // Informaci√≥n del sistema
            document.getElementById('systemInfo').innerHTML = `
                <div class="info status">
                    <strong>Navegador:</strong> ${navigator.userAgent}<br>
                    <strong>URL actual:</strong> ${window.location.href}<br>
                    <strong>Fecha/Hora:</strong> ${new Date().toLocaleString()}<br>
                    <strong>Supabase URL:</strong> ${SUPABASE_URL}<br>
                    <strong>Supabase disponible:</strong> ${typeof window.supabase !== 'undefined' ? 'S√ç' : 'NO'}
                </div>
            `;
            
            // Ejecutar pasos autom√°ticamente solo si Supabase est√° disponible
            if (typeof window.supabase !== 'undefined') {
                setTimeout(() => step1(), 1000);
                setTimeout(() => step2(), 2000);
                setTimeout(() => step3(), 4000);
                setTimeout(() => step4(), 6000);
            } else {
                log('‚ùå Supabase no est√° disponible, no se pueden ejecutar los pasos autom√°ticos', 'error');
                updateStatus('‚ùå Librer√≠a Supabase no disponible', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Esperar un momento para que las librer√≠as se carguen
            setTimeout(() => {
                if (typeof window.supabase !== 'undefined') {
                    initApp();
                } else {
                    // Intentar cargar una vez m√°s
                    log('‚ö†Ô∏è Intentando cargar Supabase nuevamente...', 'warning');
                    const script = document.createElement('script');
                    script.src = 'https://cdn.skypack.dev/@supabase/supabase-js@2';
                    script.onload = () => {
                        log('‚úÖ Supabase cargado desde Skypack', 'success');
                        initApp();
                    };
                    script.onerror = () => {
                        log('‚ùå Error cargando desde todas las fuentes', 'error');
                        updateStatus('‚ùå No se pudo cargar Supabase', 'error');
                    };
                    document.head.appendChild(script);
                }
            }, 1000);
        });
    </script>
</body>
</html>
