<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte de Salidas del Personal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .report-container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }

    .logo-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }

    .logo {
      height: 35px;
      width: auto;
    }

    .report-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }

    .report-subtitle {
      font-size: 16px;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .controls {
      padding: 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: flex-end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-group label {
      font-weight: 500;
      color: #495057;
      font-size: 14px;
    }

    .control-group input,
    .control-group select {
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
      min-width: 160px;
    }

    .control-group input:focus,
    .control-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-left: auto;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #2980b9, #2471a3);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #27ae60, #1e8449);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #c0392b, #a93226);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      padding: 30px;
      background: white;
      border-bottom: 1px solid #e9ecef;
    }

    .summary-card {
      padding: 20px;
      border-radius: 15px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .summary-card h3 {
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-card span {
      font-size: 28px;
      font-weight: 700;
      color: #1a5276;
    }

    .table-container {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    .table thead {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .table th,
    .table td {
      padding: 16px;
      font-size: 14px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
    }

    .table tbody tr {
      transition: all 0.3s ease;
    }

    .table tbody tr:hover {
      background: #f8f9fa;
      transform: scale(1.01);
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-en-curso {
      background: #fff3cd;
      color: #856404;
    }

    .status-regreso {
      background: #d4edda;
      color: #155724;
    }

    .status-sin-regreso {
      background: #f8d7da;
      color: #721c24;
    }

    .loading,
    .no-data,
    .restricted {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    .loading i,
    .no-data i,
    .restricted i {
      font-size: 32px;
      margin-bottom: 10px;
      display: block;
    }

    .restricted {
      background: rgba(231, 76, 60, 0.1);
      color: #c0392b;
      border-radius: 12px;
      margin: 30px;
    }

    .footer {
      padding: 20px 30px;
      background: #f8f9fa;
      text-align: center;
      color: #6c757d;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .button-group {
        margin-left: 0;
        justify-content: center;
      }

      .logo-container {
        flex-direction: column;
        gap: 10px;
      }

      .report-title {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="report-container" id="reportContainer">
    <div class="header">
      <div class="logo-container">
        <img alt="Logo Colegio Gemelli" class="logo" src="https://mbosvnmhnbrslfwlfcxu.supabase.co/storage/v1/object/sign/autorizaciones/fotos/Logo%20Slogan%20Nuevo%20FINAL-04.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8zZDJkZjRmNC01MjI1LTQxNGItYmYyNS0zMzZlYTg2YzAzNGEiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhdXRvcml6YWNpb25lcy9mb3Rvcy9Mb2dvIFNsb2dhbiBOdWV2byBGSU5BTC0wNC5wbmciLCJpYXQiOjE3NTAyOTE0NjksImV4cCI6MTc4MTgyNzQ2OX0.j8YNCebnNTncMgM_sZLQ2GSuWvDtiTIFbM5VSrm1Xcg" width="35" height="35"/>
      </div>
      <h1 class="report-title"><i class="fas fa-user-tie"></i> Reporte del Personal</h1>
      <p class="report-subtitle">Historial de salidas y regresos del personal autorizado</p>
    </div>

    <div id="accessDenied" class="restricted" style="display: none;">
      <i class="fas fa-lock"></i>
      <h2>Acceso restringido</h2>
      <p>Este reporte está disponible únicamente para Sistemas y Gestión Administrativa.</p>
    </div>

    <div id="reportContent" style="display: none;">
      <div class="controls">
        <div class="control-group">
          <label for="desdeReporte">Fecha Desde:</label>
          <input type="date" id="desdeReporte">
        </div>
        <div class="control-group">
          <label for="hastaReporte">Fecha Hasta:</label>
          <input type="date" id="hastaReporte">
        </div>
        <div class="control-group" style="flex: 1; min-width: 240px;">
          <label for="busquedaPersonal">Buscar colaborador:</label>
          <input type="text" id="busquedaPersonal" placeholder="Nombre, cédula o cargo">
        </div>
        <div class="control-group">
          <label for="estadoFiltro">Estado:</label>
          <select id="estadoFiltro">
            <option value="todos">Todos</option>
            <option value="en_curso">En curso</option>
            <option value="regresado">Regresado</option>
            <option value="sin_regreso">Sin regreso requerido</option>
          </select>
        </div>
        <div class="button-group">
          <button class="btn btn-primary" id="generarReporteBtn">
            <i class="fas fa-chart-bar"></i> Generar Reporte
          </button>
          <button class="btn btn-success" id="exportarCSVBtn">
            <i class="fas fa-file-csv"></i> Descargar CSV
          </button>
          <button class="btn btn-danger" id="exportarPDFBtn">
            <i class="fas fa-file-pdf"></i> Descargar PDF
          </button>
        </div>
      </div>

      <div class="summary">
        <div class="summary-card">
          <h3><i class="fas fa-people-arrows"></i> Salidas registradas</h3>
          <span id="totalSalidas">0</span>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-hourglass-half"></i> En curso</h3>
          <span id="salidasEnCurso">0</span>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-door-closed"></i> Regresos confirmados</h3>
          <span id="salidasRegresadas">0</span>
        </div>
      </div>

      <div class="table-container">
        <table class="table" id="tablaPersonal">
          <thead>
            <tr>
              <th>Colaborador</th>
              <th>Cargo</th>
              <th>Motivo</th>
              <th>Fecha Salida</th>
              <th>Hora Salida</th>
              <th>Salida Confirmada</th>
              <th>Regreso Estimado</th>
              <th>Regreso Efectivo</th>
              <th>Estado</th>
              <th>Autorizó</th>
              <th>Vigilante Salida</th>
              <th>Vigilante Regreso</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      <p>© 2025 Colegio Gemelli - Sistema de Control de Salidas</p>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(process.env.SUPABASE_URL, process.env.SUPABASE_ANON_KEY);
    const allowedUsers = [
      'sistemas@colgemelli.edu.co',
      'gadministrativa@colgemelli.edu.co'
    ];

    let registrosPersonal = [];
    let registrosFiltrados = [];

    function sanitizeHtml(str) {
      if (!str) return '';
      const temp = document.createElement('div');
      temp.textContent = str;
      let escaped = temp.innerHTML;
      escaped = escaped.replace(/javascript:/gi, '')
        .replace(/vbscript:/gi, '')
        .replace(/data:/gi, '')
        .replace(/on\w+=/gi, '')
        .replace(/<script[^>]*>.*?<\/script>/gi, '')
        .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '')
        .replace(/<object[^>]*>.*?<\/object>/gi, '')
        .replace(/<embed[^>]*>/gi, '')
        .replace(/<link[^>]*>/gi, '')
        .replace(/<meta[^>]*>/gi, '');
      return escaped;
    }

    function formatDate(dateString) {
      if (!dateString) return '---';
      try {
        const date = new Date(dateString + 'T00:00:00');
        if (Number.isNaN(date.getTime())) return sanitizeHtml(dateString);
        return date.toLocaleDateString('es-CO', { timeZone: 'America/Bogota' });
      } catch (error) {
        return sanitizeHtml(dateString);
      }
    }

    function formatTime(timeString) {
      if (!timeString) return '---';
      return sanitizeHtml(timeString.substring(0, 5));
    }

    function formatDateTime(dateTimeString) {
      if (!dateTimeString) return 'Pendiente';
      try {
        const date = new Date(dateTimeString);
        if (Number.isNaN(date.getTime())) return sanitizeHtml(dateTimeString);
        return date.toLocaleString('es-CO', {
          timeZone: 'America/Bogota',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        return sanitizeHtml(dateTimeString);
      }
    }

    function verificarAcceso() {
      const email = localStorage.getItem('correo');
      if (!email || !allowedUsers.includes(email)) {
        document.getElementById('accessDenied').style.display = 'block';
        document.getElementById('reportContent').style.display = 'none';
        return false;
      }

      document.getElementById('accessDenied').style.display = 'none';
      document.getElementById('reportContent').style.display = 'block';
      return true;
    }

    function actualizarResumen(datos) {
      const total = datos.length;
      const regresados = datos.filter(item => !!item.regreso_efectivo).length;
      const sinRegresoRequerido = datos.filter(item => item.requiere_regreso === false).length;
      const enCurso = total - regresados - sinRegresoRequerido;

      document.getElementById('totalSalidas').textContent = total;
      document.getElementById('salidasEnCurso').textContent = enCurso;
      document.getElementById('salidasRegresadas').textContent = regresados;
    }

    function renderTabla() {
      const tbody = document.querySelector('#tablaPersonal tbody');
      const busqueda = document.getElementById('busquedaPersonal').value.toLowerCase().trim();
      const estado = document.getElementById('estadoFiltro').value;

      registrosFiltrados = registrosPersonal.filter(item => {
        const persona = (item.colaborador?.nombre || '').toLowerCase();
        const cargo = (item.colaborador?.cargo || '').toLowerCase();
        const cedula = (item.colaborador?.cedula || '').toLowerCase();
        const texto = `${persona} ${cargo} ${cedula}`;
        const coincideBusqueda = !busqueda || texto.includes(busqueda);

        let coincideEstado = true;
        if (estado === 'en_curso') {
          coincideEstado = !item.regreso_efectivo && item.requiere_regreso !== false;
        } else if (estado === 'regresado') {
          coincideEstado = !!item.regreso_efectivo;
        } else if (estado === 'sin_regreso') {
          coincideEstado = item.requiere_regreso === false;
        }

        return coincideBusqueda && coincideEstado;
      });

      tbody.innerHTML = '';

      if (registrosFiltrados.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="12" class="no-data">
              <i class="fas fa-info-circle"></i>
              <div>No se encontraron registros con los filtros seleccionados.</div>
            </td>
          </tr>
        `;
        actualizarResumen(registrosPersonal);
        return;
      }

      registrosFiltrados.forEach(item => {
        const tr = document.createElement('tr');
        const estadoActual = item.requiere_regreso === false
          ? '<span class="status-badge status-sin-regreso">Sin regreso</span>'
          : item.regreso_efectivo
            ? '<span class="status-badge status-regreso">Regresado</span>'
            : '<span class="status-badge status-en-curso">En curso</span>';

        tr.innerHTML = `
          <td>${sanitizeHtml(item.colaborador?.nombre || 'No registrado')}</td>
          <td>${sanitizeHtml(item.colaborador?.cargo || '---')}</td>
          <td>${sanitizeHtml(item.motivo?.descripcion || '---')}</td>
          <td>${formatDate(item.fecha_salida)}</td>
          <td>${formatTime(item.hora_salida)}</td>
          <td>${formatDateTime(item.salida_efectiva)}</td>
          <td>${item.requiere_regreso === false ? 'No aplica' : formatTime(item.hora_regreso_estimada)}</td>
          <td>${item.requiere_regreso === false ? 'No aplica' : formatDateTime(item.regreso_efectivo)}</td>
          <td>${estadoActual}</td>
          <td>${sanitizeHtml(item.autorizador?.nombre || '---')}</td>
          <td>${sanitizeHtml(item.vigilanteSalida?.nombre || '---')}</td>
          <td>${sanitizeHtml(item.vigilanteRegreso?.nombre || '---')}</td>
        `;
        tbody.appendChild(tr);
      });

      actualizarResumen(registrosPersonal);
    }

    async function mostrarReportePersonal() {
      if (!verificarAcceso()) return;

      const tbody = document.querySelector('#tablaPersonal tbody');
      tbody.innerHTML = `
        <tr>
          <td colspan="12" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <div>Cargando información...</div>
          </td>
        </tr>
      `;

      try {
        const desde = document.getElementById('desdeReporte').value;
        const hasta = document.getElementById('hastaReporte').value;

        let consulta = supabase
          .from('autorizaciones_personal')
          .select('*')
          .order('fecha_salida', { ascending: false })
          .order('hora_salida', { ascending: false });

        if (desde) {
          consulta = consulta.gte('fecha_salida', desde);
        }
        if (hasta) {
          consulta = consulta.lte('fecha_salida', hasta);
        }

        const { data, error } = await consulta;
        if (error) throw error;

        if (!data || data.length === 0) {
          registrosPersonal = [];
          renderTabla();
          return;
        }

        const staffIds = new Set();
        const motivoIds = new Set();
        const usuarioIds = new Set();

        data.forEach(item => {
          if (item.colaborador_id) staffIds.add(item.colaborador_id);
          if (item.motivo_id) motivoIds.add(item.motivo_id);
          if (item.usuario_autorizador_id) usuarioIds.add(item.usuario_autorizador_id);
          if (item.vigilante_id) usuarioIds.add(item.vigilante_id);
          if (item.vigilante_regreso_id) usuarioIds.add(item.vigilante_regreso_id);
        });

        const [colaboradoresRes, motivosRes, usuariosRes] = await Promise.all([
          staffIds.size
            ? supabase.from('personal_colegio').select('id, nombre, cargo, cedula').in('id', Array.from(staffIds))
            : { data: [], error: null },
          motivoIds.size
            ? supabase.from('motivos').select('id, descripcion').in('id', Array.from(motivoIds))
            : { data: [], error: null },
          usuarioIds.size
            ? supabase.from('usuarios').select('id, nombre').in('id', Array.from(usuarioIds))
            : { data: [], error: null }
        ]);

        if (colaboradoresRes.error) throw colaboradoresRes.error;
        if (motivosRes.error) throw motivosRes.error;
        if (usuariosRes.error) throw usuariosRes.error;

        const colaboradoresMap = Object.fromEntries((colaboradoresRes.data || []).map(item => [item.id, item]));
        const motivosMap = Object.fromEntries((motivosRes.data || []).map(item => [item.id, item]));
        const usuariosMap = Object.fromEntries((usuariosRes.data || []).map(item => [item.id, item]));

        registrosPersonal = data.map(item => ({
          ...item,
          colaborador: colaboradoresMap[item.colaborador_id] || null,
          motivo: motivosMap[item.motivo_id] || null,
          autorizador: usuariosMap[item.usuario_autorizador_id] || null,
          vigilanteSalida: usuariosMap[item.vigilante_id] || null,
          vigilanteRegreso: usuariosMap[item.vigilante_regreso_id] || null
        }));

        renderTabla();
      } catch (error) {
        console.error('Error cargando el reporte del personal:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="12" class="no-data">
              <i class="fas fa-exclamation-triangle"></i>
              <div>Ocurrió un error al cargar la información.</div>
            </td>
          </tr>
        `;
      }
    }

    function exportarCSV() {
      if (!registrosFiltrados.length) return;
      const encabezados = [
        'Colaborador', 'Cargo', 'Motivo', 'Fecha salida', 'Hora salida',
        'Salida confirmada', 'Regreso estimado', 'Regreso efectivo',
        'Estado', 'Autorizó', 'Vigilante salida', 'Vigilante regreso'
      ];

      const filas = registrosFiltrados.map(item => {
        const estadoActual = item.requiere_regreso === false
          ? 'Sin regreso'
          : item.regreso_efectivo
            ? 'Regresado'
            : 'En curso';

        return [
          sanitizeHtml(item.colaborador?.nombre || 'No registrado'),
          sanitizeHtml(item.colaborador?.cargo || ''),
          sanitizeHtml(item.motivo?.descripcion || ''),
          formatDate(item.fecha_salida),
          formatTime(item.hora_salida),
          formatDateTime(item.salida_efectiva),
          item.requiere_regreso === false ? 'No aplica' : formatTime(item.hora_regreso_estimada),
          item.requiere_regreso === false ? 'No aplica' : formatDateTime(item.regreso_efectivo),
          estadoActual,
          sanitizeHtml(item.autorizador?.nombre || ''),
          sanitizeHtml(item.vigilanteSalida?.nombre || ''),
          sanitizeHtml(item.vigilanteRegreso?.nombre || '')
        ];
      });

      const csvContenido = [encabezados, ...filas]
        .map(fila => fila.map(celda => `"${celda.replace(/"/g, '""')}"`).join(','))
        .join('\n');

      const blob = new Blob([csvContenido], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const enlace = document.createElement('a');
      enlace.href = url;
      enlace.download = `reporte_personal_${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(enlace);
      enlace.click();
      document.body.removeChild(enlace);
    }

    function exportarPDF() {
      if (!registrosFiltrados.length) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'mm', 'a4');
      const primaryColor = [44, 62, 80];
      const accentColor = [52, 152, 219];

      doc.setFillColor(...primaryColor);
      doc.rect(0, 0, 297, 40, 'F');
      doc.setFillColor(255, 255, 255);
      doc.circle(25, 20, 8, 'F');
      doc.setTextColor(...accentColor);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('G', 22, 25);
      doc.setTextColor(255, 255, 255);
      doc.text('Reporte de Salidas del Personal', 40, 25);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Generado el: ${new Date().toLocaleDateString('es-CO')}`, 40, 33);

      const headers = [[
        'Colaborador', 'Cargo', 'Motivo', 'Fecha Salida', 'Hora Salida',
        'Salida Confirmada', 'Regreso Estimado', 'Regreso Efectivo',
        'Estado', 'Autorizó', 'Vigilante Salida', 'Vigilante Regreso'
      ]];

      const body = registrosFiltrados.map(item => {
        const estadoActual = item.requiere_regreso === false
          ? 'Sin regreso'
          : item.regreso_efectivo
            ? 'Regresado'
            : 'En curso';

        return [
          sanitizeHtml(item.colaborador?.nombre || 'No registrado'),
          sanitizeHtml(item.colaborador?.cargo || ''),
          sanitizeHtml(item.motivo?.descripcion || ''),
          formatDate(item.fecha_salida),
          formatTime(item.hora_salida),
          formatDateTime(item.salida_efectiva),
          item.requiere_regreso === false ? 'No aplica' : formatTime(item.hora_regreso_estimada),
          item.requiere_regreso === false ? 'No aplica' : formatDateTime(item.regreso_efectivo),
          estadoActual,
          sanitizeHtml(item.autorizador?.nombre || ''),
          sanitizeHtml(item.vigilanteSalida?.nombre || ''),
          sanitizeHtml(item.vigilanteRegreso?.nombre || '')
        ];
      });

      doc.autoTable({
        head: headers,
        body,
        startY: 50,
        theme: 'grid',
        styles: {
          fontSize: 8,
          cellPadding: 3,
          textColor: [44, 62, 80]
        },
        headStyles: {
          fillColor: accentColor,
          textColor: [255, 255, 255],
          fontSize: 9,
          halign: 'center'
        },
        alternateRowStyles: {
          fillColor: [245, 247, 250]
        }
      });

      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(`Página ${i} de ${totalPages}`, 15, 200);
        doc.text('Sistema de Control de Salidas - Colegio Gemelli', 15, 205);
      }

      doc.save(`reporte_personal_${new Date().toISOString().slice(0, 10)}.pdf`);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const hoy = new Date();
      const haceTreintaDias = new Date();
      haceTreintaDias.setDate(hoy.getDate() - 30);

      const desdeInput = document.getElementById('desdeReporte');
      const hastaInput = document.getElementById('hastaReporte');
      if (desdeInput && hastaInput) {
        desdeInput.value = haceTreintaDias.toISOString().slice(0, 10);
        hastaInput.value = hoy.toISOString().slice(0, 10);
      }

      document.getElementById('generarReporteBtn').addEventListener('click', mostrarReportePersonal);
      document.getElementById('exportarCSVBtn').addEventListener('click', exportarCSV);
      document.getElementById('exportarPDFBtn').addEventListener('click', exportarPDF);
      document.getElementById('busquedaPersonal').addEventListener('input', renderTabla);
      document.getElementById('estadoFiltro').addEventListener('change', renderTabla);

      if (verificarAcceso()) {
        mostrarReportePersonal();
      }
    });
  </script>
</body>
</html>
