<!-- archivo: reporte.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte Mensual de Salidas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>ðŸ“Š Reporte Mensual de Salidas</h1>
  <input type="month" id="mesReporte" />
  <button onclick="mostrarReporteMensual()">Generar</button>
  <div id="contenedor-reporte"></div>

  <script>
    const supabase = window.supabase.createClient(process.env.SUPABASE_URL, process.env.SUPABASE_ANON_KEY);

    async function mostrarReporteMensual() {
      const contenedor = document.getElementById('contenedor-reporte');
      contenedor.innerHTML = '<p>Cargando datos...</p>';

      const mes = document.getElementById('mesReporte').value;
      let consulta = supabase
        .from('autorizaciones_salida')
        .select('fecha_salida, estudiante_id, motivo_id, hora_salida, observaciones');

         if (mes) {
        consulta = consulta
          .gte('fecha_salida', `${mes}-01`)
          .lt('fecha_salida', obtenerSiguienteMes(mes));
      }

      const { data, error } = await consulta;

      if (error) {
        contenedor.innerHTML = '<p>Error al cargar datos.</p>';
        console.error(error);
        return;
      }

      const agrupado = {};
      data.forEach(item => {
       const key = item.fecha_salida.slice(0, 7);
        if (!agrupado[key]) agrupado[key] = [];
        agrupado[key].push(item);
      });

      contenedor.innerHTML = '';
      for (const clave in agrupado) {
        const grupo = agrupado[clave];
        const div = document.createElement('div');
        div.innerHTML = `<h2>Mes: ${clave} (${grupo.length} autorizaciones)</h2><ul style="padding-left:20px;"></ul>`;
        const ul = div.querySelector('ul');
        grupo.forEach(item => {
          const li = document.createElement('li');
          li.textContent = `Estudiante ID: ${item.estudiante_id} | Motivo: ${item.motivo_id} | Hora: ${item.hora_salida} | Obs: ${item.observaciones || 'Ninguna'}`;
          ul.appendChild(li);
        });

        contenedor.appendChild(div);
      }
    }

    function obtenerSiguienteMes(mes) {
      const [y, m] = mes.split('-').map(Number);
      const date = new Date(y, m - 1, 1);
      date.setMonth(date.getMonth() + 1);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2,'0')}-01`;
    }
  </script>
</body>
</html>
